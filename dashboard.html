
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="dashboard.css" />
    <link rel="stylesheet" href="upload-notes.css" />
    <link rel="stylesheet" href="notes-breakdown.css" />
    <link rel="stylesheet" href="ai-images.css" />
    <link rel="stylesheet" href="mcq-generator.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* CSS Variables for Dark Mode */
      :root {
        --bg-primary: #f2ece3;
        --bg-secondary: #ffffff;
        --bg-sidebar: #ffffff;
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-muted: #7b8fa1;
        --border-color: #e0e0e0;
        --border-light: #f0f0f0;
        --accent-color: #14807a;
        --accent-hover: #0f6b63;
        --shadow: rgba(0, 0, 0, 0.1);
        --input-bg: #ffffff;
        --input-readonly-bg: #f8f9fa;
        --btn-secondary-bg: #f8f9fa;
        --btn-secondary-hover: #e9ecef;
        --breadcrumb-separator: #ccc;
      }

      /* Dark Mode Variables */
      [data-theme="dark"] {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-sidebar: #2d2d2d;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --text-muted: #aaaaaa;
        --border-color: #404040;
        --border-light: #404040;
        --accent-color: #14807a;
        --accent-hover: #0f6b63;
        --shadow: rgba(0, 0, 0, 0.3);
        --input-bg: #3d3d3d;
        --input-readonly-bg: #2d2d2d;
        --btn-secondary-bg: #3d3d3d;
        --btn-secondary-hover: #454545;
        --breadcrumb-separator: #666666;
      }

      .prompt-file-input {
        display: none;
      }

      .prompt-attachments {
        padding: 0 16px;
        margin-bottom: 4px;
        min-height: 24px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .prompt-attachment {
        font-size: 0.85rem;
        color: #14807a;
        background: rgba(20, 128, 122, 0.1);
        padding: 2px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .prompt-attachment i {
        font-size: 0.8rem;
      }

      .prompt-attachment .remove-file {
        color: #666;
        cursor: pointer;
        padding: 2px;
        margin-left: 4px;
        transition: color 0.2s;
      }

      .prompt-attachment .remove-file:hover {
        color: #dc3545;
      }

      .prompt-input[data-has-files="true"] {
        color: #14807a;
        font-style: italic;
      }

      .nb-tab-content {
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .nb-tab-panel {
        display: none;
      }

      .nb-tab-panel.active {
        display: block;
      }

      .nb-action-btn {
        padding: 8px 16px;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nb-action-btn.active {
        background: #14807a;
        color: white;
        border-color: #14807a;
      }

      .nb-file-row,
      .nb-folder-row {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
      }

      .nb-file-row:hover,
      .nb-folder-row:hover {
        background-color: #f8fffe;
      }

      .nb-file-row:last-child,
      .nb-folder-row:last-child {
        border-bottom: none;
      }

      .nb-folder-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .nb-folder-actions .nb-file-action {
        padding: 6px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .nb-folder-actions .nb-file-action:hover {
        background: rgba(20, 128, 122, 0.1);
        color: #14807a;
      }

      .nb-folder-actions .nb-file-action[title="Delete folder"]:hover {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
      }

      .nb-file-info,
      .nb-folder-info {
        margin-left: 12px;
        flex-grow: 1;
      }

      .nb-file-name,
      .nb-folder-name {
        display: block;
        font-weight: 500;
      }

      .nb-file-date,
      .nb-folder-count {
        display: block;
        font-size: 0.85em;
        color: #666;
      }

      .nb-file-action {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: #666;
        transition: color 0.2s;
      }

      .nb-file-action:hover {
        color: #14807a;
      }

      .nb-file-action.active {
        color: #14807a;
      }

      /* File Item Styles */
      .nb-file-item {
        background: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .nb-file-item:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .nb-file-icon {
        font-size: 24px;
        color: #14807a;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(20, 128, 122, 0.1);
        border-radius: 8px;
      }

      .nb-file-details {
        flex-grow: 1;
      }

      .nb-file-name {
        font-weight: 500;
        display: block;
        margin-bottom: 4px;
      }

      .nb-file-meta {
        font-size: 0.85em;
        color: #666;
      }

      .nb-file-status {
        min-width: 140px;
      }

      .nb-progress {
        background: #f0f0f0;
        height: 6px;
        border-radius: 3px;
        margin-bottom: 8px;
      }

      .nb-progress-bar {
        background: #14807a;
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .nb-status-text {
        font-size: 0.85em;
        color: #666;
      }

      .nb-status-text.nb-success {
        color: #14807a;
      }

      .nb-status-text.nb-error {
        color: #dc3545;
      }

      .nb-file-actions {
        display: flex;
        gap: 8px;
      }

      .nb-action {
        background: none;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
      }

      .nb-action:hover {
        background: rgba(20, 128, 122, 0.1);
        color: #14807a;
      }

      .nb-action[title="Delete"]:hover {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
      }

      .nb-action[title="Stop"]:hover {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }

      .nb-item-complete {
        border-left: 4px solid #14807a;
      }

      /* Empty state styles */
      .nb-empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .nb-empty-state h4 {
        margin: 16px 0 8px 0;
        font-size: 1.1rem;
        font-weight: 500;
      }

      .nb-empty-state p {
        margin: 0;
        font-size: 0.9rem;
      }

      /* Processing animation */
      @keyframes processing {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }

      .nb-file-item:not(.nb-item-complete) .nb-status-text {
        animation: processing 1.5s infinite;
      }

      /* AI Result Modal Styles */
      .ai-result-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .ai-result-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
      }

      .ai-result-content {
        position: relative;
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .ai-result-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }

      .ai-result h3 {
        color: #14807a;
        margin-bottom: 16px;
        font-size: 1.5rem;
      }

      .ai-result p, .ai-result div {
        line-height: 1.6;
        color: #333;
      }

      .flashcard {
        background: #f8fffe;
        border-left: 4px solid #14807a;
        padding: 12px 16px;
        margin-bottom: 12px;
        border-radius: 6px;
      }

      .flashcard strong {
        color: #14807a;
      }

      /* Processing Options Styles */
      .processing-options {
        margin-top: 24px;
      }

      .processing-options h3 {
        color: #14807a;
        margin-bottom: 16px;
        font-size: 1.2rem;
      }

      /* Custom AI Results Popup Styles */
      .ai-results-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .ai-results-popup.show {
        opacity: 1;
        visibility: visible;
      }

      .ai-results-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
      }

      .ai-results-content {
        position: relative;
        background: var(--bg-secondary);
        border-radius: 16px;
        padding: 24px;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        width: 90%;
        margin: 20px;
      }

      .ai-results-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      }

      .ai-results-title {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .ai-results-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 4px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .ai-results-close:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
      }

      .ai-results-body {
        color: var(--text-primary);
        line-height: 1.6;
        font-size: 1rem;
        margin-bottom: 20px;
      }

      .ai-results-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }

      .ai-results-copy-btn {
        background: #14807a;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
      }

      .ai-results-copy-btn:hover {
        background: #0f6b63;
        transform: translateY(-1px);
      }

      .ai-results-copy-btn.copied {
        background: #28a745;
      }

      .ai-results-copy-btn.copied:hover {
        background: #218838;
      }

      .ai-results-close-btn {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
      }

      .ai-results-close-btn:hover {
        background: var(--bg-secondary);
        transform: translateY(-1px);
      }

      /* File Selector Popup Styles */
      .file-selector-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .file-selector-popup.show {
        opacity: 1;
        visibility: visible;
      }

      .file-selector-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
      }

      .file-selector-content {
        position: relative;
        background: var(--bg-secondary);
        border-radius: 16px;
        padding: 24px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        width: 90%;
        margin: 20px;
      }

      .file-selector-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      }

      .file-selector-title {
        color: var(--text-primary);
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
      }

      .file-selector-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 4px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .file-selector-close:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
      }

      .file-selector-body {
        margin-bottom: 20px;
      }

      .file-selector-instructions {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 16px;
        padding: 12px;
        background: var(--bg-primary);
        border-radius: 8px;
        border-left: 4px solid #14807a;
      }

      .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }

      .file-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-light);
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .file-item:last-child {
        border-bottom: none;
      }

      .file-item:hover {
        background: var(--bg-primary);
      }

      .file-item.selected {
        background: rgba(20, 128, 122, 0.1);
        border-left: 4px solid #14807a;
      }

      .file-checkbox {
        margin-right: 12px;
        width: 18px;
        height: 18px;
        accent-color: #14807a;
      }

      .file-info {
        flex-grow: 1;
      }

      .file-name {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 4px;
        display: block;
      }

      .file-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .file-selector-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }

      .file-selector-process-btn {
        background: #14807a;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
      }

      .file-selector-process-btn:hover {
        background: #0f6b63;
        transform: translateY(-1px);
      }

      .file-selector-process-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .file-selector-cancel-btn {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .file-selector-cancel-btn:hover {
        background: var(--bg-secondary);
      }

      /* Loading state for AI processing */
      .ai-processing-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 20px;
        color: var(--text-secondary);
      }

      .ai-processing-loading i {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      /* Dark mode support for popups */
      [data-theme="dark"] .ai-results-content,
      [data-theme="dark"] .file-selector-content {
        background: var(--bg-secondary);
        border-color: var(--border-color);
      }

      [data-theme="dark"] .ai-results-title,
      [data-theme="dark"] .file-selector-title {
        color: var(--text-primary);
      }

      [data-theme="dark"] .ai-results-body {
        color: var(--text-primary);
      }

      [data-theme="dark"] .file-name {
        color: var(--text-primary);
      }

      [data-theme="dark"] .file-meta {
        color: var(--text-secondary);
      }

      /* Custom Notification System */
      .custom-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        padding: 16px 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-left: 4px solid #14807a;
        z-index: 10000;
        max-width: 400px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .custom-notification.show {
        opacity: 1;
        transform: translateX(0);
      }

      .custom-notification.error {
        border-left-color: #dc3545;
        background: #fff5f5;
      }

      .custom-notification.success {
        border-left-color: #28a745;
        background: #f8fff8;
      }

      .custom-notification.warning {
        border-left-color: #ffc107;
        background: #fffbf0;
      }

      .custom-notification.info {
        border-left-color: #17a2b8;
        background: #f0f8ff;
      }

      .custom-notification-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .custom-notification-title {
        font-weight: 600;
        font-size: 14px;
        color: #333;
        margin: 0;
      }

      .custom-notification-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .custom-notification-message {
        font-size: 14px;
        color: #666;
        line-height: 1.4;
        margin: 0;
      }

      /* Upload File Button Styles */
      .upload-file-btn {
        background: #14807a;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        margin-left: 12px;
      }

      .upload-file-btn:hover {
        background: #0f6b63;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(20, 128, 122, 0.3);
      }

      .upload-file-btn:active {
        transform: translateY(0);
      }

      .upload-file-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .processing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }

      .process-btn {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        text-align: center;
        position: relative;
      }

      .process-btn:hover:not(.disabled) {
        border-color: #14807a;
        background: rgba(20, 128, 122, 0.05);
        transform: translateY(-2px);
      }

      .process-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .process-btn i {
        font-size: 24px;
        color: #14807a;
      }

      .process-btn span {
        font-weight: 500;
        color: #333;
      }

      .process-btn small {
        font-size: 0.8rem;
        color: #666;
        line-height: 1.2;
      }

      .process-btn .beta-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ffc107;
        color: #000;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: bold;
      }

      .sidebar-header-link {
        text-decoration: none;
        color: inherit;
      }

      /* NbFileManager specific styles */
      .nb-recent-files,
      .nb-favorites-list,
      .nb-library-content {
        max-height: 400px;
        overflow-y: auto;
      }

      .nb-recent-files:empty::before {
        content: "No recent files here";
        display: block;
        text-align: center;
        color: #666;
        padding: 20px;
        font-style: italic;
      }

      .nb-favorites-list:empty::before {
        content: "No favorites yet";
        display: block;
        text-align: center;
        color: #666;
        padding: 20px;
        font-style: italic;
      }

      .nb-library-content:empty::before {
        content: "No folders yet";
        display: block;
        text-align: center;
        color: #666;
        padding: 20px;
        font-style: italic;
      }

      .nb-action-btn:hover {
        background: rgba(20, 128, 122, 0.1);
      }

      .nb-action-btn.active {
        background: #14807a;
        color: white;
        border-color: #14807a;
      }

      /* AI Processing Button Active State */
      .nb-feature-card.processing {
        background: #14807a !important;
        color: white !important;
        border-color: #14807a !important;
        box-shadow: 0 4px 12px rgba(20, 128, 122, 0.3);
        transform: translateY(-2px);
        position: relative;
      }

      .nb-feature-card.processing::after {
        content: '';
        position: absolute;
        top: 50%;
        right: 12px;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .nb-feature-card.processing .nb-feature-icon i {
        color: white !important;
      }

      .nb-feature-card.processing h4,
      .nb-feature-card.processing p,
      .nb-feature-card.processing small {
        color: white !important;
      }

      @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
      }

      /* Hide file input elements */
      .nb-file-input {
        display: none !important;
      }

      /* Upload Success Popup Styles */
      .upload-success-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .upload-success-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }

      .upload-success-content {
        position: relative;
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease-out;
      }

      .upload-success-icon {
        font-size: 48px;
        color: #28a745;
        margin-bottom: 16px;
      }

      .upload-success-content h3 {
        color: #14807a;
        margin: 0 0 8px 0;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .upload-success-content p {
        color: #666;
        margin: 0 0 24px 0;
        font-size: 1rem;
      }

      .upload-success-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .upload-success-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .upload-success-btn.primary {
        background: #14807a;
        color: white;
      }

      .upload-success-btn.primary:hover {
        background: #0f6b63;
        transform: translateY(-1px);
      }

      .upload-success-btn.secondary {
        background: #f8f9fa;
        color: #666;
        border: 1px solid #e0e0e0;
      }

      .upload-success-btn.secondary:hover {
        background: #e9ecef;
      }

      /* Upload Success Analysis Styles */
      .upload-success-analysis {
        margin: 20px 0;
        padding: 16px;
        background: var(--bg-primary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      /* Drag and Drop Styles */
      .nb-upload-box {
        transition: all 0.3s ease;
      }

      .nb-upload-box.drag-over {
        background: rgba(20, 128, 122, 0.05);
        border-color: #14807a;
        border-style: dashed;
        transform: scale(1.02);
      }

      .nb-upload-box.drag-over .nb-upload-icon {
        color: #14807a;
        transform: scale(1.1);
      }

      .nb-upload-box.drag-over h3 {
        color: #14807a;
      }

      /* File validation error styles */
      .file-validation-error {
        background: #fff5f5;
        border: 1px solid #dc3545;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        color: #dc3545;
        font-size: 0.9rem;
      }

      .file-validation-error i {
        margin-right: 8px;
      }

      /* Enhanced upload box styles */
      .nb-upload-box {
        position: relative;
        overflow: hidden;
      }

      .nb-upload-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 49%, rgba(20, 128, 122, 0.1) 50%, transparent 51%);
        background-size: 20px 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .nb-upload-box.drag-over::before {
        opacity: 1;
      }

      .upload-success-analysis h4 {
        color: var(--text-primary);
        margin: 0 0 16px 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .upload-success-analysis strong {
        color: var(--text-primary);
        font-weight: 600;
      }

      .upload-success-analysis p {
        color: var(--text-secondary);
        margin: 8px 0;
        line-height: 1.5;
      }

      .upload-success-analysis ul {
        color: var(--text-secondary);
        margin: 8px 0;
        padding-left: 20px;
      }

      .upload-success-analysis li {
        margin-bottom: 4px;
        line-height: 1.4;
      }

      /* Dark mode support for upload success popup */
      [data-theme="dark"] .upload-success-content {
        background: var(--bg-secondary);
        border-color: var(--border-color);
      }

      [data-theme="dark"] .upload-success-analysis {
        background: var(--bg-secondary);
        border-color: var(--border-color);
      }

      /* Responsive design for nb-quick-actions */
      @media (max-width: 768px) {
        .nb-quick-actions {
          flex-direction: column;
          gap: 8px;
        }

        .nb-action-btn {
          width: 100%;
          justify-content: center;
        }

        .nb-file-row,
        .nb-folder-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .nb-file-info,
        .nb-folder-info {
          margin-left: 0;
          width: 100%;
        }

        .upload-success-content {
          max-width: 90%;
          margin: 20px;
        }

        .upload-success-analysis {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body style="background-color: var(--bg-primary); min-height: 100vh;">
    <script>
      const API_BASE_URL = "http://localhost:4000";
      let AUTH_TOKEN = localStorage.getItem("authToken");

      // Redirect to login page if no token
      if (!AUTH_TOKEN) {
        console.log('No auth token found, redirecting to login');
        window.location.href = "signin.html";
      } else {
        console.log('Auth token found:', AUTH_TOKEN.substring(0, 20) + '...');
      }

      // Consolidated Helper function for authenticated API fetch
      async function apiFetch(path, options = {}) {
        // Check if token exists
        const token = AUTH_TOKEN || localStorage.getItem("authToken");
        if (!token) {
          console.error('No auth token found, redirecting to login');
          localStorage.removeItem("authToken");
          window.location.href = "signin.html";
          throw new Error("Authentication required");
        }

        options.headers = {
          ...options.headers,
          Authorization: `Bearer ${token}`,
        };

        const res = await fetch(API_BASE_URL + path, options);

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));

          // Handle authentication errors
          if (res.status === 401) {
            console.error('Authentication failed:', errorData);
            localStorage.removeItem("authToken");
            showNotification('Session expired. Please log in again.', 'warning');
            setTimeout(() => {
              window.location.href = "signin.html";
            }, 2000);
            throw new Error("Authentication expired");
          }

          throw new Error(errorData.error || `HTTP ${res.status}: ${res.statusText}`);
        }

        return res.json();
      }

      // Debug function for authentication troubleshooting
      window.debugAuth = function() {
        console.log('=== AUTH DEBUG INFO ===');
        console.log('AUTH_TOKEN exists:', !!AUTH_TOKEN);
        console.log('AUTH_TOKEN preview:', AUTH_TOKEN ? AUTH_TOKEN.substring(0, 50) + '...' : 'null');
        console.log('API_BASE_URL:', API_BASE_URL);
        console.log('Current location:', window.location.href);
        console.log('localStorage authToken:', localStorage.getItem('authToken') ? 'present' : 'missing');
        return {
          hasToken: !!AUTH_TOKEN,
          tokenLength: AUTH_TOKEN ? AUTH_TOKEN.length : 0,
          apiUrl: API_BASE_URL
        };
      };

      // Test authentication function
      window.testAuth = async function() {
        try {
          console.log('Testing authentication...');
          const result = await apiFetch('/auth/me');
          console.log('✅ Authentication successful:', result);
          showNotification('Authentication test passed!', 'success');
          return result;
        } catch (error) {
          console.error('❌ Authentication failed:', error);
          showNotification('Authentication test failed. Please log in again.', 'error');
          return null;
        }
      };

      // Attach logout handler
      document.addEventListener("DOMContentLoaded", () => {
        const logoutLink = document.querySelector(
          '.dropdown-content a[href="#logout"]'
        );
        if (logoutLink) {
          logoutLink.addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.removeItem("authToken");
            window.location.href = "signin.html";
          });
        }

        // Initialize dark mode
        initializeDarkMode();

        // Update authentication status
        function updateAuthStatus(status, message = '') {
          const authStatus = document.getElementById('authStatus');
          if (!authStatus) return;

          const icon = authStatus.querySelector('i');
          const textSpan = authStatus.querySelector('span');

          if (status === 'authenticated') {
            icon.style.color = '#28a745';
            if (textSpan) textSpan.textContent = 'Authenticated';
          } else if (status === 'expired') {
            icon.style.color = '#ffc107';
            if (textSpan) textSpan.textContent = 'Session Expired';
          } else if (status === 'error') {
            icon.style.color = '#dc3545';
            if (textSpan) textSpan.textContent = 'Auth Error';
          } else if (status === 'loading') {
            icon.style.color = '#ffc107';
            if (textSpan) textSpan.textContent = message || 'Checking...';
          }
        }

        // Fetch and display user name
        (async () => {
          try {
            updateAuthStatus('loading', 'Checking...');
            const response = await apiFetch("/auth/me");
            const userName = response.user.name || response.user.email.split('@')[0];
            const plan = response.user.plan || 'free';
            const accountType = response.user.account_type || 'student';
            const accountTypeDisplay = accountType.charAt(0).toUpperCase() + accountType.slice(1);

            document.getElementById("user-welcome").innerHTML = `Welcome, ${userName}<br><small style="color: var(--text-secondary); font-size: 0.8em;">${plan.charAt(0).toUpperCase() + plan.slice(1)} Plan • ${accountTypeDisplay} Account</small>`;
            updateAuthStatus('authenticated');
          } catch (err) {
            console.error("Failed to fetch user:", err);
            updateAuthStatus('error');

            let errorMessage = "Failed to load user information. Using default settings.";
            if (err.message.includes('fetch') || err.message.includes('network')) {
              errorMessage = "Network connection issue. Please check your internet connection.";
            } else if (err.message.includes('No authentication token') || err.message.includes('Authentication expired')) {
              errorMessage = "Session expired. Please refresh the page and log in again.";
              updateAuthStatus('expired');
              setTimeout(() => {
                localStorage.removeItem("authToken");
                window.location.href = "signin.html";
              }, 3000);
            }

            handleError(new Error(errorMessage), 'User Info Fetch');

            document.getElementById("user-welcome").innerHTML = `Welcome<br><small style="color: var(--text-secondary); font-size: 0.8em;">Free Plan • Student Account</small>`;
          }
        })();
      });

      // Enhanced Dark Mode Functionality
      function initializeDarkMode() {
        const body = document.body;
        const toggleBtn = document.getElementById('darkModeToggle');

        // Load saved preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
          body.setAttribute('data-theme', 'dark');
        }

        // Update toggle button state
        updateToggleButton();

        // Add event listener to main toggle button
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleDarkMode);
        }

        // Add dark mode toggle to profile dropdown as backup
        const profileDropdown = document.querySelector('.dropdown-content');
        if (profileDropdown) {
          const darkModeToggle = document.createElement('a');
          darkModeToggle.href = '#';
          darkModeToggle.innerHTML = '<i class="fa-solid fa-moon"></i> Toggle Dark Mode';
          darkModeToggle.style.cssText = 'display: block; padding: 8px 16px; color: inherit; text-decoration: none;';
          darkModeToggle.addEventListener('click', (e) => {
            e.preventDefault();
            toggleDarkMode();
          });
          profileDropdown.appendChild(darkModeToggle);
        }
      }

      function toggleDarkMode() {
        const body = document.body;
        const isDark = body.hasAttribute('data-theme');

        if (isDark) {
          body.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
        } else {
          body.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
        }

        updateToggleButton();
      }

      function updateToggleButton() {
        const body = document.body;
        const toggleBtn = document.getElementById('darkModeToggle');

        if (toggleBtn) {
          const isDark = body.hasAttribute('data-theme');
          toggleBtn.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
        }
      }

      // Integrate Notes AI processing
      async function generateNotesAI(text) {
        try {
          const response = await apiFetch("/ai/summarize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });

          // Save to recent files
          if (window.nbFileManager) {
            window.nbFileManager.addRecentFile({
              name: `Notes Summary - ${new Date().toLocaleDateString()}`,
              type: 'notes',
              content: response.summary,
              source: 'ai-summary'
            });
          }

          return response.summary;
        } catch (err) {
          console.error("Notes AI generation failed", err);
          throw err;
        }
      }

      // Integrate MCQ AI processing
      async function generateMCQsAI(text, count = 10, difficulty = "intermediate") {
        try {
          const response = await apiFetch("/mcq", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              source_text: text,
              question_count: count,
              difficulty,
            }),
          });

          const mcqs = response.generated_mcqs || [];

          // Save to recent files
          if (window.nbFileManager && mcqs.length > 0) {
            window.nbFileManager.addRecentFile({
              name: `MCQ Set - ${new Date().toLocaleDateString()}`,
              type: 'mcq',
              content: JSON.stringify(mcqs),
              source: 'ai-mcq'
            });
          }

          return mcqs;
        } catch (err) {
          console.error("MCQ AI generation failed", err);
          throw err;
        }
      }

      // Example usage inside your dashboard workspace:
      // Add event listeners for buttons or form submissions where you want
      // to trigger these AI services and update the UI accordingly.

      // (You can expand your existing code where Notes Breakdown and MCQ Generator UI are present to call these functions.)
    </script>
    <div class="dashboard-wrapper">
      <aside class="sidebar">
        <a href="index.html" class="sidebar-header-link">
          <div class="sidebar-header">
            <span class="sidebar-logo"><img src="Cleverly AI.png" alt="Cleverly.ai" width="40" /></span>
            <span class="sidebar-title">Cleverly.ai</span>
          </div>
        </a>
        <nav class="sidebar-nav">
          <ul>
            <li>
              <button class="home-btn">
                <i class="fa-solid fa-house"></i> Home
              </button>
            </li>
            <li class="nav-section">
              Core Features
              <ul>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-file-lines"></i> Notes Breakdown</a
                  >
                </li>
                <li>
                  <a href="#"><i class="fa-solid fa-palette"></i> AI Images</a>
                </li>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-bullseye"></i> MCQ Generator</a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-section">
              Resources
              <ul>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-book"></i> My Dictionary
                    <span class="beta-badge">Beta</span></a
                  >
                </li>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-question"></i> My Questions
                    <span class="beta-badge">Beta</span></a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-section">
              Uploads & Media
              <ul>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-folder-open"></i> Upload Notes</a
                  >
                </li>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-image"></i> Presentations
                    <span class="beta-badge">Beta</span></a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-section">
              Tasks & Events
              <ul>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-pen"></i> Assignments
                    <span class="beta-badge">Beta</span></a
                  >
                </li>
                <li>
                  <a href="#"
                    ><i class="fa-solid fa-microphone"></i> Seminars
                    <span class="beta-badge">Beta</span></a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </nav>
      </aside>
      <main class="main-content">
        <header class="topbar">
          <div id="user-welcome" style="font-weight: 500; color: var(--text-primary);">Loading...</div>
          <div style="display: flex; align-items: center; margin-left: auto;">
            <!-- Authentication Status Indicator -->
            <div id="authStatus" class="auth-status" style="margin-right: 12px; font-size: 0.8rem; color: var(--text-secondary);">
              <i class="fa-solid fa-circle" style="color: #ffc107; margin-right: 4px;"></i>
              <span>Checking...</span>
            </div>

            <button class="dark-mode-toggle" id="darkModeToggle" aria-label="Toggle dark mode">
              <i class="fa-solid fa-sun sun-icon"></i>
              <i class="fa-solid fa-moon moon-icon"></i>
            </button>
            <div class="profile-dropdown">
              <button class="profile-btn">
                <i class="fa-solid fa-user"></i>
              </button>
              <div class="dropdown-content">
                <a href="settings.html">Settings</a>
                <a href="#logout">Logout</a>
              </div>
            </div>
          </div>
        </header>
        <section class="workspace">
          <div class="announcement">
            <span class="announcement-badge">Now live</span>
            Cleverly.ai, built for academics and business.
          </div>
          <h1 class="dashboard-title">Meet Cleverly</h1>
          <p class="dashboard-desc">
            An Premium intelligent hub for students, teams, and professionals.
          </p>
          <div class="dashboard-features">
            <h2>Why Cleverly.ai?</h2>
            <div class="features-list">
              <div class="feature-item">
                <i class="fa-solid fa-pen"></i> <b>Smarter Learning, Faster</b
                ><br />Turn paragraphs, notes, and PDFs into clear key points,
                summaries, and MCQs in seconds — no more wasting hours on manual
                prep.
              </div>
              <div class="feature-item">
                <i class="fa-solid fa-layer-group"></i>
                <b>All-in-One Workspace</b><br />Break down notes, generate
                assignments, create presentations, and prepare seminars —
                everything organized in one simple dashboard.
              </div>
              <div class="feature-item">
                <i class="fa-solid fa-database"></i>
                <b>AI-Powered Productivity</b><br />Generate diagrams,
                flowcharts, and infographics for academic or business use.
                Cleverly saves you time while keeping your work professional.
              </div>
              <div class="feature-item">
                <i class="fa-solid fa-robot"></i>
                <b>Study & Work Without Limits</b><br />From students to
                businesses to institutions — Cleverly grows with you. Upload
                files, practice with quizzes, and export work in PDF, DOCX, or
                PPTX effortlessly.
              </div>
            </div>
          </div>
          <div class="prompt-area">
            <button class="prompt-menu-btn">
              <i class="fa-solid fa-plus"></i>
            </button>
            <div class="prompt-menu-dropup">
              <input
                type="file"
                id="prompt-file-input"
                class="prompt-file-input"
                hidden
                multiple
              />
              <button
                class="prompt-menu-item"
                onclick="document.getElementById('prompt-file-input').click();"
              >
                <i class="fa-solid fa-paperclip"></i> Attach
              </button>
            </div>
            <div class="prompt-attachments"></div>
            <input
              type="text"
              class="prompt-input"
              placeholder="Ask me anything..."
            />
            <div class="prompt-actions">
              <div class="custom-dropdown" tabindex="0">
                <div class="custom-dropdown-selected">Select Source</div>
                <ul class="custom-dropdown-list">
                  <li data-value="Select Source" class="active">
                    Select Source
                  </li>
                  <li data-value="Notes">Notes</li>
                  <li data-value="Dictionary">Dictionary</li>
                  <li data-value="Questions">Questions</li>
                </ul>
              </div>
              <button class="prompt-btn">
                <i class="fa-solid fa-microphone"></i>
              </button>
              <button class="prompt-send">
                <i class="fa-solid fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Custom AI Results Popup -->
    <div id="aiResultsPopup" class="ai-results-popup">
      <div class="ai-results-overlay" onclick="closeAIResultsPopup()"></div>
      <div class="ai-results-content">
        <div class="ai-results-header">
          <h2 id="aiResultsTitle" class="ai-results-title">AI Processing Results</h2>
          <button class="ai-results-close" onclick="closeAIResultsPopup()">&times;</button>
        </div>
        <div id="aiResultsBody" class="ai-results-body">
          <!-- AI results will be displayed here -->
        </div>
        <div id="aiResultsActions" class="ai-results-actions">
          <button id="copyResultsBtn" class="ai-results-copy-btn" onclick="copyAIResults()">
            <i class="fa-solid fa-copy"></i>
            Copy Results
          </button>
          <button class="ai-results-close-btn" onclick="closeAIResultsPopup()">
            <i class="fa-solid fa-times"></i>
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- File Selector Popup -->
    <div id="fileSelectorPopup" class="file-selector-popup">
      <div class="file-selector-overlay" onclick="closeFileSelectorPopup()"></div>
      <div class="file-selector-content">
        <div class="file-selector-header">
          <h2 id="fileSelectorTitle" class="file-selector-title">Select Files for AI Processing</h2>
          <button class="file-selector-close" onclick="closeFileSelectorPopup()">&times;</button>
        </div>
        <div class="file-selector-body">
          <div class="file-selector-instructions">
            <strong>Select the files you want to process with AI:</strong><br>
            Choose one or more uploaded files to generate AI content from their content.
          </div>
          <div id="fileList" class="file-list">
            <!-- File list will be populated dynamically -->
            <div class="ai-processing-loading">
              <i class="fa-solid fa-spinner"></i>
              <span>Loading uploaded files...</span>
            </div>
          </div>
        </div>
        <div class="file-selector-actions">
          <button class="file-selector-cancel-btn" onclick="closeFileSelectorPopup()">Cancel</button>
          <button id="processSelectedFilesBtn" class="file-selector-process-btn" onclick="processSelectedFiles()" disabled>
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            Process Selected Files
          </button>
        </div>
      </div>
    </div>
  </body>
  <script>
    // Utility functions for file handling
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(fileType) {
      const type = fileType.toLowerCase();
      if (type.includes('pdf')) return 'file-pdf';
      if (type.includes('word') || type.includes('document')) return 'file-word';
      if (type.includes('text')) return 'file-alt';
      if (type.includes('image')) return 'file-image';
      if (type.includes('video')) return 'file-video';
      if (type.includes('audio')) return 'file-audio';
      if (type.includes('zip') || type.includes('rar')) return 'file-archive';
      return 'file';
    }

    function getFileTypeFromName(fileName) {
      if (!fileName) return 'Unknown';
      const extension = fileName.split('.').pop().toLowerCase();
      const typeMap = {
        'pdf': 'PDF',
        'doc': 'Word Document',
        'docx': 'Word Document',
        'txt': 'Text File',
        'rtf': 'Rich Text',
        'html': 'HTML',
        'htm': 'HTML',
        'css': 'CSS',
        'js': 'JavaScript',
        'json': 'JSON',
        'xml': 'XML',
        'jpg': 'JPEG Image',
        'jpeg': 'JPEG Image',
        'png': 'PNG Image',
        'gif': 'GIF Image',
        'bmp': 'Bitmap Image',
        'svg': 'SVG Image',
        'mp4': 'MP4 Video',
        'avi': 'AVI Video',
        'mov': 'QuickTime Video',
        'mp3': 'MP3 Audio',
        'wav': 'WAV Audio',
        'zip': 'ZIP Archive',
        'rar': 'RAR Archive',
        '7z': '7-Zip Archive'
      };
      return typeMap[extension] || extension.toUpperCase() + ' File';
    }

    // Custom Notification System
    function showNotification(message, type = 'info', duration = 5000) {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.custom-notification');
      existingNotifications.forEach(notification => notification.remove());

      // Create notification element
      const notification = document.createElement('div');
      notification.className = `custom-notification ${type}`;

      notification.innerHTML = `
        <div class="custom-notification-header">
          <h4 class="custom-notification-title">${type.charAt(0).toUpperCase() + type.slice(1)}</h4>
          <button class="custom-notification-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
        <p class="custom-notification-message">${message}</p>
      `;

      // Add to page
      document.body.appendChild(notification);

      // Show notification
      setTimeout(() => notification.classList.add('show'), 10);

      // Auto-hide after duration
      if (duration > 0) {
        setTimeout(() => {
          if (notification.parentElement) {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
          }
        }, duration);
      }

      return notification;
    }


    // View uploaded file function
    function viewUploadedFile(fileName) {
      // Navigate to Notes Breakdown section
      const sidebarLinks = document.querySelectorAll('.sidebar-nav ul li ul li a');
      sidebarLinks.forEach(link => {
        if (link.textContent.trim().replace('Beta', '').trim() === 'Notes Breakdown') {
          link.click();
        }
      });
    }

    // File validation function
    function validateFile(file) {
      const maxSize = 50 * 1024 * 1024; // 50MB in bytes
      const supportedTypes = {
        // Documents
        'pdf': ['application/pdf'],
        'doc': ['application/msword'],
        'docx': ['application/vnd.openxmlformats-officedocument.wordprocessingml.document'],
        'txt': ['text/plain'],
        'rtf': ['application/rtf', 'text/rtf'],

        // Presentations
        'ppt': ['application/vnd.ms-powerpoint'],
        'pptx': ['application/vnd.openxmlformats-officedocument.presentationml.presentation'],

        // Spreadsheets
        'xls': ['application/vnd.ms-excel'],
        'xlsx': ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],

        // Images
        'jpg': ['image/jpeg'],
        'jpeg': ['image/jpeg'],
        'png': ['image/png'],
        'gif': ['image/gif'],
        'bmp': ['image/bmp'],
        'svg': ['image/svg+xml'],
        'webp': ['image/webp']
      };

      // Check file size
      if (file.size > maxSize) {
        return {
          valid: false,
          error: `File is too large (${formatFileSize(file.size)}). Maximum allowed size is 50MB.`,
          type: 'size'
        };
      }

      // Check file type
      const fileExtension = file.name.split('.').pop().toLowerCase();
      const fileMimeType = file.type.toLowerCase();

      // Check if extension is supported
      if (!supportedTypes[fileExtension]) {
        return {
          valid: false,
          error: `"${fileExtension.toUpperCase()}" files are not supported. Please use: PDF, Word (.docx), Text (.txt), PowerPoint (.pptx), Excel (.xlsx), or image files (JPG, PNG, GIF, BMP, SVG, WebP).`,
          type: 'unsupported'
        };
      }

      // Check if MIME type matches expected types for the extension
      const expectedMimeTypes = supportedTypes[fileExtension];
      const mimeTypeMatches = expectedMimeTypes.some(expectedType =>
        fileMimeType.includes(expectedType.split('/')[1]) ||
        expectedType.includes(fileMimeType.split('/')[1])
      );

      if (!mimeTypeMatches && fileMimeType !== '') {
        console.warn(`MIME type mismatch for ${file.name}: expected ${expectedMimeTypes.join(', ')}, got ${fileMimeType}`);
        // Don't block upload for MIME type mismatches, just warn
      }

      // Check for empty files
      if (file.size === 0) {
        return {
          valid: false,
          error: 'File appears to be empty. Please select a valid file.',
          type: 'empty'
        };
      }

      return { valid: true };
    }

    // Drag and Drop Handlers with Validation
    function initializeDragAndDrop() {
      const uploadBox = document.querySelector('.nb-upload-box');
      const fileInput = document.getElementById('nb-file');

      if (!uploadBox || !fileInput) return;

      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadBox.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      // Highlight drop zone when item is dragged over it
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadBox.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadBox.addEventListener(eventName, unhighlight, false);
      });

      // Handle drop
      uploadBox.addEventListener('drop', handleDrop, false);

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      function highlight() {
        uploadBox.classList.add('drag-over');
      }

      function unhighlight() {
        uploadBox.classList.remove('drag-over');
      }

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 1) {
          showNotification('Please upload only one file at a time.', 'warning');
          return;
        }

        const file = files[0];
        if (file) {
          // Validate the dropped file
          const validation = validateFile(file);
          if (!validation.valid) {
            showNotification(validation.error, validation.type === 'size' ? 'warning' : 'error');
            return;
          }

          // Set the file to the input and trigger upload
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;

          // Update UI to show selected file
          updateFileDisplay([file]);

          // Auto-upload the file
          handleDirectUpload();
        }
      }
    }

    // Update file display function
    function updateFileDisplay(files) {
      const uploadContent = document.querySelector('.nb-upload-content');
      const uploadFooter = document.querySelector('.nb-upload-footer');

      if (!uploadContent || !uploadFooter) return;

      if (files && files.length > 0) {
        const file = files[0];
        uploadContent.innerHTML = `
          <i class="fa-solid fa-file-${getFileIcon(getFileTypeFromName(file.name))}" style="font-size: 48px; color: #14807a; margin-bottom: 16px;"></i>
          <h3 style="color: #14807a; margin-bottom: 8px;">${file.name}</h3>
          <p style="color: #666; margin: 0;">${formatFileSize(file.size)} • Ready to upload</p>
        `;

        // Update footer to show upload options
        const uploadBtn = uploadFooter.querySelector('.upload-file-btn');
        if (uploadBtn) {
          uploadBtn.style.display = 'inline-block';
        }
      } else {
        // Reset to default state
        uploadContent.innerHTML = `
          <i class="fa-solid fa-cloud-arrow-up nb-upload-icon"></i>
          <h3>Drag & Drop Files Here</h3>
          <p class="nb-upload-text">or click to browse</p>
        `;

        const uploadBtn = uploadFooter.querySelector('.upload-file-btn');
        if (uploadBtn) {
          uploadBtn.style.display = 'none';
        }
      }
    }

    // Initialize drag and drop when DOM is loaded
    document.addEventListener("DOMContentLoaded", function () {
      initializeDragAndDrop();

      // Add file input change handler for validation
      const fileInput = document.getElementById('nb-file');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          const files = e.target.files;
          if (files.length > 0) {
            const file = files[0];

            // Validate the selected file
            const validation = validateFile(file);
            if (!validation.valid) {
              showNotification(validation.error, validation.type === 'size' ? 'warning' : 'error');
              // Clear the input
              fileInput.value = '';
              updateFileDisplay([]);
              return;
            }

            // Update UI to show selected file
            updateFileDisplay([file]);
          } else {
            updateFileDisplay([]);
          }
        });
      }
    });

    // Direct Upload Handler
    async function handleDirectUpload() {
      const fileInput = document.getElementById('nb-file');
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        showNotification('Please select a file first using "Drag & Drop Files or Choose Files" button', 'warning');
        return;
      }

      const file = fileInput.files[0];
      const uploadBtn = document.querySelector('.upload-file-btn');

      // Validate file before upload
      const validation = validateFile(file);
      if (!validation.valid) {
        showNotification(validation.error, validation.type === 'size' ? 'warning' : 'error');
        return;
      }

      try {
        // Disable button during upload
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';

        // Show upload progress notification
        showNotification('Starting file upload...', 'info', 0);

        // Create FormData for file upload with enhanced metadata
        const formData = new FormData();
        formData.append('file', file);
        formData.append('title', file.name);
        formData.append('file_name', file.name);
        formData.append('file_type', getFileTypeFromName(file.name));
        formData.append('file_size', file.size.toString());

        // Upload file directly to database
        const response = await fetch(API_BASE_URL + '/upload/notes', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${AUTH_TOKEN}`,
          },
          body: formData
        });

        if (!response.ok) {
          if (response.status === 401) {
            // Token invalid or expired, redirect to login
            localStorage.removeItem("authToken");
            window.location.href = "signin.html";
            return;
          }

          const errorData = await response.json().catch(() => ({}));

          // Handle specific HTTP status codes
          if (response.status === 413) {
            throw new Error('File is too large. Please choose a smaller file (maximum 50MB).');
          } else if (response.status === 415) {
            throw new Error('File type not supported. Please use PDF, Word, Text, PowerPoint, Excel, or image files.');
          } else if (response.status === 429) {
            throw new Error('Too many uploads. Please wait a moment and try again.');
          } else if (response.status >= 500) {
            throw new Error('Server error. Please try again later.');
          }

          throw new Error(errorData.error || `Upload failed (${response.status})`);
        }

        const result = await response.json();
        console.log('Upload successful, result:', result);

        // Safely extract data from response
        const uploadNote = result?.uploadNote || result || {};

        if (!uploadNote || !uploadNote.id) {
          console.error('Invalid upload response:', result);
          showNotification('Upload completed but response is invalid. Please refresh the page.', 'warning');
          return;
        }

        const fileId = uploadNote.id;

        // Show success notification with AI analysis info
        const analysisStatus = result.aiAnalysis?.analysis_complete ? 'with AI analysis' : 'upload successful';
        showNotification(`File uploaded successfully ${analysisStatus}!`, 'success');

        // Show success popup with AI analysis results
        showUploadSuccessPopup(file.name, result.aiAnalysis);

        // Update global file state with AI analysis
        const uploadedFileInfo = {
          id: fileId,
          name: uploadNote.file_name || file.name,
          type: uploadNote.file_type || getFileTypeFromName(file.name),
          size: uploadNote.file_size || file.size,
          content: result.aiAnalysis?.formattedText || '',
          aiAnalysis: result.aiAnalysis,
          timestamp: new Date().toISOString()
        };

        uploadedFiles.push(uploadedFileInfo);
        currentUploadedFile = uploadedFileInfo;

        // Refresh the file list for Notes Breakdown section
        try {
          await loadUploadedNotes();
          // Also refresh NbFileManager if it exists
          if (window.nbFileManager) {
            await window.nbFileManager.updateRecentFilesUI();
          }
        } catch (loadError) {
          console.warn('Failed to refresh file list:', loadError);
        }

        // Clear the file input after successful upload
        fileInput.value = '';
        // Reset UI to show drag & drop area again
        updateFileDisplay([]);

      } catch (error) {
        console.error('File upload error:', error);

        // Enhanced error handling with specific messages
        let errorMessage = 'Upload failed. Please try again.';
        let notificationType = 'error';

        if (error.message.includes('Authentication') || error.message.includes('401')) {
          errorMessage = 'Session expired. Please log in again.';
          notificationType = 'warning';
          setTimeout(() => {
            localStorage.removeItem("authToken");
            window.location.href = "signin.html";
          }, 2000);
        } else if (error.message.includes('File too large') || error.message.includes('413')) {
          errorMessage = 'File is too large. Please choose a smaller file (maximum 50MB).';
          notificationType = 'warning';
        } else if (error.message.includes('File type not supported') || error.message.includes('415')) {
          errorMessage = 'File type not supported. Please use PDF, Word (.docx), Text (.txt), PowerPoint (.pptx), Excel (.xlsx), or image files.';
          notificationType = 'warning';
        } else if (error.message.includes('Network') || error.message.includes('fetch')) {
          errorMessage = 'Network connection issue. Please check your internet connection and try again.';
          notificationType = 'warning';
        } else if (error.message.includes('429') || error.message.includes('Too many')) {
          errorMessage = 'Too many uploads. Please wait a moment and try again.';
          notificationType = 'warning';
        } else if (error.message.includes('Server error') || error.message.includes('500')) {
          errorMessage = 'Server temporarily unavailable. Please try again later.';
          notificationType = 'warning';
        } else if (error.message.includes('timeout')) {
          errorMessage = 'Upload timed out. Please try with a smaller file or check your connection.';
          notificationType = 'warning';
        } else if (error.message.includes('quota') || error.message.includes('storage')) {
          errorMessage = 'Storage limit reached. Please contact support to increase your storage quota.';
          notificationType = 'warning';
        } else if (error.message) {
          // Use the specific error message if available
          errorMessage = error.message;
        }

        showNotification(errorMessage, notificationType);
      } finally {
        // Re-enable button
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Upload File';
      }
    }

    // Enhanced error handling function
    function handleError(error, context = '') {
      console.error(`${context} Error:`, error);

      let errorMessage = "An unexpected error occurred. Please try again.";
      let errorType = 'error';

      if (error.message) {
        if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Failed to fetch')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (error.message.includes('API') || error.message.includes('endpoint') || error.message.includes('404')) {
          errorMessage = "Service temporarily unavailable. Please try again later.";
        } else if (error.message.includes('No authentication token') || error.message.includes('Invalid or expired token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
          errorType = 'warning';
        } else if (error.message.includes('403') || error.message.includes('Unauthorized')) {
          errorMessage = "Access denied. Please check your permissions.";
        } else if (error.message.includes('413')) {
          errorMessage = "File is too large. Please choose a smaller file.";
        } else if (error.message.includes('415')) {
          errorMessage = "File type not supported. Please choose a different file.";
        } else {
          errorMessage = error.message;
        }
      }

      // Show notification
      showNotification(errorMessage, errorType);

      // Also log to console for debugging
      console.warn('Error notification shown:', errorMessage);
    }

    // Sidebar tab switching with fade-in animation
    document.addEventListener("DOMContentLoaded", function () {
      const sidebarLinks = document.querySelectorAll(
        ".sidebar-nav ul li ul li a"
      );
      const homeBtn = document.querySelector(".home-btn");
      const workspace = document.querySelector(".workspace");
      // Tab content map: key = link text, value = HTML content
      const tabContents = {
        "Notes Breakdown": `
          <div class="notes-breakdown">
            <h2>Notes Breakdown</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Transform your lecture notes and documents into structured learning materials</p>

            <div class="nb-container">
              <div class="nb-upload-section">
                <div class="nb-upload-box">
                  <div class="nb-upload-content">
                    <i class="fa-solid fa-cloud-arrow-up nb-upload-icon"></i>
                    <h3>Drag & Drop Files Here</h3>
                    <p class="nb-upload-text">or click to browse</p>
                    <input type="file" id="nb-file" class="nb-file-input" multiple accept=".pdf,.docx,.txt,.pptx,.ppt,.jpg,.jpeg,.png,.gif,.bmp,.svg,.webp">
                  </div>
                  <div class="nb-upload-footer">
                    <div class="nb-upload-info">
                      <i class="fa-solid fa-circle-info"></i>
                      <span>PDF, Word, Text, PowerPoint & Image files up to 50MB</span>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                      <button class="nb-browse-btn" onclick="document.getElementById('nb-file').click();">
                        <i class="fa-solid fa-folder-open"></i> Choose Files
                      </button>
                      <button class="upload-file-btn" onclick="handleDirectUpload()">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Upload File
                      </button>
                    </div>
                  </div>
                </div>

                <div class="nb-quick-actions">
                  <button class="nb-action-btn active" onclick="showNbTab('recent')">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>Recent Files</span>
                  </button>
                  <button class="nb-action-btn" onclick="showNbTab('favorites')">
                    <i class="fa-solid fa-star"></i>
                    <span>Favorites</span>
                  </button>
                  <button class="nb-action-btn" onclick="showNbTab('library')">
                    <i class="fa-solid fa-folder"></i>
                    <span>My Library</span>
                  </button>
                </div>

                <!-- Quick Actions Tab Content -->
                <div class="nb-tab-content">
                  <!-- Recent Files Tab -->
                  <div id="nb-recent" class="nb-tab-panel active">
                    <div class="nb-recent-files">
                      <!-- Recent files will be loaded dynamically -->
                    </div>
                  </div>

                  <!-- Favorites Tab -->
                  <div id="nb-favorites" class="nb-tab-panel">
                    <div class="nb-favorites-list">
                      <div class="nb-file-row">
                        <i class="fa-solid fa-file-pdf"></i>
                        <div class="nb-file-info">
                          <span class="nb-file-name">Important_Notes.pdf</span>
                          <span class="nb-file-date">Added to favorites</span>
                        </div>
                        <button class="nb-file-action active" title="Remove from favorites">
                          <i class="fa-solid fa-star"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Library Tab -->
                  <div id="nb-library" class="nb-tab-panel">
                    <div class="nb-library-content">
                      <div class="nb-folder-row">
                        <i class="fa-solid fa-folder"></i>
                        <div class="nb-folder-info">
                          <span class="nb-folder-name">Physics</span>
                          <span class="nb-folder-count">12 files</span>
                        </div>
                      </div>
                      <div class="nb-folder-row">
                        <i class="fa-solid fa-folder"></i>
                        <div class="nb-folder-info">
                          <span class="nb-folder-name">Chemistry</span>
                          <span class="nb-folder-count">8 files</span>
                        </div>
                      </div>
                      <div class="nb-folder-row">
                        <i class="fa-solid fa-folder"></i>
                        <div class="nb-folder-info">
                          <span class="nb-folder-name">Mathematics</span>
                          <span class="nb-folder-count">15 files</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>



              <div class="nb-features-panel">
                <h3>AI Processing Options</h3>
                <div class="nb-features-grid">
                  <button type="button" class="nb-feature-card" data-action="smart_summary">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-book-open-reader"></i>
                    </div>
                    <h4>Smart Summary</h4>
                    <p>Generate concise chapter summaries and key points</p>
                  </button>
                  <button type="button" class="nb-feature-card" data-action="mind_map">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-diagram-project"></i>
                    </div>
                    <h4>Mind Map</h4>
                    <p>Create visual concept maps from your notes</p>
                  </button>
                  <button type="button" class="nb-feature-card" data-action="study_guide">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-lightbulb"></i>
                    </div>
                    <h4>Study Guide</h4>
                    <p>Generate comprehensive study materials</p>
                  </button>
                  <button type="button" class="nb-feature-card" data-action="flashcards">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-cards-blank"></i>
                    </div>
                    <h4>Flashcards</h4>
                    <p>Create interactive flashcards for review</p>
                  </button>
                  <button type="button" class="nb-feature-card" data-action="key_points">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-list-check"></i>
                    </div>
                    <h4>Key Points</h4>
                    <p>Extract and organize key points from your content</p>
                  </button>
                  <button type="button" class="nb-feature-card" data-action="concept_map">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-sitemap"></i>
                    </div>
                    <h4>Concept Map</h4>
                    <p>Generate detailed concept maps with relationships</p>
                  </button>
                  <button type="button" class="nb-feature-card" data-action="search">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                    <h4>Search Notes</h4>
                    <p>Search through all your processed notes</p>
                  </button>
                  <button type="button" class="nb-feature-card" data-action="statistics">
                    <div class="nb-feature-icon">
                      <i class="fa-solid fa-chart-bar"></i>
                    </div>
                    <h4>Statistics</h4>
                    <p>View processing statistics and insights</p>
                  </button>
                </div>
              </div>
            </div>

            <div class="nb-file-list">
              <div class="nb-list-header">
                <h3>Recent Uploads</h3>
                <div class="nb-list-actions">
                  <button class="nb-list-action"><i class="fa-solid fa-sort"></i> Sort</button>
                  <button class="nb-list-action"><i class="fa-solid fa-filter"></i> Filter</button>
                </div>
              </div>

              <!-- File items will be dynamically loaded here -->
              <div class="nb-file-items-container">
                <div class="nb-empty-state">
                  <i class="fa-solid fa-cloud-upload" style="font-size: 48px; color: #14807a; margin-bottom: 16px;"></i>
                  <h4 style="color: #14807a; margin-bottom: 8px;">No Files Uploaded Yet</h4>
                  <p style="color: #666; margin: 0;">Uploaded files will show here</p>
                </div>
              </div>
            </div>
          </div>
        `,
        "AI Images": `
          <div class="ai-image-generator">
            <h2>AI Image Generator</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Create professional diagrams, flowcharts, and visual aids for your academic or business needs</p>

            <div class="ai-img-container">
              <div class="ai-img-input-section">
                <div class="ai-img-prompt-area">
                  <label class="ai-img-prompt-label">What would you like to create?</label>
                  <div class="ai-img-input-group">
                    <input type="text" class="ai-img-input" placeholder="E.g., Generate a flowchart showing the water cycle process">
                    <button class="ai-img-clear"><i class="fa-solid fa-xmark"></i></button>
                  </div>
                </div>

                <div class="ai-img-options">
                  <div class="ai-img-option active">
                    <span class="ai-img-option-label"><i class="fa-solid fa-diagram-project"></i> Flowchart</span>
                    <span class="ai-img-option-desc">Process flows and decision trees</span>
                  </div>
                  <div class="ai-img-option">
                    <span class="ai-img-option-label"><i class="fa-solid fa-chart-column"></i> Diagram</span>
                    <span class="ai-img-option-desc">Technical and scientific diagrams</span>
                  </div>
                  <div class="ai-img-option">
                    <span class="ai-img-option-label"><i class="fa-solid fa-mind-share"></i> Mind Map</span>
                    <span class="ai-img-option-desc">Concept and topic relationships</span>
                  </div>
                  <div class="ai-img-option">
                    <span class="ai-img-option-label"><i class="fa-solid fa-shapes"></i> Infographic</span>
                    <span class="ai-img-option-desc">Visual data representation</span>
                  </div>
                </div>

                <button class="ai-img-generate-btn">
                  <i class="fa-solid fa-wand-magic-sparkles"></i>
                  Generate Image
                </button>
              </div>

              <div class="ai-img-preview-section">
                <div class="ai-img-preview-header">
                  <h3 class="ai-img-preview-title">Preview</h3>
                  <div class="ai-img-style-switch">
                    <button class="ai-img-style-btn active" data-style="modern" onclick="switchImgStyle(event, 'modern')">Modern</button>
                    <button class="ai-img-style-btn" data-style="classic" onclick="switchImgStyle(event, 'classic')">Classic</button>
                    <button class="ai-img-style-btn" data-style="minimal" onclick="switchImgStyle(event, 'minimal')">Minimal</button>
                  </div>
                </div>

                <div class="ai-img-preview-area">
                  <div class="ai-img-preview-placeholder">
                    <i class="fa-solid fa-image"></i>
                    <p>Your generated image will appear here</p>
                    <small>Choose an option and enter your prompt to begin</small>
                  </div>
                </div>

                <div class="ai-img-actions">
                  <button class="ai-img-action-btn">
                    <i class="fa-solid fa-download"></i>
                    Download PNG
                  </button>
                  <button class="ai-img-action-btn">
                    <i class="fa-solid fa-file-powerpoint"></i>
                    Add to Slides
                  </button>
                  <button class="ai-img-action-btn">
                    <i class="fa-solid fa-bookmark"></i>
                    Save to Library
                  </button>
                </div>
              </div>
            </div>

            <div class="ai-img-history">
              <div class="ai-img-history-header">
                <h3 class="ai-img-history-title">Recent Generations</h3>
                <button class="ai-img-action-btn">View All</button>
              </div>
              <div class="ai-img-grid">
                <div class="ai-img-thumbnail">
                  <img src="https://placehold.co/120x120/f8fffe/14807a?text=Flow" alt="Thumbnail">
                </div>
                <div class="ai-img-thumbnail">
                  <img src="https://placehold.co/120x120/f8fffe/14807a?text=Mind" alt="Thumbnail">
                </div>
                <div class="ai-img-thumbnail">
                  <img src="https://placehold.co/120x120/f8fffe/14807a?text=Chart" alt="Thumbnail">
                </div>
                <div class="ai-img-thumbnail">
                  <img src="https://placehold.co/120x120/f8fffe/14807a?text=Info" alt="Thumbnail">
                </div>
              </div>
            </div>
          </div>
        `,
        "MCQ Generator": `
          <div class="mcq-generator">
            <h2>MCQ Generator</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Generate engaging multiple-choice questions from your study materials</p>

            <div class="mcq-container">
              <div class="mcq-input-section">
                <div class="mcq-input-header">
                  <h3>Input Your Content</h3>
                  <p>Paste your text or choose a file to generate questions</p>
                </div>

                <div class="mcq-input-area">
                  <textarea class="mcq-input" placeholder="Enter your text here, or upload a document..."></textarea>
                </div>

                <div class="mcq-controls">
                  <div class="mcq-control-group">
                    <span class="mcq-control-label">Question Count</span>
                    <input type="number" class="mcq-control-input" min="5" max="50" value="10">
                  </div>

                  <div class="mcq-control-group">
                    <span class="mcq-control-label">Difficulty</span>
                    <select class="mcq-control-input">
                      <option value="basic">Basic</option>
                      <option value="intermediate" selected>Intermediate</option>
                      <option value="advanced">Advanced</option>
                    </select>
                  </div>

                  <div class="mcq-control-group">
                    <span class="mcq-control-label">Question Style</span>
                    <select class="mcq-control-input">
                      <option value="conceptual" selected>Conceptual Understanding</option>
                      <option value="analytical">Analytical Thinking</option>
                      <option value="application">Practical Application</option>
                    </select>
                  </div>

                  <button class="mcq-generate-btn">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    Generate Questions
                  </button>
                </div>
              </div>

              <div class="mcq-output-section">
                <div class="mcq-stats">
                  <div class="mcq-stat">
                    <div class="mcq-stat-value">10</div>
                    <div class="mcq-stat-label">Questions</div>
                  </div>
                  <div class="mcq-stat">
                    <div class="mcq-stat-value">4</div>
                    <div class="mcq-stat-label">Options Each</div>
                  </div>
                  <div class="mcq-stat">
                    <div class="mcq-stat-value">85%</div>
                    <div class="mcq-stat-label">Accuracy</div>
                  </div>
                </div>

                <ul class="mcq-list">
                  <li class="mcq-item">
                    <div class="mcq-question">
                      <span>1.</span> What is the capital city of France?
                    </div>
                    <ul class="mcq-answers">
                      <li class="mcq-answer">
                        <span class="mcq-answer-marker">A</span>
                        <span>Berlin</span>
                      </li>
                      <li class="mcq-answer">
                        <span class="mcq-answer-marker">B</span>
                        <span>Madrid</span>
                      </li>
                      <li class="mcq-answer correct">
                        <span class="mcq-answer-marker">C</span>
                        <span>Paris</span>
                      </li>
                      <li class="mcq-answer">
                        <span class="mcq-answer-marker">D</span>
                        <span>Rome</span>
                      </li>
                    </ul>
                  </li>
                </ul>

                <div class="mcq-actions">
                  <button class="mcq-action-btn">
                    <i class="fa-solid fa-file-export"></i>
                    Export as PDF
                  </button>
                  <button class="mcq-action-btn">
                    <i class="fa-solid fa-share"></i>
                    Share
                  </button>
                  <button class="mcq-action-btn primary">
                    <i class="fa-solid fa-play"></i>
                    Start Practice Session
                  </button>
                </div>
              </div>
            </div>
          </div>
        `,
        "My Dictionary": `
          <div class="my-dictionary">
            <h2>My Dictionary</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Build your personalized vocabulary and language learning hub</p>

            <div class="beta-feature-card">
              <div class="beta-feature-icon">
                <i class="fa-solid fa-book-open"></i>
              </div>
              <div class="beta-feature-content">
                <h3>Coming Soon!</h3>
                <p>Your intelligent vocabulary companion is almost ready.</p>
                <ul class="beta-feature-list">
                  <li><i class="fa-solid fa-check"></i> Multi-language word tracking</li>
                  <li><i class="fa-solid fa-check"></i> Smart flashcard system</li>
                  <li><i class="fa-solid fa-check"></i> Context-based learning</li>
                  <li><i class="fa-solid fa-check"></i> Progress analytics</li>
                </ul>
                <button class="beta-notify-btn">
                  <i class="fa-solid fa-bell"></i>
                  Notify When Available
                </button>
              </div>
            </div>
          </div>
        `,
        "My Questions": `
          <div class="my-questions">
            <h2>My Questions</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Track and manage your study questions and practice exercises</p>

            <div class="beta-feature-card">
              <div class="beta-feature-icon">
                <i class="fa-solid fa-flask"></i>
              </div>
              <div class="beta-feature-content">
                <h3>Coming Soon!</h3>
                <p>We're working hard to bring you a powerful question management system.</p>
                <ul class="beta-feature-list">
                  <li><i class="fa-solid fa-check"></i> Create and organize study questions</li>
                  <li><i class="fa-solid fa-check"></i> Track your learning progress</li>
                  <li><i class="fa-solid fa-check"></i> Generate practice exercises</li>
                  <li><i class="fa-solid fa-check"></i> Share with study groups</li>
                </ul>
                <button class="beta-notify-btn">
                  <i class="fa-solid fa-bell"></i>
                  Notify When Available
                </button>
              </div>
            </div>
          </div>
        `,
        "Upload Notes": `
          <div class="upload-notes">
            <h2>Upload Notes</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Transform your documents into smart study materials with AI</p>

            <div class="upload-container">
              <div class="upload-zone">
                <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                <h3>Drag & Drop your files here</h3>
                <p>or</p>
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">
                  <i class="fa-solid fa-folder-open"></i> Choose Files
                </button>
                <input type="file" id="file-input" hidden multiple accept=".pdf,.docx">
                <p class="file-types">Supports PDF and Word documents</p>
              </div>

              <div class="upload-features">
                <h3>What our AI can do</h3>
                <ul>
                  <li><i class="fa-solid fa-wand-magic-sparkles"></i> Convert lectures into structured study notes</li>
                  <li><i class="fa-solid fa-list-check"></i> Extract key topics and create summaries</li>
                  <li><i class="fa-solid fa-brain"></i> Generate practice questions and flashcards</li>
                  <li><i class="fa-solid fa-chart-simple"></i> Create visual mind maps and diagrams</li>
                </ul>
              </div>
            </div>

            <div class="file-list">
              <!-- Files will be listed here -->
            </div>

            <div class="processing-options">
              <h3>Process Documents</h3>
              <div class="processing-grid">
                <button class="process-btn" data-action="summarize">
                  <i class="fa-solid fa-book-open"></i>
                  <span>Summarize</span>
                  <small>Create concise summaries</small>
                </button>
                <button class="process-btn" data-action="questions">
                  <i class="fa-solid fa-question-circle"></i>
                  <span>Generate Questions</span>
                  <small>Create practice questions</small>
                </button>
                <button class="process-btn" data-action="mind-map">
                  <i class="fa-solid fa-mind-share"></i>
                  <span>Create Mind Map</span>
                  <small>Generate visual concept maps</small>
                </button>
                <button class="process-btn" data-action="flashcards">
                  <i class="fa-solid fa-cards-blank"></i>
                  <span>Generate Flashcards</span>
                  <small>Create study flashcards</small>
                </button>
                <button class="process-btn" data-action="study-guide">
                  <i class="fa-solid fa-graduation-cap"></i>
                  <span>Study Guide</span>
                  <small>Comprehensive study materials</small>
                </button>
                <button class="process-btn disabled" data-action="assignment">
                  <div class="beta-badge">Beta</div>
                  <i class="fa-solid fa-pen-to-square"></i>
                  <span>Generate Assignment</span>
                  <small>Create structured assignments</small>
                </button>
                <button class="process-btn disabled" data-action="presentation">
                  <div class="beta-badge">Beta</div>
                  <i class="fa-solid fa-presentation-screen"></i>
                  <span>Generate Presentation</span>
                  <small>Create slide deck</small>
                </button>
                <button class="process-btn disabled" data-action="seminar">
                  <div class="beta-badge">Beta</div>
                  <i class="fa-solid fa-chalkboard-teacher"></i>
                  <span>Generate Seminar</span>
                  <small>Create seminar materials</small>
                </button>
                <button class="process-btn" data-action="notes-to-pdf">
                  <i class="fa-solid fa-file-pdf"></i>
                  <span>Notes to PDF</span>
                  <small>Convert notes into PDF documents</small>
                </button>
                <button class="process-btn" data-action="pdf-to-docs">
                  <i class="fa-solid fa-file-word"></i>
                  <span>PDFs to Docs</span>
                  <small>Convert PDF files to editable Word documents</small>
                </button>
                <button class="process-btn" data-action="extract-keywords">
                  <i class="fa-solid fa-tags"></i>
                  <span>Extract Keywords</span>
                  <small>Identify important terms and concepts</small>
                </button>
              </div>
            </div>
          </div>
        `,
        Presentations: `
          <div class="presentations">
            <h2>Presentations</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Create and manage professional presentations with AI assistance</p>

            <div class="beta-feature-card">
              <div class="beta-feature-icon">
                <i class="fa-solid fa-presentation-screen"></i>
              </div>
              <div class="beta-feature-content">
                <h3>Coming Soon!</h3>
                <p>Get ready for AI-powered presentation creation and management.</p>
                <ul class="beta-feature-list">
                  <li><i class="fa-solid fa-check"></i> Convert notes to presentations</li>
                  <li><i class="fa-solid fa-check"></i> Smart slide suggestions</li>
                  <li><i class="fa-solid fa-check"></i> Professional templates</li>
                  <li><i class="fa-solid fa-check"></i> Real-time collaboration</li>
                </ul>
                <button class="beta-notify-btn">
                  <i class="fa-solid fa-bell"></i>
                  Notify When Available
                </button>
              </div>
            </div>
          </div>
        `,
        Assignments: `
          <div class="assignments">
            <h2>Assignments</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Create, manage, and track your academic assignments</p>

            <div class="beta-feature-card">
              <div class="beta-feature-icon">
                <i class="fa-solid fa-pen-to-square"></i>
              </div>
              <div class="beta-feature-content">
                <h3>Coming Soon!</h3>
                <p>A smarter way to handle your assignments is on the way.</p>
                <ul class="beta-feature-list">
                  <li><i class="fa-solid fa-check"></i> Assignment planning and tracking</li>
                  <li><i class="fa-solid fa-check"></i> AI-powered writing assistance</li>
                  <li><i class="fa-solid fa-check"></i> Research tools integration</li>
                  <li><i class="fa-solid fa-check"></i> Smart deadline reminders</li>
                </ul>
                <button class="beta-notify-btn">
                  <i class="fa-solid fa-bell"></i>
                  Notify When Available
                </button>
              </div>
            </div>
          </div>
        `,
        Seminars: `
          <div class="seminars">
            <h2>Seminars</h2>
            <p style="color:#7b8fa1; font-size:1.08rem; margin-bottom:24px;">Prepare and manage your seminar materials effectively</p>

            <div class="beta-feature-card">
              <div class="beta-feature-icon">
                <i class="fa-solid fa-chalkboard-teacher"></i>
              </div>
              <div class="beta-feature-content">
                <h3>Coming Soon!</h3>
                <p>Experience the future of seminar preparation and management.</p>
                <ul class="beta-feature-list">
                  <li><i class="fa-solid fa-check"></i> Seminar content organization</li>
                  <li><i class="fa-solid fa-check"></i> Interactive presentation tools</li>
                  <li><i class="fa-solid fa-check"></i> Audience engagement features</li>
                  <li><i class="fa-solid fa-check"></i> Resource management</li>
                </ul>
                <button class="beta-notify-btn">
                  <i class="fa-solid fa-bell"></i>
                  Notify When Available
                </button>
              </div>
            </div>
          </div>
        `,
      };

      // Save the default workspace content
      const defaultContent = workspace.innerHTML;
      // Set Home button as default active on page load
      homeBtn.classList.add("active");
      // Home button logic
      homeBtn.addEventListener("click", function () {
        // Remove active from all sidebar links
        sidebarLinks.forEach((l) => l.classList.remove("active"));
        // Set active on home button
        homeBtn.classList.add("active");
        // Fade out workspace
        workspace.style.opacity = 0;
        workspace.style.transform = "scale(0.98)";
        setTimeout(() => {
          workspace.innerHTML = defaultContent;
          workspace.style.opacity = 1;
          workspace.style.transform = "scale(1)";
        }, 220);
      });

      sidebarLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          // Remove active from all links and home button
          sidebarLinks.forEach((l) => l.classList.remove("active"));
          homeBtn.classList.remove("active");
          // Add active to clicked link
          this.classList.add("active");
          // Fade out workspace
          workspace.style.opacity = 0;
          workspace.style.transform = "scale(0.98)";
          setTimeout(() => {
            // Set content
            // Remove the beta badge text from the key
            const fullText = this.textContent.trim();
            const key = fullText.replace("Beta", "").trim();
            workspace.innerHTML =
              tabContents[key] ||
              `<div class="empty-state">
                <div class="empty-state-icon">
                  <i class="fa-solid fa-tools"></i>
                </div>
                <h2>${key}</h2>
                <p>This feature is currently under development.</p>
                <button class="beta-notify-btn">
                  <i class="fa-solid fa-bell"></i>
                  Notify When Available
                </button>
              </div>`;
            workspace.style.opacity = 1;
            workspace.style.transform = "scale(1)";
          }, 220);
        });
      });
      // Initial state: show default workspace content, no active tab
      workspace.style.opacity = 1;
    });
    // Prompt menu dropup logic
    const promptMenuBtn = document.querySelector(".prompt-menu-btn");
    const promptMenuDropup = document.querySelector(".prompt-menu-dropup");
    if (promptMenuBtn && promptMenuDropup) {
      promptMenuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        promptMenuDropup.classList.toggle("show");
      });
      document.addEventListener("click", (e) => {
        if (
          !promptMenuBtn.contains(e.target) &&
          !promptMenuDropup.contains(e.target)
        ) {
          promptMenuDropup.classList.remove("show");
        }
      });
    }
    // Profile dropdown toggles on button click
    const profileDropdown = document.querySelector(".profile-dropdown");
    const profileBtn = document.querySelector(".profile-btn");
    if (profileDropdown && profileBtn) {
      profileBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle("show");
      });
      document.addEventListener("click", (e) => {
        if (!profileDropdown.contains(e.target)) {
          profileDropdown.classList.remove("show");
        }
      });
    }

    // File attachment handling
    const promptFileInput = document.getElementById("prompt-file-input");
    const promptAttachments = document.querySelector(".prompt-attachments");
    const selectedFiles = new Set();

    if (promptFileInput && promptAttachments) {
      promptFileInput.addEventListener("change", function (e) {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
          files.forEach((file) => {
            if (!selectedFiles.has(file.name)) {
              selectedFiles.add(file.name);
              const attachment = document.createElement("div");
              attachment.className = "prompt-attachment";

              // Choose icon based on file type
              let icon = "fa-file";
              if (file.type.includes("pdf")) icon = "fa-file-pdf";
              else if (
                file.type.includes("word") ||
                file.name.endsWith(".docx")
              )
                icon = "fa-file-word";
              else if (file.type.includes("image")) icon = "fa-file-image";

              attachment.innerHTML = `
                <i class="fa-solid ${icon}"></i>
                <span>${file.name}</span>
                <i class="fa-solid fa-xmark remove-file" onclick="this.parentElement.remove(); selectedFiles.delete('${file.name}');"></i>
              `;
              promptAttachments.appendChild(attachment);
            }
          });

          // Close the dropup menu
          const promptMenuDropup = document.querySelector(
            ".prompt-menu-dropup"
          );
          if (promptMenuDropup) {
            promptMenuDropup.classList.remove("show");
          }

          // Update prompt input placeholder
          const promptInput = document.querySelector(".prompt-input");
          if (promptInput) {
            promptInput.placeholder = "Ask about the attached files...";
          }
        }
      });
    }

    // Custom dropdown logic
    const customDropdown = document.querySelector(".custom-dropdown");
    const customDropdownSelected = document.querySelector(
      ".custom-dropdown-selected"
    );
    const customDropdownList = document.querySelector(".custom-dropdown-list");
    if (customDropdown && customDropdownSelected && customDropdownList) {
      customDropdownSelected.addEventListener("click", (e) => {
        e.stopPropagation();
        customDropdown.classList.toggle("open");
      });
      customDropdown.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          customDropdown.classList.toggle("open");
        }
      });
      customDropdownList.querySelectorAll("li").forEach((li) => {
        li.addEventListener("click", (e) => {
          customDropdownList
            .querySelectorAll("li")
            .forEach((item) => item.classList.remove("active"));
          li.classList.add("active");
          customDropdownSelected.textContent = li.textContent;
          customDropdown.classList.remove("open");
        });
      });
      document.addEventListener("click", (e) => {
        if (!customDropdown.contains(e.target)) {
          customDropdown.classList.remove("open");
        }
      });
    }

    // File Management System
    class FileManager {
      constructor() {
        this.files = new Map();
        this.processingFiles = new Set();
      }

      addFile(fileId, fileData) {
        this.files.set(fileId, fileData);
        this.updateUI(fileId);
      }

      removeFile(fileId) {
        this.files.delete(fileId);
        this.processingFiles.delete(fileId);
        const fileElement = document.querySelector(
          `[data-file-id="${fileId}"]`
        );
        if (fileElement) {
          fileElement.remove();
        }
      }

      updateProgress(fileId, progress) {
        const file = this.files.get(fileId);
        if (file) {
          file.progress = progress;
          this.updateUI(fileId);
        }
      }

      updateUI(fileId) {
        const file = this.files.get(fileId);
        if (!file) return;

        let fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
        if (!fileElement) {
          fileElement = this.createFileElement(file);
          document.querySelector(".nb-file-list").appendChild(fileElement);
        }

        const progressBar = fileElement.querySelector(".nb-progress-bar");
        const statusText = fileElement.querySelector(".nb-status-text");

        if (progressBar) progressBar.style.width = `${file.progress}%`;
        if (statusText)
          statusText.textContent =
            file.progress === 100 ? "Completed" : "Processing...";

        if (file.progress === 100) {
          fileElement.classList.add("nb-item-complete");
          this.processingFiles.delete(fileId);
        }
      }

      createFileElement(file) {
        const div = document.createElement("div");
        div.className = "nb-file-item";
        div.dataset.fileId = file.id;
        div.innerHTML = `
          <div class="nb-file-info">
            <span class="nb-file-icon"><i class="fa-solid fa-file-${
              file.type
            }"></i></span>
            <div class="nb-file-details">
              <span class="nb-file-name">${file.name}</span>
              <span class="nb-file-meta">${file.type.toUpperCase()} • ${
          file.size
        } • ${file.time}</span>
            </div>
          </div>
          <div class="nb-file-status">
            <div class="nb-progress">
              <div class="nb-progress-bar" style="width:${
                file.progress
              }%"></div>
            </div>
            <span class="nb-status-text">${
              file.progress === 100 ? "Completed" : "Processing..."
            }</span>
          </div>
          <div class="nb-file-actions">
            ${
              file.progress < 100
                ? `
              <button class="nb-action" title="Stop" onclick="fileManager.stopProcessing('${file.id}')">
                <i class="fa-solid fa-stop"></i>
              </button>
            `
                : `
              <button class="nb-action" title="Download" onclick="fileManager.downloadFile('${file.id}')">
                <i class="fa-solid fa-download"></i>
              </button>
              <button class="nb-action" title="Share" onclick="fileManager.shareFile('${file.id}')">
                <i class="fa-solid fa-share"></i>
              </button>
            `
            }
            <button class="nb-action" title="Delete" onclick="fileManager.removeFile('${
              file.id
            }')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        `;
        return div;
      }

      stopProcessing(fileId) {
        const file = this.files.get(fileId);
        if (file && file.progress < 100) {
          clearInterval(file.processingInterval);
          const statusText = document.querySelector(
            `[data-file-id="${fileId}"] .nb-status-text`
          );
          if (statusText) {
            statusText.textContent = "Stopped";
            statusText.classList.add("nb-error");
          }
        }
      }

      downloadFile(fileId) {
        const file = this.files.get(fileId);
        if (file && file.progress === 100) {
          // Simulate download
          showNotification(`Downloading ${file.name}...`, 'info');
        }
      }

      shareFile(fileId) {
        const file = this.files.get(fileId);
        if (file && file.progress === 100) {
          // Simulate share dialog
          showNotification(`Sharing ${file.name}...`, 'info');
        }
      }

      simulateProcessing(fileId) {
        const file = this.files.get(fileId);
        if (!file || file.progress === 100) return;

        this.processingFiles.add(fileId);
        let progress = 0;
        file.processingInterval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress >= 100) {
            progress = 100;
            clearInterval(file.processingInterval);
          }
          this.updateProgress(fileId, Math.min(progress, 100));
        }, 500);
      }
    }

    // Initialize File Manager
    const fileManager = new FileManager();

    // File Management System for nb-quick-actions
    class NbFileManager {
      constructor() {
        this.recentFiles = JSON.parse(localStorage.getItem('nb-recent-files') || '[]');
        this.favorites = JSON.parse(localStorage.getItem('nb-favorites') || '[]');
        this.library = JSON.parse(localStorage.getItem('nb-library') || '[]');
        this.maxRecentFiles = 20;
        window.nbFileManager = this; // Make globally accessible

        // Load favorites and folders from backend on initialization
        Promise.all([
          this.loadFavoritesFromBackend(),
          this.loadFoldersFromBackend()
        ]).then(([favoritesSuccess, foldersSuccess]) => {
          if (favoritesSuccess) {
            console.log('Favorites loaded from backend successfully');
          } else {
            console.log('Using local favorites data');
          }

          if (foldersSuccess) {
            console.log('Folders loaded from backend successfully');
          } else {
            console.log('Using local folders data');
          }
        }).catch(error => {
          console.error('Error loading favorites or folders:', error);
        });
      }

      // Save data to localStorage
      saveData() {
        localStorage.setItem('nb-recent-files', JSON.stringify(this.recentFiles));
        localStorage.setItem('nb-favorites', JSON.stringify(this.favorites));
        localStorage.setItem('nb-library', JSON.stringify(this.library));
      }

      // Load favorites from backend
      async loadFavoritesFromBackend() {
        try {
          const favorites = await apiFetch('/upload/favorites');
          this.favorites = favorites.map(fav => ({
            ...fav,
            favoritedAt: fav.updated_at || new Date().toISOString()
          }));
          this.saveData();
          return true;
        } catch (error) {
          console.error('Failed to load favorites from backend:', error);
          // Fallback to localStorage if API fails
          return false;
        }
      }

      // Load folders from backend
      async loadFoldersFromBackend() {
        try {
          const folders = await apiFetch('/upload/folders');
          this.library = folders.map(folder => ({
            id: folder.id,
            name: folder.name,
            description: folder.description,
            color: folder.color,
            files: [], // Will be populated when needed
            createdAt: folder.created_at
          }));
          this.saveData();
          return true;
        } catch (error) {
          console.error('Failed to load folders from backend:', error);
          // Fallback to localStorage if API fails
          return false;
        }
      }

      // Load folder files from backend
      async loadFolderFiles(folderId) {
        try {
          const response = await apiFetch(`/upload/folders/${folderId}/files`);
          const folder = this.library.find(f => f.id === folderId);
          if (folder) {
            folder.files = response.files.map(file => ({
              ...file,
              addedAt: file.updated_at || new Date().toISOString()
            }));
            this.saveData();
            this.updateLibraryUI();
          }
          return true;
        } catch (error) {
          console.error('Failed to load folder files:', error);
          return false;
        }
      }

      // Refresh folders from backend
      async refreshFolders() {
        try {
          showNotification('Refreshing folders...', 'info', 0);
          const success = await this.loadFoldersFromBackend();
          if (success) {
            this.updateLibraryUI();
            showNotification('Folders refreshed successfully', 'success');
          } else {
            showNotification('Failed to refresh folders', 'error');
          }
          return success;
        } catch (error) {
          console.error('Failed to refresh folders:', error);
          showNotification('Failed to refresh folders', 'error');
          return false;
        }
      }

      // Refresh folder files for all folders
      async refreshAllFolderFiles() {
        try {
          const refreshPromises = this.library.map(folder =>
            this.loadFolderFiles(folder.id).catch(error => {
              console.error(`Failed to refresh files for folder ${folder.id}:`, error);
              return false;
            })
          );

          const results = await Promise.allSettled(refreshPromises);
          const successCount = results.filter(result => result.status === 'fulfilled' && result.value).length;

          if (successCount > 0) {
            showNotification(`Refreshed files for ${successCount} folder${successCount > 1 ? 's' : ''}`, 'success');
          }
          return successCount > 0;
        } catch (error) {
          console.error('Failed to refresh folder files:', error);
          return false;
        }
      }

      // Add file to recent files
      addRecentFile(fileData) {
        const file = {
          id: fileData.id || Date.now().toString(),
          name: fileData.name,
          type: fileData.type || 'document',
          size: fileData.size || 0,
          timestamp: fileData.timestamp || new Date().toISOString(),
          content: fileData.content || '',
          source: fileData.source || 'upload'
        };

        // Remove if already exists
        this.recentFiles = this.recentFiles.filter(f => f.id !== file.id);

        // Add to beginning
        this.recentFiles.unshift(file);

        // Limit to max recent files
        if (this.recentFiles.length > this.maxRecentFiles) {
          this.recentFiles = this.recentFiles.slice(0, this.maxRecentFiles);
        }

        this.saveData();
        this.updateRecentFilesUI();
        return file.id;
      }

      // Toggle favorite status with backend API integration
      async toggleFavorite(fileId) {
        const file = this.recentFiles.find(f => f.id === fileId);
        if (!file) return false;

        try {
          // Make API call to toggle favorite status
          const response = await apiFetch(`/upload/notes/${fileId}/favorite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          // Update local state based on API response
          const newFavoriteStatus = response.is_favorite;

          if (newFavoriteStatus) {
            // Add to favorites if not already there
            if (!this.favorites.some(f => f.id === fileId)) {
              this.favorites.push({ ...file, favoritedAt: new Date().toISOString() });
            }
          } else {
            // Remove from favorites
            this.favorites = this.favorites.filter(f => f.id !== fileId);
          }

          // Update file's favorite status in recentFiles
          const recentFile = this.recentFiles.find(f => f.id === fileId);
          if (recentFile) {
            recentFile.isFavorite = newFavoriteStatus;
          }

          this.saveData();
          this.updateFavoritesUI();
          this.updateRecentFilesUI(); // Refresh recent files to show updated star status

          // Show success notification
          showNotification(
            newFavoriteStatus ? `"${file.name}" added to favorites` : `"${file.name}" removed from favorites`,
            'success'
          );

          return newFavoriteStatus;
        } catch (error) {
          console.error('Failed to toggle favorite:', error);

          let errorMessage = 'Failed to update favorite status. Please try again.';
          if (error.message.includes('fetch') || error.message.includes('network')) {
            errorMessage = 'Network connection issue. Please check your internet connection.';
          } else if (error.message.includes('No authentication token')) {
            errorMessage = 'Session expired. Please log in again.';
          } else if (error.message.includes('404')) {
            errorMessage = 'File not found. It may have been deleted.';
          }

          showNotification(errorMessage, 'error');
          return false;
        }
      }

      // Create new library folder with backend integration
      async createLibraryFolder(name, description = '', color = '#14807a') {
        try {
          showNotification('Creating folder...', 'info', 0);

          // Call backend API to create folder
          const response = await apiFetch('/upload/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name.trim(),
              description: description.trim(),
              color: color
            })
          });

          // Add to local library array
          const folder = {
            id: response.folder.id,
            name: response.folder.name,
            description: response.folder.description,
            color: response.folder.color,
            files: [],
            createdAt: response.folder.created_at
          };

          this.library.push(folder);
          this.saveData();
          this.updateLibraryUI();

          showNotification(`Folder "${name}" created successfully`, 'success');
          return folder.id;
        } catch (error) {
          console.error('Failed to create folder:', error);
          let errorMessage = 'Failed to create folder. Please try again.';
          let notificationType = 'error';

          if (error.message.includes('fetch') || error.message.includes('network')) {
            errorMessage = 'Network connection issue. Please check your internet connection.';
          } else if (error.message.includes('No authentication token') || error.message.includes('Authentication expired')) {
            errorMessage = 'Session expired. Please refresh the page and log in again.';
            notificationType = 'warning';
            setTimeout(() => window.location.href = "signin.html", 2000);
          } else if (error.message.includes('already exists') || error.message.includes('duplicate')) {
            errorMessage = 'A folder with this name already exists.';
          } else if (error.message.includes('validation') || error.message.includes('invalid')) {
            errorMessage = 'Invalid folder name. Please use a different name.';
          }

          showNotification(errorMessage, notificationType);
          return null;
        }
      }

      // Add file to library folder with backend integration
      async addToLibraryFolder(fileId, folderId) {
        try {
          showNotification('Adding file to folder...', 'info', 0);

          // Call backend API to add file to folder
          await apiFetch('/upload/folders/add-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              noteId: fileId,
              folderId: folderId
            })
          });

          const file = this.recentFiles.find(f => f.id === fileId);
          const folder = this.library.find(f => f.id === folderId);

          if (file && folder) {
            // Remove if already in folder
            folder.files = folder.files.filter(f => f.id !== fileId);

            // Add to folder
            folder.files.push({ ...file, addedAt: new Date().toISOString() });

            // Update file's folder reference
            file.folderId = folderId;

            this.saveData();
            this.updateLibraryUI();
            this.updateRecentFilesUI(); // Refresh to show folder assignment
          }

          showNotification('File added to folder successfully', 'success');
          return true;
        } catch (error) {
          console.error('Failed to add file to folder:', error);
          let errorMessage = 'Failed to add file to folder. Please try again.';
          let notificationType = 'error';

          if (error.message.includes('fetch') || error.message.includes('network')) {
            errorMessage = 'Network connection issue. Please check your internet connection.';
          } else if (error.message.includes('No authentication token') || error.message.includes('Authentication expired')) {
            errorMessage = 'Session expired. Please refresh the page and log in again.';
            notificationType = 'warning';
            setTimeout(() => window.location.href = "signin.html", 2000);
          } else if (error.message.includes('not found')) {
            errorMessage = 'File or folder not found.';
          } else if (error.message.includes('already exists')) {
            errorMessage = 'File is already in this folder.';
          }

          showNotification(errorMessage, notificationType);
          return false;
        }
      }

      // Update UI methods
      updateRecentFilesUI() {
        const container = document.querySelector('#nb-recent .nb-recent-files');
        if (!container) return;

        if (this.recentFiles.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No recent uploads found. Upload some files to get started!</p>';
          return;
        }

        container.innerHTML = this.recentFiles.map(file => `
          <div class="nb-file-row" data-file-id="${file.id}">
            <i class="fa-solid fa-file-${this.getFileIcon(file.type)}"></i>
            <div class="nb-file-info">
              <span class="nb-file-name">${file.name}</span>
              <span class="nb-file-date">${file.type.toUpperCase()} • ${this.formatDate(file.timestamp)}</span>
            </div>
            <div class="nb-file-actions">
              <button class="nb-file-action ${file.isFavorite || this.favorites.some(f => f.id === file.id) ? 'active' : ''}" title="${file.isFavorite || this.favorites.some(f => f.id === file.id) ? 'Remove from favorites' : 'Add to favorites'}" onclick="nbFileManager.toggleFavorite('${file.id}')">
                <i class="fa-${file.isFavorite || this.favorites.some(f => f.id === file.id) ? 'solid' : 'regular'} fa-star"></i>
              </button>
              <button class="nb-file-action" title="Delete file" onclick="nbFileManager.deleteFile('${file.id}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      }

      updateFavoritesUI() {
        const container = document.querySelector('#nb-favorites .nb-favorites-list');
        if (!container) return;

        // Filter favorites to only show files that exist in recentFiles (database)
        const validFavorites = this.favorites.filter(fav => this.recentFiles.some(rf => rf.id === fav.id));

        // Update localStorage with valid favorites only
        if (validFavorites.length !== this.favorites.length) {
          this.favorites = validFavorites;
          this.saveData();
        }

        if (validFavorites.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No favorites yet</p>';
          return;
        }

        container.innerHTML = validFavorites.map(file => `
          <div class="nb-file-row" data-file-id="${file.id}">
            <i class="fa-solid fa-file-${this.getFileIcon(file.type)}"></i>
            <div class="nb-file-info">
              <span class="nb-file-name">${file.name}</span>
              <span class="nb-file-date">${file.type.toUpperCase()} • Added to favorites</span>
            </div>
            <button class="nb-file-action active" title="Remove from favorites" onclick="nbFileManager.toggleFavorite('${file.id}')">
              <i class="fa-solid fa-star"></i>
            </button>
          </div>
        `).join('');
      }

      updateLibraryUI() {
        const container = document.querySelector('#nb-library .nb-library-content');
        if (!container) return;

        if (this.library.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #666; margin-bottom: 16px;">No folders yet</p>
              <button class="nb-action-btn" onclick="nbFileManager.showCreateFolderDialog()">
                <i class="fa-solid fa-plus"></i>
                <span>Create Folder</span>
              </button>
            </div>
          `;
          return;
        }

        container.innerHTML = this.library.map(folder => `
          <div class="nb-folder-row" data-folder-id="${folder.id}">
            <i class="fa-solid fa-folder"></i>
            <div class="nb-folder-info">
              <span class="nb-folder-name">${folder.name}</span>
              <span class="nb-folder-count">${folder.files.length} files</span>
            </div>
            <div class="nb-folder-actions">
              <button class="nb-file-action" title="Add file" onclick="nbFileManager.showAddToFolderDialog('${folder.id}')">
                <i class="fa-solid fa-plus"></i>
              </button>
              <button class="nb-file-action" title="Delete folder" onclick="nbFileManager.deleteFolder('${folder.id}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');

        // Add create folder button at the end
        const createBtn = document.createElement('div');
        createBtn.innerHTML = `
          <div class="nb-folder-row" style="border-top: 2px dashed #e0e0e0; margin-top: 16px;">
            <i class="fa-solid fa-plus" style="color: #14807a;"></i>
            <div class="nb-folder-info">
              <span class="nb-folder-name" style="color: #14807a; cursor: pointer;" onclick="nbFileManager.showCreateFolderDialog()">Create New Folder</span>
              <span class="nb-folder-count"></span>
            </div>
            <div class="nb-folder-actions">
              <!-- Empty actions for create folder row -->
            </div>
          </div>
        `;
        container.appendChild(createBtn);
      }

      // Dialog methods
      showCreateFolderDialog() {
        this.showFolderDialog(null);
      }

      showAddToFolderDialog(folderId) {
        this.showFolderDialog(folderId);
      }

      showFolderDialog(folderId) {
        const folder = folderId ? this.library.find(f => f.id === folderId) : null;
        const isCreateMode = !folderId;

        // Create modal
        const modal = document.createElement('div');
        modal.className = 'ai-result-modal';
        modal.innerHTML = `
          <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
          <div class="ai-result-content" style="max-width: 500px;">
            <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            <h3 style="color: #14807a; margin-bottom: 20px;">${isCreateMode ? 'Create New Folder' : `Add Files to "${folder?.name || 'Folder'}"`}</h3>

            ${isCreateMode ? `
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Folder Name:</label>
                <input type="text" id="folder-name-input" placeholder="Enter folder name" maxlength="100" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Description (optional):</label>
                <textarea id="folder-description-input" placeholder="Enter folder description" maxlength="255" rows="2" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Color:</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  ${['#14807a', '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997'].map(color => `
                    <button type="button" class="color-option" data-color="${color}" style="width: 32px; height: 32px; border-radius: 50%; border: 3px solid #e0e0e0; background: ${color}; cursor: pointer; transition: all 0.2s;" title="${color}"></button>
                  `).join('')}
                </div>
                <input type="hidden" id="folder-color-input" value="#14807a">
              </div>
            ` : ''}

            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">${isCreateMode ? 'Add Files to Folder (optional):' : 'Select Files to Add:'}</label>
              <div id="files-selection" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px;">
                ${this.getFilesSelectionHTML(folderId)}
              </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
              <button id="save-folder-btn" style="padding: 10px 20px; background: #14807a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">${isCreateMode ? 'Create Folder' : 'Add Files'}</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add color selection functionality
        if (isCreateMode) {
          const colorOptions = modal.querySelectorAll('.color-option');
          const colorInput = modal.querySelector('#folder-color-input');

          colorOptions.forEach(option => {
            option.addEventListener('click', () => {
              // Remove selected class from all options
              colorOptions.forEach(opt => opt.style.borderColor = '#e0e0e0');
              // Add selected class to clicked option
              option.style.borderColor = '#14807a';
              option.style.transform = 'scale(1.1)';
              // Update hidden input
              colorInput.value = option.dataset.color;
            });
          });

          // Set default color selection
          colorOptions[0].style.borderColor = '#14807a';
          colorOptions[0].style.transform = 'scale(1.1)';
        }

        // Add event listener to save button
        const saveBtn = modal.querySelector('#save-folder-btn');
        saveBtn.addEventListener('click', async () => {
          if (isCreateMode) {
            const folderNameInput = modal.querySelector('#folder-name-input');
            const folderDescriptionInput = modal.querySelector('#folder-description-input');
            const folderColorInput = modal.querySelector('#folder-color-input');

            const folderName = folderNameInput.value.trim();
            const folderDescription = folderDescriptionInput.value.trim();
            const folderColor = folderColorInput.value;

            if (!folderName) {
              showNotification('Please enter a folder name', 'warning');
              return;
            }

            if (folderName.length < 1 || folderName.length > 100) {
              showNotification('Folder name must be between 1 and 100 characters', 'warning');
              return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';

            const folderId = await this.createLibraryFolder(folderName, folderDescription, folderColor);

            if (folderId) {
              // Add selected files to the newly created folder
              const selectedFiles = Array.from(modal.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
              if (selectedFiles.length > 0) {
                for (const fileId of selectedFiles) {
                  await this.addToLibraryFolder(fileId, folderId);
                }
              }
              modal.remove();
            } else {
              saveBtn.disabled = false;
              saveBtn.innerHTML = 'Create Folder';
            }
          } else {
            const selectedFiles = Array.from(modal.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
            if (selectedFiles.length === 0) {
              showNotification('Please select at least one file', 'warning');
              return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';

            let successCount = 0;
            for (const fileId of selectedFiles) {
              if (await this.addToLibraryFolder(fileId, folderId)) {
                successCount++;
              }
            }

            if (successCount > 0) {
              modal.remove();
            } else {
              saveBtn.disabled = false;
              saveBtn.innerHTML = 'Add Files';
            }
          }
        });
      }

      getFilesSelectionHTML(folderId) {
        const folder = folderId ? this.library.find(f => f.id === folderId) : null;
        const availableFiles = this.recentFiles.filter(file =>
          !folder || !folder.files.some(f => f.id === file.id)
        );

        if (availableFiles.length === 0) {
          return '<p style="text-align: center; color: #666; margin: 20px 0;">No files available to add</p>';
        }

        return availableFiles.map(file => `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #f0f0f0;">
            <input type="checkbox" class="file-checkbox" value="${file.id}" id="file-${file.id}" style="margin: 0;">
            <label for="file-${file.id}" style="flex: 1; cursor: pointer; margin: 0;">
              <div style="font-weight: 500;">${file.name}</div>
              <div style="font-size: 12px; color: #666;">${this.formatDate(file.timestamp)} • ${file.type}</div>
            </label>
          </div>
        `).join('');
      }

      // Delete folder with backend integration
      async deleteFolder(folderId) {
        const folder = this.library.find(f => f.id === folderId);
        if (!folder) {
          showNotification('Folder not found', 'error');
          return;
        }

        // Check if folder has files
        const hasFiles = folder.files && folder.files.length > 0;

        if (hasFiles) {
          // Show confirmation with warning about files
          this.showDeleteFolderConfirmation(folder, true);
        } else {
          // Show standard confirmation
          this.showDeleteFolderConfirmation(folder, false);
        }
      }

      // Show custom delete confirmation dialog
      showDeleteFolderConfirmation(folder, hasFiles = false) {
        const message = hasFiles
          ? `This folder contains ${folder.files.length} file(s). Are you sure you want to delete "${folder.name}" and all its contents?`
          : `Are you sure you want to delete the folder "${folder.name}"?`;

        // Create confirmation modal
        const modal = document.createElement('div');
        modal.className = 'ai-result-modal';
        modal.innerHTML = `
          <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
          <div class="ai-result-content" style="max-width: 450px;">
            <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            <div style="text-align: center; padding: 20px 0;">
              <div style="font-size: 48px; color: #dc3545; margin-bottom: 16px;">
                <i class="fa-solid fa-trash-can"></i>
              </div>
              <h3 style="color: #333; margin-bottom: 12px; font-size: 1.2rem;">Delete Folder</h3>
              <p style="color: #666; line-height: 1.5; margin-bottom: 24px;">${message}</p>
              ${hasFiles ? '<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; padding: 12px; margin-bottom: 20px;"><i class="fa-solid fa-exclamation-triangle" style="color: #721c24; margin-right: 8px;"></i><span style="color: #721c24; font-size: 0.9rem; font-weight: 500;">Warning: All files in this folder will be permanently deleted!</span></div>' : ''}
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button id="confirm-delete-btn" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Delete Folder</button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add confirmation handler
        const confirmBtn = modal.querySelector('#confirm-delete-btn');
        confirmBtn.addEventListener('click', async () => {
          modal.remove();
          await this.performDeleteFolder(folder);
        });
      }

      // Perform the actual folder deletion
      async performDeleteFolder(folder) {
        try {
          showNotification('Deleting folder...', 'info', 0);

          // Call backend API to delete folder
          await apiFetch(`/upload/folders/${folder.id}`, {
            method: 'DELETE'
          });

          // Remove folder from library
          this.library = this.library.filter(f => f.id !== folder.id);

          // Remove folder reference from files
          this.recentFiles.forEach(file => {
            if (file.folderId === folder.id) {
              file.folderId = null;
            }
          });

          // Save to localStorage
          this.saveData();

          // Update UI
          this.updateLibraryUI();
          this.updateRecentFilesUI();

          showNotification(`Folder "${folder.name}" deleted successfully`, 'success');
        } catch (error) {
          console.error('Failed to delete folder:', error);
          let errorMessage = 'Failed to delete folder. Please try again.';
          let notificationType = 'error';

          if (error.message.includes('fetch') || error.message.includes('network')) {
            errorMessage = 'Network connection issue. Please check your internet connection.';
          } else if (error.message.includes('No authentication token') || error.message.includes('Authentication expired')) {
            errorMessage = 'Session expired. Please refresh the page and log in again.';
            notificationType = 'warning';
            setTimeout(() => window.location.href = "signin.html", 2000);
          } else if (error.message.includes('not found')) {
            errorMessage = 'Folder not found. It may have already been deleted.';
            // Remove from local state anyway
            this.library = this.library.filter(f => f.id !== folder.id);
            this.saveData();
            this.updateLibraryUI();
            notificationType = 'warning';
          } else if (error.message.includes('Cannot delete folder with files')) {
            errorMessage = 'Cannot delete folder with files. Please remove all files first.';
          }

          showNotification(errorMessage, notificationType);
        }
      }

      // Delete file
      async deleteFile(fileId) {
        const file = this.recentFiles.find(f => f.id === fileId);
        if (!file) {
          showNotification('File not found', 'error');
          return;
        }

        // Check if file is in any folders and warn user
        const isInFolder = file.folderId || this.library.some(folder =>
          folder.files && folder.files.some(f => f.id === fileId)
        );

        if (isInFolder) {
          // Show additional warning for files in folders
          this.showDeleteConfirmationModal(file, true);
        } else {
          // Show standard confirmation modal
          this.showDeleteConfirmationModal(file, false);
        }
      }

      // Show custom delete confirmation modal
      showDeleteConfirmationModal(file, isInFolder = false) {
        // Create confirmation modal
        const modal = document.createElement('div');
        modal.className = 'ai-result-modal';
        modal.innerHTML = `
          <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
          <div class="ai-result-content" style="max-width: 450px;">
            <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            <div style="text-align: center; padding: 20px 0;">
              <div style="font-size: 48px; color: #dc3545; margin-bottom: 16px;">
                <i class="fa-solid fa-trash-can"></i>
              </div>
              <h3 style="color: #333; margin-bottom: 12px; font-size: 1.2rem;">Delete File</h3>
              <p style="color: #666; line-height: 1.5; margin-bottom: ${isInFolder ? '12px' : '24px'};">Are you sure you want to delete "${file.name}"? This action cannot be undone.</p>
              ${isInFolder ? '<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-bottom: 20px;"><i class="fa-solid fa-exclamation-triangle" style="color: #856404; margin-right: 8px;"></i><span style="color: #856404; font-size: 0.9rem;">This file is currently in a folder. Deleting it will remove it from the folder as well.</span></div>' : ''}
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button id="confirm-delete-btn" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Delete File</button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add confirmation handler
        const confirmBtn = modal.querySelector('#confirm-delete-btn');
        confirmBtn.addEventListener('click', async () => {
          modal.remove();
          await this.performDelete(file);
        });
      }

      // Perform the actual delete operation
      async performDelete(file) {
        try {
          // Show loading state
          showNotification('Deleting file...', 'info', 0);

          // Call delete API
          await apiFetch(`/upload/notes/${file.id}`, {
            method: 'DELETE'
          });

          // Remove from recent files
          this.recentFiles = this.recentFiles.filter(f => f.id !== file.id);

          // Remove from favorites if it was favorited
          this.favorites = this.favorites.filter(f => f.id !== file.id);

          // Remove from any folders that contain this file
          this.library.forEach(folder => {
            if (folder.files) {
              folder.files = folder.files.filter(f => f.id !== file.id);
            }
          });

          // Save to localStorage
          this.saveData();

          // Update all UI components
          this.updateRecentFilesUI();
          this.updateFavoritesUI();
          this.updateLibraryUI();

          // Refresh the main file list if it exists
          if (typeof loadUploadedNotes === 'function') {
            try {
              await loadUploadedNotes();
            } catch (refreshError) {
              console.warn('Failed to refresh main file list:', refreshError);
            }
          }

          showNotification(`"${file.name}" deleted successfully`, 'success');
        } catch (err) {
          console.error('Delete file error:', err);
          let errorMessage = "Failed to delete file. Please try again.";
          let notificationType = 'error';

          if (err.message.includes('fetch') || err.message.includes('network')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
          } else if (err.message.includes('No authentication token') || err.message.includes('Authentication expired')) {
            errorMessage = "Session expired. Please refresh the page and log in again.";
            notificationType = 'warning';
            // Redirect to login after a delay
            setTimeout(() => {
              window.location.href = "signin.html";
            }, 2000);
          } else if (err.message.includes('404') || err.message.includes('not found')) {
            errorMessage = "File not found. It may have already been deleted.";
            // Remove from local state anyway to keep UI consistent
            this.recentFiles = this.recentFiles.filter(f => f.id !== file.id);
            this.favorites = this.favorites.filter(f => f.id !== file.id);
            this.saveData();
            this.updateRecentFilesUI();
            this.updateFavoritesUI();
            notificationType = 'warning';
          } else if (err.message.includes('403') || err.message.includes('Unauthorized')) {
            errorMessage = "You don't have permission to delete this file.";
          } else if (err.message.includes('500') || err.message.includes('Server error')) {
            errorMessage = "Server error. Please try again later.";
            notificationType = 'warning';
          } else if (err.message) {
            // Use the specific error message if available
            errorMessage = err.message;
          }

          showNotification(errorMessage, notificationType);
        }
      }

      // Helper methods
      getFileIcon(type) {
        const iconMap = {
          'pdf': 'pdf',
          'docx': 'word',
          'doc': 'word',
          'txt': 'lines',
          'notes': 'lines',
          'mcq': 'question',
          'image': 'image'
        };
        return iconMap[type] || 'lines';
      }

      formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} mins ago`;
        if (diffHours < 24) return `${diffHours} hours ago`;
        if (diffDays < 7) return `${diffDays} days ago`;

        return date.toLocaleDateString();
      }
    }

    // Load recent uploads from database
    async function loadRecentUploads() {
      try {
        const uploads = await apiFetch('/upload/notes');
        const recentFiles = uploads.slice(0, 20).map(upload => ({
          id: upload.id,
          name: upload.title,
          type: getFileTypeFromName(upload.title),
          size: 0, // Size not stored in upload_notes table
          timestamp: upload.created_at,
          content: upload.ai_analysis || '',
          source: 'upload'
        }));

        // Update NbFileManager with real data
        nbFileManager.recentFiles = recentFiles;
        nbFileManager.saveData();
        nbFileManager.updateRecentFilesUI();
      } catch (err) {
        console.error('Failed to load recent uploads:', err);

        let errorMessage = "Failed to load recent uploads. Please refresh the page.";
        if (err.message.includes('fetch') || err.message.includes('network')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
        }

        handleError(new Error(errorMessage), 'Load Recent Uploads');

        // Show empty state
        showEmptyState();
      }
    }

    // Show empty state when no files are uploaded
    function showEmptyState() {
      const container = document.querySelector('#nb-recent .nb-recent-files');
      if (container) {
        container.innerHTML = `
          <div class="nb-empty-state">
            <i class="fa-solid fa-cloud-upload" style="font-size: 48px; color: #14807a; margin-bottom: 16px;"></i>
            <h4 style="color: #14807a; margin-bottom: 8px;">No Recent Files Here</h4>
            <p style="color: #666; margin: 0;">Upload some files to get started</p>
          </div>
        `;
      }
    }

    // Helper function to determine file type from filename
    function getFileTypeFromName(filename) {
      if (!filename) return 'document';
      const ext = filename.split('.').pop().toLowerCase();
      const typeMap = {
        'pdf': 'pdf',
        'docx': 'docx',
        'doc': 'docx',
        'txt': 'txt',
        'pptx': 'pptx',
        'ppt': 'pptx',
        'xlsx': 'xlsx',
        'xls': 'xlsx',
        'jpg': 'image',
        'jpeg': 'image',
        'png': 'image',
        'gif': 'image',
        'bmp': 'image',
        'svg': 'image',
        'webp': 'image'
      };
      return typeMap[ext] || 'document';
    }

    // Global instance
    const nbFileManager = new NbFileManager();

    // Global variables for drag and drop
    let hasFile = false; // Track if any file is currently uploaded
    let isDragDropOperation = false; // Flag to track drag & drop operations

    // Global file upload state tracking
    let uploadedFiles = []; // Array to store uploaded file information
    let currentUploadedFile = null; // Current file being processed


    // Function to start AI processing
    function startAIProcessing() {
      // Remove popup
      const popup = document.querySelector('.upload-success-popup');
      if (popup) popup.remove();

      // Scroll to AI processing options
      const aiOptions = document.querySelector('.nb-features-panel');
      if (aiOptions) {
        aiOptions.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Add highlight effect
        aiOptions.style.boxShadow = '0 0 20px rgba(20, 128, 122, 0.3)';
        setTimeout(() => {
          aiOptions.style.boxShadow = '';
        }, 2000);
      }
    }

    // Function to get or create file input
    function getFileInput() {
      let fileInput = document.getElementById('nb-file');
      if (!fileInput) {
        // Create file input if it doesn't exist
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'nb-file';
        fileInput.className = 'nb-file-input';
        fileInput.accept = '.pdf,.docx,.txt';
        document.querySelector('.nb-upload-content').appendChild(fileInput);
      }
      return fileInput;
    }

    // Function to update UI with file information
    function updateFileDisplay(files) {
      try {
        const uploadContent = document.querySelector('.nb-upload-content');
        if (!uploadContent) {
          console.warn('Upload content element not found');
          return;
        }

        let icon = uploadContent.querySelector('.nb-upload-icon');
        let h3 = uploadContent.querySelector('h3');
        let p = uploadContent.querySelector('.nb-upload-text');
        let removeBtn = uploadContent.querySelector('.nb-remove-file');

        if (files && files.length > 0) {
          const file = files[0]; // Show first file info
          if (!file || !file.name) {
            console.warn('Invalid file object:', file);
            return;
          }

          const fileName = file.name;
          const fileType = getFileTypeFromName(fileName);
          const iconClass = getFileIconClass(fileType);
          const fileSize = formatFileSize(file.size || 0);

          hasFile = true; // Mark that we have a file

          if (icon) icon.className = `fa-solid ${iconClass} nb-upload-icon`;
          if (h3) h3.textContent = fileName;
          if (p) p.textContent = `${fileType.toUpperCase()} File • ${fileSize}`;

          if (!removeBtn) {
            removeBtn = document.createElement('button');
            removeBtn.className = 'nb-remove-file';
            removeBtn.onclick = removeCurrentFile;
            removeBtn.style.cssText = 'background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px;';
            removeBtn.innerHTML = '<i class="fa-solid fa-times"></i> Remove File';
            uploadContent.appendChild(removeBtn);
          } else {
            removeBtn.style.display = 'inline-block';
          }
        } else {
          // Reset to original state
          hasFile = false;
          if (icon) icon.className = 'fa-solid fa-cloud-arrow-up nb-upload-icon';
          if (h3) h3.textContent = 'Drag & Drop Files Here';
          if (p) p.textContent = 'or click to browse';
          if (removeBtn) removeBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('Error updating file display:', error);
      }
    }

    // Initialize drag and drop functionality for file upload
    function initializeDragDrop() {
      const uploadBox = document.querySelector('.nb-upload-box');

      // Ensure clean initial state
      const fileInput = getFileInput();
      if (fileInput) {
        fileInput.value = '';
      }

      if (!uploadBox || !fileInput) return;

      // Function to show restriction popup
      function showRestrictionPopup(message) {
        const modal = document.createElement('div');
        modal.className = 'ai-result-modal';
        modal.innerHTML = `
          <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
          <div class="ai-result-content" style="max-width: 400px;">
            <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            <h3 style="color: #14807a; margin-bottom: 16px;">Upload Restriction</h3>
            <p style="margin-bottom: 20px; line-height: 1.5;">${message}</p>
            <div style="text-align: center;">
              <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #14807a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">OK</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Helper function to format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      // Helper functions for file type detection
      function getFileTypeFromName(filename) {
        if (!filename) return 'document';
        const ext = filename.split('.').pop().toLowerCase();
        const typeMap = {
          'pdf': 'pdf',
          'docx': 'docx',
          'doc': 'docx',
          'txt': 'txt'
        };
        return typeMap[ext] || 'document';
      }

      function getFileIconClass(type) {
        const iconMap = {
          'pdf': 'fa-file-pdf',
          'docx': 'fa-file-word',
          'doc': 'fa-file-word',
          'txt': 'fa-file-lines',
          'document': 'fa-file-lines'
        };
        return iconMap[type] || 'fa-file-lines';
      }

      uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      uploadBox.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          // Mark that this is a drag & drop operation
          isDragDropOperation = true;

          // Set files to input element
          const currentFileInput = getFileInput();
          currentFileInput.files = files;

          // Update UI to show file information
          updateFileDisplay(files);

          // Reset the flag after a short delay
          setTimeout(() => {
            isDragDropOperation = false;
          }, 100);
        }
      });

      // Function to remove current file
      function removeCurrentFile() {
        const fileInput = document.getElementById('nb-file');
        if (fileInput) {
          fileInput.value = '';
          hasFile = false;
          isDragDropOperation = false; // Reset drag & drop flag
          // Reset to original state
          updateFileDisplay([]);
        }
      }
  
      // Make it globally accessible
      window.removeCurrentFile = removeCurrentFile;

      // Also update UI when files are selected via click (using event delegation)
      document.addEventListener('change', (e) => {
        if (e.target.id === 'nb-file') {
          const files = e.target.files;

          // If no files selected (input was cleared), don't reset UI
          // (this happens after upload, we want to keep the file display)
          if (files.length === 0) {
            return;
          }

          // If this is a drag & drop operation, skip the UI update
          // (the drag & drop handler already handled the UI update)
          if (isDragDropOperation) {
            return;
          }

          // Update UI to show file information for choose file operations
          updateFileDisplay(files);
        }
      });
    }

    // Initialize drag and drop on page load if Notes Breakdown is active
    document.addEventListener("DOMContentLoaded", function () {
      // Check if Notes Breakdown content is already loaded
      const uploadBox = document.querySelector('.nb-upload-box');
      if (uploadBox) {
        initializeDragDrop();
      }
    });


    // Load already uploaded notes from backend
    async function loadUploadedNotes(container = null) {
      console.log('[DEBUG] loadUploadedNotes called with container:', container);

      // Check authentication first
      if (!AUTH_TOKEN) {
        console.error('[DEBUG] No auth token found');
        showNotification('Authentication required. Please log in again.', 'error');
        setTimeout(() => window.location.href = "signin.html", 2000);
        return;
      }

      console.log('[DEBUG] Auth token present, making API call...');

      // Use the provided container or default to nbFileListContainer for Notes Breakdown
      let targetContainer = container;
      if (!targetContainer) {
        // If no container provided, determine based on current context
        targetContainer = nbFileListContainer || fileListContainer;
      }
      if (!targetContainer) {
        console.warn('[DEBUG] No target container found for loading notes');
        return;
      }

      try {
        const notes = await apiFetch("/upload/notes");
        console.log('[DEBUG] Loaded notes:', notes);

        if (!Array.isArray(notes)) {
          console.warn('[DEBUG] Notes response is not an array:', notes);
          return;
        }

        targetContainer.innerHTML = ""; // Clear existing list
        notes.forEach((note) => {
          if (!note || !note.id) {
            console.warn('[DEBUG] Invalid note data:', note);
            return;
          }

          const fileType = getFileTypeFromName(note.title || 'Unknown');
          const iconClass = getFileIconClass(fileType);

          // Safely format date
          let dateString = 'Unknown date';
          try {
            if (note.created_at) {
              dateString = new Date(note.created_at).toLocaleString();
            }
          } catch (dateError) {
            console.warn('[DEBUG] Invalid date format:', note.created_at);
          }

          const div = document.createElement("div");
          div.className = "nb-file-item nb-item-complete";
          div.innerHTML = `
          <div class="nb-file-info">
            <span class="nb-file-icon"><i class="fa-solid ${iconClass}"></i></span>
            <div class="nb-file-details">
              <span class="nb-file-name">${note.title || 'Untitled'}</span>
              <span class="nb-file-meta">${fileType.toUpperCase()} • Uploaded • ${dateString}</span>
            </div>
          </div>
          <div class="nb-file-status">
            <span class="nb-status-text nb-success">${note.ai_analysis ? 'AI Processed' : 'Uploaded'}</span>
          </div>
          <div class="nb-file-actions">
            <button class="nb-action" title="View Details" onclick="viewFileDetails('${note.id}')">
              <i class="fa-solid fa-eye"></i>
            </button>
            <button class="nb-action" title="Download" onclick="downloadFile('${note.id}')">
              <i class="fa-solid fa-download"></i>
            </button>
            <button class="nb-action" title="Delete" onclick="deleteNote('${note.id}')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        `;
          targetContainer.appendChild(div);
        });

        console.log('[DEBUG] Successfully loaded', notes.length, 'notes');
      } catch (err) {
        console.error("Failed to load uploaded notes:", err);

        let errorMessage = "Failed to load uploaded notes. Please refresh the page.";
        if (err.message.includes('fetch') || err.message.includes('network')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
        }

        // Use notification instead of alert
        showNotification(errorMessage, 'error');
      }
    }

    // Notes Breakdown Quick Actions
    document.addEventListener("DOMContentLoaded", function () {
      // Initialize tab functionality when Notes Breakdown section is loaded
      function initializeNbTabs() {
        const nbTabs = document.querySelectorAll(".nb-action-btn");
        const nbPanels = document.querySelectorAll(".nb-tab-panel");

        if (nbTabs.length && nbPanels.length) {
          function showNbTab(tabName) {
            // Hide all tab panels
            nbPanels.forEach((panel) => {
              panel.classList.remove("active");
            });

            // Show selected tab panel
            const selectedPanel = document.getElementById("nb-" + tabName);
            if (selectedPanel) {
              selectedPanel.classList.add("active");
            }

            // Update button states
            nbTabs.forEach((btn) => {
              btn.classList.remove("active");
            });
            event.currentTarget.classList.add("active");

            // Update UI for the selected tab
            if (tabName === 'recent') nbFileManager.updateRecentFilesUI();
            if (tabName === 'favorites') nbFileManager.updateFavoritesUI();
            if (tabName === 'library') nbFileManager.updateLibraryUI();
          }

          // Add click handlers to tab buttons
          nbTabs.forEach((btn) => {
            btn.addEventListener("click", function () {
              const tabName =
                this.getAttribute("onclick").match(/'([^']+)'/)[1];
              showNbTab(tabName);
            });
          });
        }
      }

      // Call initialization when the Notes Breakdown section is loaded
      const notesBreakdownLink = document.querySelector(
        'a[href="#"]:has(i.fa-file-lines)'
      );
      if (notesBreakdownLink) {
        notesBreakdownLink.addEventListener("click", function () {
          // Wait for the content to be loaded
          setTimeout(() => {
            initializeNbTabs();
            initializeDragDrop(); // Initialize drag and drop functionality
            // Load real data from database
            loadRecentUploads();
            // Initialize other UI components
            nbFileManager.updateFavoritesUI();
            nbFileManager.updateLibraryUI();
            // Initialize sort and filter functionality
            initializeSortAndFilter();
          }, 300);
        });
      }

      // Sort and Filter functionality for Recent Uploads
      function initializeSortAndFilter() {
        const sortBtn = document.querySelector('.nb-list-actions .nb-list-action:first-child');
        const filterBtn = document.querySelector('.nb-list-actions .nb-list-action:last-child');

        if (sortBtn) {
          sortBtn.addEventListener('click', () => {
            showSortOptions();
          });
        }

        if (filterBtn) {
          filterBtn.addEventListener('click', () => {
            showFilterOptions();
          });
        }
      }

      function showSortOptions() {
        // Create sort options modal
        const modal = document.createElement('div');
        modal.className = 'ai-result-modal';
        modal.innerHTML = `
          <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
          <div class="ai-result-content" style="max-width: 300px;">
            <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            <h3 style="color: #14807a; margin-bottom: 20px;">Sort Files</h3>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <button class="sort-option" data-sort="name-asc" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Name (A-Z)</button>
              <button class="sort-option" data-sort="name-desc" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Name (Z-A)</button>
              <button class="sort-option" data-sort="date-new" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Newest First</button>
              <button class="sort-option" data-sort="date-old" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Oldest First</button>
              <button class="sort-option" data-sort="size-large" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Largest First</button>
              <button class="sort-option" data-sort="size-small" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Smallest First</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add click handlers for sort options
        modal.querySelectorAll('.sort-option').forEach(btn => {
          btn.addEventListener('click', () => {
            const sortType = btn.dataset.sort;
            sortRecentFiles(sortType);
            modal.remove();
          });
        });
      }

      function showFilterOptions() {
        // Create filter options modal
        const modal = document.createElement('div');
        modal.className = 'ai-result-modal';
        modal.innerHTML = `
          <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
          <div class="ai-result-content" style="max-width: 300px;">
            <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            <h3 style="color: #14807a; margin-bottom: 20px;">Filter Files</h3>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <button class="filter-option" data-filter="all" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">All Files</button>
              <button class="filter-option" data-filter="pdf" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">PDF Files</button>
              <button class="filter-option" data-filter="word" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Word Documents</button>
              <button class="filter-option" data-filter="text" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Text Files</button>
              <button class="filter-option" data-filter="powerpoint" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">PowerPoint</button>
              <button class="filter-option" data-filter="excel" style="padding: 10px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Excel Files</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add click handlers for filter options
        modal.querySelectorAll('.filter-option').forEach(btn => {
          btn.addEventListener('click', () => {
            const filterType = btn.dataset.filter;
            filterRecentFiles(filterType);
            modal.remove();
          });
        });
      }

      function sortRecentFiles(sortType) {
        if (!nbFileManager.recentFiles || nbFileManager.recentFiles.length === 0) return;

        let sortedFiles = [...nbFileManager.recentFiles];

        switch (sortType) {
          case 'name-asc':
            sortedFiles.sort((a, b) => a.name.localeCompare(b.name));
            break;
          case 'name-desc':
            sortedFiles.sort((a, b) => b.name.localeCompare(a.name));
            break;
          case 'date-new':
            sortedFiles.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            break;
          case 'date-old':
            sortedFiles.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            break;
          case 'size-large':
            sortedFiles.sort((a, b) => (b.size || 0) - (a.size || 0));
            break;
          case 'size-small':
            sortedFiles.sort((a, b) => (a.size || 0) - (b.size || 0));
            break;
        }

        nbFileManager.recentFiles = sortedFiles;
        nbFileManager.updateRecentFilesUI();

        // Update the container with sorted files
        const container = document.querySelector('#nb-recent .nb-recent-files');
        if (container && sortedFiles.length > 0) {
          container.innerHTML = sortedFiles.map(file => `
            <div class="nb-file-row" data-file-id="${file.id}">
              <i class="fa-solid fa-file-${nbFileManager.getFileIcon(file.type)}"></i>
              <div class="nb-file-info">
                <span class="nb-file-name">${file.name}</span>
                <span class="nb-file-date">${nbFileManager.formatDate(file.timestamp)}</span>
              </div>
              <button class="nb-file-action ${nbFileManager.favorites.some(f => f.id === file.id) ? 'active' : ''}" title="Add to favorites" onclick="nbFileManager.toggleFavorite('${file.id}')">
                <i class="fa-${nbFileManager.favorites.some(f => f.id === file.id) ? 'solid' : 'regular'} fa-star"></i>
              </button>
            </div>
          `).join('');
        }
      }

      function filterRecentFiles(filterType) {
        if (!nbFileManager.recentFiles || nbFileManager.recentFiles.length === 0) return;

        let filteredFiles;

        if (filterType === 'all') {
          filteredFiles = [...nbFileManager.recentFiles];
        } else {
          filteredFiles = nbFileManager.recentFiles.filter(file => {
            const fileType = file.type.toLowerCase();
            switch (filterType) {
              case 'pdf':
                return fileType === 'pdf';
              case 'word':
                return fileType === 'docx' || fileType === 'doc';
              case 'text':
                return fileType === 'txt' || fileType === 'text';
              case 'powerpoint':
                return fileType === 'pptx' || fileType === 'ppt';
              case 'excel':
                return fileType === 'xlsx' || fileType === 'xls';
              default:
                return true;
            }
          });
        }

        // Temporarily update UI with filtered results
        const container = document.querySelector('#nb-recent .nb-recent-files');
        if (container) {
          if (filteredFiles.length === 0) {
            container.innerHTML = `
              <div class="nb-empty-state">
                <i class="fa-solid fa-filter" style="font-size: 48px; color: #14807a; margin-bottom: 16px;"></i>
                <h4 style="color: #14807a; margin-bottom: 8px;">No Files Match Filter</h4>
                <p style="color: #666; margin: 0;">Try selecting a different filter option</p>
              </div>
            `;
          } else {
            container.innerHTML = filteredFiles.map(file => `
              <div class="nb-file-row" data-file-id="${file.id}">
                <i class="fa-solid fa-file-${nbFileManager.getFileIcon(file.type)}"></i>
                <div class="nb-file-info">
                  <span class="nb-file-name">${file.name}</span>
                  <span class="nb-file-date">${nbFileManager.formatDate(file.timestamp)}</span>
                </div>
                <button class="nb-file-action ${nbFileManager.favorites.some(f => f.id === file.id) ? 'active' : ''}" title="Add to favorites" onclick="nbFileManager.toggleFavorite('${file.id}')">
                  <i class="fa-${nbFileManager.favorites.some(f => f.id === file.id) ? 'solid' : 'regular'} fa-star"></i>
                </button>
              </div>
            `).join('');
          }
        }
      }
    });
    // AI Image Style Switch Functionality
    function switchImgStyle(e, style) {
      // Remove active from all style buttons
      document
        .querySelectorAll(".ai-img-style-btn")
        .forEach((btn) => btn.classList.remove("active"));
      // Add active to clicked button
      e.currentTarget.classList.add("active");
      // Update preview area
      const preview = document.querySelector(".ai-img-preview-area");
      if (preview) {
        let styleText = "";
        let styleIcon = "";
        if (style === "modern") {
          styleText = "Modern style preview: clean, vibrant, and contemporary.";
          styleIcon = '<i class="fa-solid fa-image"></i>';
        } else if (style === "classic") {
          styleText = "Classic style preview: elegant, timeless, and detailed.";
          styleIcon = '<i class="fa-solid fa-image"></i>';
        } else if (style === "minimal") {
          styleText = "Minimal style preview: simple, clear, and focused.";
          styleIcon = '<i class="fa-solid fa-image"></i>';
        }
        preview.innerHTML = `<div class='ai-img-preview-placeholder'>${styleIcon}<p>${styleText}</p><small>Choose an option and enter your prompt to begin</small></div>`;
      }
    }
  </script>
  <!-- Add this snippet inside the existing <script> at the end of the file, after your current JS -->

  <script>
    //   const API_BASE_URL = 'http://localhost:4000'; // Change to your backend URL

    //   // TODO: Replace with actual auth token retrieval
    //   const AUTH_TOKEN = localStorage.getItem('authToken') || '';

    // Utility: fetch with auth headers
    async function apiFetch(path, options = {}) {
      const token = localStorage.getItem("authToken");
      if (!token) {
        throw new Error("No authentication token found. Please log in.");
      }

      const res = await fetch(`http://localhost:4000${path}`, {
        ...options,
        headers: {
          Authorization: `Bearer ${token}`,
          ...options.headers,
        },
      });
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        throw new Error(errorData.error || "API Error");
      }
      return res.json();
    }

    // File upload input and handlers for Upload Notes
    const fileInput = document.getElementById("file-input");
    const fileListContainer = document.querySelector(
      ".upload-notes .file-list .nb-file-items-container"
    );

    // File upload input and handlers for Notes Breakdown
    const nbFileInput = document.getElementById("nb-file");
    const nbFileListContainer = document.querySelector(".nb-file-items-container");

    // Modified to work with single file system and not interfere with UI updates
    fileInput.addEventListener("change", async (e) => {
      const files = fileInput.files;
      if (files.length === 0) return;

      // Only handle the first file (single file mode)
      const file = files[0];
      await uploadFile(file);

      // Clear input after upload for security (re-uploading same file)
      setTimeout(() => {
        fileInput.value = '';
      }, 100);

      // Load uploaded notes for Notes Breakdown section
      await loadUploadedNotes();
    });

    // Enhanced chunked file upload with progress tracking
    class ChunkedUploader {
      constructor() {
        this.activeUploads = new Map();
        this.chunkSize = 1024 * 1024; // 1MB chunks
      }

      async uploadFile(file) {
        try {
          // Initialize upload
          const initResponse = await apiFetch('/upload/init', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              fileName: file.name,
              fileSize: file.size,
              fileType: file.type || 'application/octet-stream'
            })
          });

          const uploadId = initResponse.uploadId;
          this.activeUploads.set(uploadId, {
            file,
            uploadId,
            status: 'uploading',
            progress: 0
          });

          // Add to UI
          addFileToUI(file, uploadId);

          // Start chunked upload
          await this.uploadChunks(file, uploadId);

        } catch (err) {
          console.error('Upload initialization failed:', err);

          let errorMessage = "Upload failed. Please try again.";
          if (err.message.includes('fetch') || err.message.includes('network')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
          } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
            errorMessage = "Session expired. Please refresh the page and log in again.";
          } else if (err.message.includes('413')) {
            errorMessage = "File is too large. Please choose a smaller file.";
          } else if (err.message.includes('415')) {
            errorMessage = "File type not supported. Please choose a different file.";
          }

          try {
            alert(errorMessage);
          } catch (alertError) {
            console.warn('Alert blocked, upload error message:', errorMessage);
          }

          removeFileFromUI(file.name);
        }
      }

      async uploadChunks(file, uploadId) {
        const totalChunks = Math.ceil(file.size / this.chunkSize);
        let uploadedChunks = 0;

        for (let i = 0; i < totalChunks; i++) {
          // Check if upload is paused
          const uploadData = this.activeUploads.get(uploadId);
          if (!uploadData || uploadData.status === 'paused') {
            break;
          }

          const start = i * this.chunkSize;
          const end = Math.min(start + this.chunkSize, file.size);
          const chunk = file.slice(start, end);

          try {
            const formData = new FormData();
            formData.append('chunk', chunk);
            formData.append('uploadId', uploadId);
            formData.append('chunkIndex', i.toString());
            formData.append('totalChunks', totalChunks.toString());

            const response = await fetch(`${API_BASE_URL}/upload/chunk`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${AUTH_TOKEN}`
              },
              body: formData
            });

            if (!response.ok) {
              throw new Error(`Chunk upload failed: ${response.statusText}`);
            }

            const result = await response.json();
            uploadedChunks++;

            // Update progress
            const progress = Math.round((uploadedChunks / totalChunks) * 100);
            this.updateProgress(uploadId, progress);

          } catch (err) {
            console.error(`Chunk ${i} upload failed:`, err);

            let errorMessage = "Upload failed. Please try again.";
            if (err.message.includes('fetch') || err.message.includes('network')) {
              errorMessage = "Network connection issue. Please check your internet connection.";
            } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
              errorMessage = "Session expired. Please refresh the page and log in again.";
            } else if (err.message.includes('413')) {
              errorMessage = "File is too large. Please choose a smaller file.";
            }

            try {
              alert(errorMessage);
            } catch (alertError) {
              console.warn('Alert blocked, chunk upload error message:', errorMessage);
            }

            this.updateStatus(uploadId, 'failed', 'Upload failed');
            break;
          }
        }

        // Check final status
        if (uploadedChunks === totalChunks) {
          this.updateStatus(uploadId, 'completed', 'Completed');
          // Refresh the file list
          await loadUploadedNotes();
        }
      }

      pauseUpload(uploadId) {
        const uploadData = this.activeUploads.get(uploadId);
        if (uploadData && uploadData.status === 'uploading') {
          uploadData.status = 'paused';
          this.updateStatus(uploadId, 'paused', 'Paused');
        }
      }

      async resumeUpload(uploadId) {
        const uploadData = this.activeUploads.get(uploadId);
        if (uploadData && uploadData.status === 'paused') {
          uploadData.status = 'uploading';
          this.updateStatus(uploadId, 'uploading', 'Resuming...');

          // Resume from where we left off
          await this.uploadChunks(uploadData.file, uploadId);
        }
      }

      async deleteUpload(uploadId) {
        try {
          await apiFetch(`/upload/${uploadId}`, {
            method: 'DELETE'
          });

          // Remove from active uploads
          this.activeUploads.delete(uploadId);

          // Remove from UI
          removeFileFromUI(uploadId);
        } catch (err) {
          console.error('Delete upload failed:', err);

          let errorMessage = "Delete failed. Please try again.";
          if (err.message.includes('fetch') || err.message.includes('network')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
          } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
            errorMessage = "Session expired. Please refresh the page and log in again.";
          } else if (err.message.includes('404')) {
            errorMessage = "File not found. It may have already been deleted.";
          }

          try {
            alert(errorMessage);
          } catch (alertError) {
            console.warn('Alert blocked, delete upload error message:', errorMessage);
          }
        }
      }

      updateProgress(uploadId, progress) {
        const fileElement = document.querySelector(`[data-upload-id="${uploadId}"]`);
        if (fileElement) {
          const progressBar = fileElement.querySelector('.nb-progress-bar');
          const statusText = fileElement.querySelector('.nb-status-text');

          if (progressBar) {
            progressBar.style.width = `${progress}%`;
          }
          if (statusText) {
            statusText.textContent = progress === 100 ? 'Completed' : `Uploading... ${progress}%`;
          }
        }
      }

      updateStatus(uploadId, status, message) {
        const fileElement = document.querySelector(`[data-upload-id="${uploadId}"]`);
        if (fileElement) {
          const statusText = fileElement.querySelector('.nb-status-text');
          const pauseBtn = fileElement.querySelector('button[title="Pause"]');
          const resumeBtn = fileElement.querySelector('button[title="Resume"]');

          if (statusText) {
            statusText.textContent = message;
            statusText.className = `nb-status-text ${status === 'completed' ? 'nb-success' : status === 'failed' ? 'nb-error' : ''}`;
          }

          // Toggle pause/resume buttons
          if (pauseBtn && resumeBtn) {
            if (status === 'paused') {
              pauseBtn.style.display = 'none';
              resumeBtn.style.display = 'inline-flex';
            } else if (status === 'uploading') {
              pauseBtn.style.display = 'inline-flex';
              resumeBtn.style.display = 'none';
            } else if (status === 'completed' || status === 'failed') {
              pauseBtn.style.display = 'none';
              resumeBtn.style.display = 'none';
            }
          }

          if (status === 'completed') {
            fileElement.classList.add('nb-item-complete');

            // Update action buttons for completed upload
            const actionsContainer = fileElement.querySelector('.nb-file-actions');
            if (actionsContainer) {
              actionsContainer.innerHTML = `
                <button class="nb-action" title="Download" onclick="downloadFile('${uploadId}')">
                  <i class="fa-solid fa-download"></i>
                </button>
                <button class="nb-action" title="Share" onclick="shareFile('${uploadId}')">
                  <i class="fa-solid fa-share"></i>
                </button>
                <button class="nb-action" title="Delete" onclick="chunkedUploader.deleteUpload('${uploadId}')">
                  <i class="fa-solid fa-trash"></i>
                </button>
              `;
            }

            // Update global file state
            const uploadedFileInfo = {
              id: uploadId,
              name: uploadData.file.name,
              type: getFileTypeFromName(uploadData.file.name),
              size: uploadData.file.size,
              content: '', // Content will be extracted from the file later
              timestamp: new Date().toISOString()
            };

            uploadedFiles.push(uploadedFileInfo);
            currentUploadedFile = uploadedFileInfo;

            // Show success popup
            showUploadSuccessPopup(uploadData.file.name);

            // Add to recent files
            if (window.nbFileManager) {
              window.nbFileManager.addRecentFile({
                id: uploadId,
                name: uploadData.file.name,
                type: getFileTypeFromName(uploadData.file.name),
                size: uploadData.file.size,
                timestamp: new Date().toISOString(),
                content: '',
                source: 'upload'
              });
            }
          }
        }
      }
    }

    // Download file function
    async function downloadFile(uploadId) {
      try {
        // Create download link to backend endpoint
        const link = document.createElement('a');
        link.href = `${API_BASE_URL}/upload/${uploadId}/download`;
        link.style.display = 'none';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (err) {
        console.error('Download failed:', err);

        let errorMessage = "Download failed. Please try again.";
        if (err.message.includes('fetch') || err.message.includes('network')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
        } else if (err.message.includes('404')) {
          errorMessage = "File not found. It may have been deleted.";
        }

        try {
          alert(errorMessage);
        } catch (alertError) {
          console.warn('Alert blocked, download error message:', errorMessage);
        }
      }
    }

    // Share file function
    async function shareFile(uploadId) {
      try {
        // Get file info
        const uploadInfo = await apiFetch(`/upload/${uploadId}/progress`);
        const fileUrl = `${window.location.origin}/upload/${uploadId}/download`;
        const fileName = uploadInfo.fileName;

        // Try native share API first
        if (navigator.share) {
          await navigator.share({
            title: `Shared File: ${fileName}`,
            text: `Check out this file: ${fileName}`,
            url: fileUrl
          });
        } else {
          // Fallback: copy link to clipboard
          await navigator.clipboard.writeText(fileUrl);
          showNotification('File link copied to clipboard!', 'success');
        }
      } catch (err) {
        console.error('Share failed:', err);

        let errorMessage = "Sharing failed. Please try again.";
        if (err.message.includes('fetch') || err.message.includes('network')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (err.message.includes('No authentication token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
        } else if (err.message.includes('404')) {
          errorMessage = "File not found. It may have been deleted.";
        }

        // Fallback for older browsers
        try {
          const fileUrl = `${window.location.origin}/upload/${uploadId}/download`;
          await navigator.clipboard.writeText(fileUrl);
          try {
            alert(`File link copied to clipboard!\n\n${fileUrl}`);
          } catch (alertError) {
            console.warn('Alert blocked, share success message:', `File link copied to clipboard!\n\n${fileUrl}`);
          }
        } catch (clipboardErr) {
          showNotification('Sharing not supported on this browser. Please copy the URL manually.', 'warning');
        }
      }
    }

    // Initialize uploader
    const chunkedUploader = new ChunkedUploader();

    // Helper functions for file type recognition
    function getFileTypeFromName(fileName) {
      if (!fileName) return 'file';
      const extension = fileName.split('.').pop().toLowerCase();
      const typeMap = {
        'pdf': 'pdf',
        'doc': 'word',
        'docx': 'word',
        'txt': 'text',
        'jpg': 'image',
        'jpeg': 'image',
        'png': 'image',
        'gif': 'image',
        'ppt': 'powerpoint',
        'pptx': 'powerpoint',
        'xls': 'excel',
        'xlsx': 'excel'
      };
      return typeMap[extension] || 'file';
    }

    // Additional helper functions
    function getFileIcon(fileName) {
      const type = getFileTypeFromName(fileName);
      const iconMap = {
        'pdf': 'pdf',
        'docx': 'word',
        'txt': 'lines',
        'pptx': 'powerpoint',
        'xlsx': 'excel',
        'image': 'image',
        'document': 'file',
        'file': 'file'
      };
      return iconMap[type] || 'file';
    }

    function getFileTypeLabel(fileName) {
      const type = getFileTypeFromName(fileName);
      const labelMap = {
        'pdf': 'PDF',
        'docx': 'Word Document',
        'txt': 'Text File',
        'pptx': 'PowerPoint',
        'xlsx': 'Excel',
        'image': 'Image',
        'document': 'Document',
        'file': 'File'
      };
      return labelMap[type] || 'FILE';
    }

    function getFileIconClass(fileType) {
      const iconMap = {
        'pdf': 'fa-file-pdf',
        'word': 'fa-file-word',
        'text': 'fa-file-lines',
        'image': 'fa-file-image',
        'powerpoint': 'fa-file-powerpoint',
        'excel': 'fa-file-excel',
        'file': 'fa-file'
      };
      return iconMap[fileType] || 'fa-file';
    }

    // Helper functions for file type recognition
    function getFileIcon(mimeType) {
      if (!mimeType) return 'lines';

      if (mimeType.includes('pdf')) return 'pdf';
      if (mimeType.includes('word') || mimeType.includes('document')) return 'word';
      if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'powerpoint';
      if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'excel';
      if (mimeType.includes('image')) return 'image';
      if (mimeType.includes('text')) return 'lines';
      if (mimeType.includes('zip') || mimeType.includes('rar')) return 'archive';

      return 'lines';
    }

    function getFileTypeLabel(mimeType) {
      if (!mimeType) return 'FILE';

      if (mimeType.includes('pdf')) return 'PDF';
      if (mimeType.includes('word') || mimeType.includes('document')) return 'Word';
      if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'PowerPoint';
      if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'Excel';
      if (mimeType.includes('image')) return 'Image';
      if (mimeType.includes('text')) return 'Text';
      if (mimeType.includes('zip') || mimeType.includes('rar')) return 'Archive';

      return mimeType.split('/')[1]?.toUpperCase() || 'FILE';
    }

    // Upload file using chunked uploader
    async function uploadFile(file) {
      await chunkedUploader.uploadFile(file);
    }

    function addFileToUI(file, uploadId) {
      if (!fileListContainer) return;
      const item = document.createElement("div");
      item.className = "nb-file-item";
      item.dataset.fileName = file.name;
      item.dataset.uploadId = uploadId;
      item.innerHTML = `
      <div class="nb-file-info">
        <span class="nb-file-icon"><i class="fa-solid fa-file-${getFileIcon(file.type)}"></i></span>
        <div class="nb-file-details">
          <span class="nb-file-name">${file.name}</span>
          <span class="nb-file-meta">${getFileTypeLabel(file.type)} • ${formatFileSize(file.size)} • Just now</span>
        </div>
      </div>
      <div class="nb-file-status">
        <div class="nb-progress">
          <div class="nb-progress-bar" style="width:0%;"></div>
        </div>
        <span class="nb-status-text">Uploading...</span>
      </div>
      <div class="nb-file-actions">
        <button class="nb-action" title="Pause" onclick="chunkedUploader.pauseUpload('${uploadId}')">
          <i class="fa-solid fa-pause"></i>
        </button>
        <button class="nb-action" title="Resume" onclick="chunkedUploader.resumeUpload('${uploadId}')" style="display: none;">
          <i class="fa-solid fa-play"></i>
        </button>
        <button class="nb-action" title="Delete" onclick="chunkedUploader.deleteUpload('${uploadId}')">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    `;
      fileListContainer.appendChild(item);
    }

    function removeFileFromUI(uploadId) {
      if (!fileListContainer) return;
      const elem = fileListContainer.querySelector(
        `[data-upload-id="${uploadId}"]`
      );
      if (elem) elem.remove();
    }

    // Simple file size formatting
    function formatFileSize(bytes) {
      if (bytes === 0) return "0 B";
      const k = 1024,
        sizes = ["B", "KB", "MB", "GB", "TB"],
        i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    // Load uploaded notes from backend
    async function loadUploadedNotes(containerElement = null) {
      const targetContainer = containerElement || nbFileListContainer || fileListContainer;

      if (!targetContainer) return;

      try {
        const files = await apiFetch('/upload/notes');

        if (!files || files.length === 0) {
          targetContainer.innerHTML = `
            <div class="nb-empty-state">
              <i class="fa-solid fa-cloud-upload" style="font-size: 48px; color: #14807a; margin-bottom: 16px;"></i>
              <h4 style="color: #14807a; margin-bottom: 8px;">No Files Uploaded Yet</h4>
              <p style="color: #666; margin: 0;">Uploaded files will show here</p>
            </div>
          `;
          return;
        }

        // Update global file state with new database columns
        uploadedFiles = files.map(file => ({
          id: file.id,
          name: file.file_name || file.title || 'Untitled',
          type: file.file_type || getFileTypeFromName(file.title || ''),
          size: file.file_size || 0,
          content: file.ai_analysis || '',
          timestamp: file.created_at,
          isFavorite: file.is_favorite || false,
          folderId: file.folder_id || null
        }));

        // Set current file to the most recent one
        if (uploadedFiles.length > 0) {
          currentUploadedFile = uploadedFiles[uploadedFiles.length - 1];
        }

        // Render files with enhanced metadata
        targetContainer.innerHTML = files.map(file => {
          const fileName = file.file_name || file.title || 'Untitled';
          const fileType = file.file_type || getFileTypeFromName(fileName);
          const fileSize = file.file_size || 0;
          const formattedSize = fileSize > 0 ? formatFileSize(fileSize) : '';
          const isFavorite = file.is_favorite || false;

          return `
            <div class="nb-file-item ${isFavorite ? 'nb-favorite' : ''}" data-file-id="${file.id}">
              <div class="nb-file-info">
                <span class="nb-file-icon"><i class="fa-solid fa-file-${getFileIcon(fileType)}"></i></span>
                <div class="nb-file-details">
                  <span class="nb-file-name">${fileName}</span>
                  <span class="nb-file-meta">${fileType.toUpperCase()} ${formattedSize ? '• ' + formattedSize : ''} • Uploaded ${new Date(file.created_at).toLocaleDateString()}</span>
                </div>
              </div>
              <div class="nb-file-status">
                <span class="nb-status-text nb-success">${file.ai_analysis ? 'AI Processed' : 'Uploaded'}</span>
              </div>
              <div class="nb-file-actions">
                <button class="nb-action" title="View Details" onclick="viewFileDetails('${file.id}')">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button class="nb-action" title="Download" onclick="downloadFile('${file.id}')">
                  <i class="fa-solid fa-download"></i>
                </button>
                <button class="nb-action" title="Delete" onclick="deleteNote('${file.id}')">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Failed to load uploaded notes:', error);

        if (targetContainer) {
          targetContainer.innerHTML = `
            <div class="nb-empty-state">
              <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 16px;"></i>
              <h4 style="color: #dc3545; margin-bottom: 8px;">Failed to Load Files</h4>
              <p style="color: #666; margin: 0;">Please refresh the page to try again</p>
            </div>
          `;
        }

        showNotification('Failed to load uploaded files. Please refresh the page.', 'error');
      }
    }

    // Update upload notes display UI
    function updateUploadNotesDisplay(files) {
      const uploadZone = document.querySelector('.nb-upload-zone');
      const fileList = document.querySelector('.nb-uploaded-files');

      if (!uploadZone || !fileList) return;

      if (files && files.length > 0) {
        // Show uploaded files
        uploadZone.style.display = 'none';
        fileList.style.display = 'block';

        fileList.innerHTML = files.map(file => `
          <div class="nb-uploaded-file">
            <div class="nb-file-icon">
              <i class="fa-solid fa-file-${getFileIcon(file.type)}"></i>
            </div>
            <div class="nb-file-info">
              <div class="nb-file-name">${file.name}</div>
              <div class="nb-file-size">${formatFileSize(file.size)}</div>
            </div>
            <div class="nb-file-status">
              <span class="nb-status-text">Ready for upload</span>
            </div>
          </div>
        `).join('');
      } else {
        // Show upload zone
        uploadZone.style.display = 'block';
        fileList.style.display = 'none';
      }
    }

    // View file details
    function viewFileDetails(fileId) {
      // Find file in uploadedFiles array
      const file = uploadedFiles.find(f => f.id === fileId);
      if (!file) {
        showNotification('File not found', 'error');
        return;
      }

      // Show file details in a modal or popup
      const detailsModal = document.createElement('div');
      detailsModal.className = 'ai-result-modal';
      detailsModal.innerHTML = `
        <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
        <div class="ai-result-content">
          <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
          <h3>File Details</h3>
          <div class="file-details">
            <p><strong>Name:</strong> ${file.name}</p>
            <p><strong>Type:</strong> ${file.type}</p>
            <p><strong>Uploaded:</strong> ${new Date(file.timestamp).toLocaleString()}</p>
            <p><strong>Content:</strong></p>
            <div class="file-content">${file.content || 'No content available'}</div>
          </div>
        </div>
      `;
      document.body.appendChild(detailsModal);
    }

    // Simulate AI processing progress bar for uploaded file
    let fakeProgress = {};
    let fakeIntervals = {};
    function simulateAiProcessing(fileName) {
      const elem = fileListContainer.querySelector(
        `[data-file-name="${fileName}"]`
      );
      if (!elem) return;
      const progressBar = elem.querySelector(".nb-progress-bar");
      const statusText = elem.querySelector(".nb-status-text");

      fakeIntervals[fileName] = setInterval(() => {
        if (fakeProgress[fileName] >= 100) {
          clearInterval(fakeIntervals[fileName]);
          statusText.textContent = "AI Processing Completed";
          progressBar.style.width = "100%";
          elem.classList.add("nb-item-complete");
          return;
        }
        fakeProgress[fileName] += Math.random() * 15;
        if (fakeProgress[fileName] > 100) fakeProgress[fileName] = 100;
        progressBar.style.width = `${fakeProgress[fileName]}%`;
        statusText.textContent = `AI Processing... ${Math.floor(
          fakeProgress[fileName]
        )}%`;
      }, 400);
    }
    function stopFakeProgress(fileName) {
      if (fakeIntervals[fileName]) {
        clearInterval(fakeIntervals[fileName]);
        const elem = fileListContainer.querySelector(
          `[data-file-name="${fileName}"]`
        );
        if (elem) {
          const statusText = elem.querySelector(".nb-status-text");
          statusText.textContent = "Processing Stopped";
          statusText.classList.add("nb-error");
        }
      }
    }


    async function deleteNote(noteId, containerElement = null) {
      if (!confirm("Delete this note?")) return;
      try {
        await fetch(`${API_BASE_URL}/upload/notes/${noteId}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${AUTH_TOKEN}` },
        });
        // Use the provided container element or default to nbFileListContainer
        const targetContainer = containerElement || nbFileListContainer || fileListContainer;
        await loadUploadedNotes(targetContainer);
      } catch (err) {
        console.error('Delete Note Error:', err);

        let errorMessage = "Delete failed. Please try again.";
        if (err.message.includes('fetch') || err.message.includes('network')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (err.message.includes('No authentication token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
        } else if (err.message.includes('404')) {
          errorMessage = "File not found. It may have already been deleted.";
        }

        handleError(new Error(errorMessage), 'Delete Note');
      }
    }

    // AI Summarize button example (from prompt input)
    const promptSendBtn = document.querySelector(".prompt-send");
    const promptInput = document.querySelector(".prompt-input");
    //   let customDropdownSelected = document.querySelector('.custom-dropdown-selected');

    promptSendBtn.addEventListener("click", async () => {
      const text = promptInput.value.trim();
      if (!text) {
        showNotification("Please enter a query or attach files", 'warning');
        return;
      }
      const source = customDropdownSelected.textContent.trim();
      let queryText = text;

      if (source === "Notes" || source === "Select Source") {
        // send to /ai/summarize endpoint
        try {
          promptSendBtn.disabled = true;
          promptSendBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
          const res = await apiFetch("/ai/summarize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: queryText }),
          });
          showNotification("Summary generated successfully!", 'success');
          // Display summary in a modal
          const summaryModal = document.createElement("div");
          summaryModal.className = "ai-result-modal";
          summaryModal.innerHTML = `
            <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
            <div class="ai-result-content">
              <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
              <div class="ai-result"><h3>Summary</h3><p>${res.summary}</p></div>
            </div>
          `;
          document.body.appendChild(summaryModal);
        } catch (err) {
          console.error('AI Summarize Error:', err);

          let errorMessage = "AI summarize failed. Please try again.";
          let notificationType = 'error';

          if (err.message.includes('fetch') || err.message.includes('network')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
          } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
            errorMessage = "Session expired. Please refresh the page and log in again.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service is currently unavailable') || err.message.includes('API key not configured')) {
            errorMessage = "AI service is currently unavailable. Please contact support to enable AI features.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service is temporarily busy') || err.message.includes('Rate limit exceeded')) {
            errorMessage = "AI service is temporarily busy. Please try again in a few minutes.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service configuration error')) {
            errorMessage = "AI service configuration error. Please contact support.";
            notificationType = 'warning';
          } else if (err.message.includes('Network connection issue')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
            notificationType = 'error';
          } else if (err.message) {
            errorMessage = err.message;
          }

          showNotification(errorMessage, notificationType);
        } finally {
          promptSendBtn.disabled = false;
          promptSendBtn.innerHTML = `<i class="fa-solid fa-paper-plane"></i>`;
        }
      } else {
        showNotification("AI for the selected source is coming soon.", 'info');
      }
    });

    // On load, fetch uploaded notes to list for Upload Notes section
    document.addEventListener("DOMContentLoaded", async () => {
      await loadUploadedNotes();

      // Load existing uploaded files into global state
      try {
        const notes = await apiFetch("/upload/notes");
        if (notes && notes.length > 0) {
          // Update global state with existing files
          uploadedFiles = notes.map(note => ({
            id: note.id,
            name: note.title,
            type: getFileTypeFromName(note.title),
            size: 0, // Size not stored in upload_notes table
            content: note.ai_analysis || '',
            timestamp: note.created_at
          }));

          // Set current file to the most recent one
          if (uploadedFiles.length > 0) {
            currentUploadedFile = uploadedFiles[uploadedFiles.length - 1];
          }
        }
      } catch (err) {
        console.log('No existing uploaded files found or failed to load:', err.message);

        // Show user-friendly message if it's a network/database error
        if (err.message.includes('Failed to load recent uploads')) {
          showNotification('Unable to load your uploaded files. Please refresh the page to try again.', 'warning');
        }
      }
    });

    // Upload Notes Processing Options
    document.addEventListener("click", async (e) => {
      const processBtn = e.target.closest(".process-btn");
      if (!processBtn || processBtn.classList.contains("disabled")) return;

      const action = processBtn.dataset.action;
      const uploadedNotes = document.querySelectorAll(".upload-notes .nb-file-item");

      if (uploadedNotes.length === 0) {
        showNotification("Please upload a document first", 'warning');
        return;
      }

      // Get the most recent uploaded note
      const recentNote = uploadedNotes[0];
      const noteTitle = recentNote.querySelector(".nb-file-name")?.textContent || "Uploaded Document";

      try {
        processBtn.disabled = true;
        processBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Processing...`;

        let endpoint = "";
        let requestData = {};
        let resultTitle = "";

        switch (action) {
          case "summarize":
            endpoint = "/ai/summarize";
            requestData = { text: "Sample text from uploaded document" }; // This should be extracted from the actual file
            resultTitle = "Document Summary";
            break;
          case "questions":
            endpoint = "/mcq";
            requestData = {
              source_text: "Sample text from uploaded document",
              question_count: 5,
              difficulty: "intermediate"
            };
            resultTitle = "Generated Questions";
            break;
          case "mind-map":
            endpoint = "/notes-breakdown/mind-map";
            requestData = { text: "Sample text from uploaded document", title: "Document Mind Map" };
            resultTitle = "Mind Map";
            break;
          case "flashcards":
            endpoint = "/notes-breakdown/flashcards";
            requestData = { text: "Sample text from uploaded document", count: 10, title: "Flashcards" };
            resultTitle = "Flashcards";
            break;
          case "study-guide":
            endpoint = "/notes-breakdown/study-guide";
            requestData = { text: "Sample text from uploaded document", title: "Study Guide" };
            resultTitle = "Study Guide";
            break;
          case "extract-keywords":
            endpoint = "/ai/summarize"; // Using summarize as placeholder for keyword extraction
            requestData = { text: "Sample text from uploaded document" };
            resultTitle = "Extracted Keywords";
            break;
          case "notes-to-pdf":
          case "pdf-to-docs":
            alert(`${action.replace('-', ' ').toUpperCase()} conversion feature coming soon!`);
            return;
          default:
            alert("Processing option not implemented yet");
            return;
        }

        const response = await apiFetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestData),
        });

        // Display result
        let resultHtml = "";
        if (action === "summarize" || action === "extract-keywords") {
          resultHtml = `<div class="ai-result"><h3>${resultTitle}</h3><p>${response.summary || response}</p></div>`;
        } else if (action === "questions") {
          const mcqs = response.generated_mcqs || [];
          resultHtml = `<div class="ai-result"><h3>${resultTitle} (${mcqs.length})</h3>`;
          mcqs.slice(0, 3).forEach((mcq, index) => {
            resultHtml += `<div class="mcq-item"><strong>${index + 1}.</strong> ${mcq.question}</div>`;
          });
          resultHtml += "</div>";
        } else if (action === "mind-map") {
          resultHtml = `<div class="ai-result"><h3>${resultTitle}</h3><pre>${JSON.stringify(response.mind_map, null, 2)}</pre></div>`;
        } else if (action === "flashcards") {
          const flashcards = response.flashcards || [];
          resultHtml = `<div class="ai-result"><h3>${resultTitle} (${flashcards.length})</h3>`;
          flashcards.slice(0, 3).forEach((card, index) => {
            resultHtml += `<div class="flashcard"><strong>Q${index + 1}:</strong> ${card.question}<br><strong>A:</strong> ${card.answer}</div>`;
          });
          resultHtml += "</div>";
        } else if (action === "study-guide") {
          resultHtml = `<div class="ai-result"><h3>${resultTitle}</h3><div>${response.study_guide?.replace(/\n/g, '<br>') || response}</div></div>`;
        }

        // Create result modal
        const resultModal = document.createElement("div");
        resultModal.className = "ai-result-modal";
        resultModal.innerHTML = `
          <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
          <div class="ai-result-content">
            <button class="ai-result-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            ${resultHtml}
          </div>
        `;
        document.body.appendChild(resultModal);

      } catch (err) {
        console.error(`${action} Processing Error:`, err);

        let errorMessage = `${action.replace('-', ' ').toUpperCase()} failed. Please try again.`;
        let notificationType = 'error';

        if (err.message.includes('fetch') || err.message.includes('network')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (err.message.includes('No authentication token') || err.message.includes('Invalid or expired token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
          notificationType = 'warning';
        } else if (err.message.includes('404')) {
          errorMessage = "Service not found. Please try again later.";
        } else if (err.message.includes('AI service is currently unavailable') || err.message.includes('API key not configured')) {
          errorMessage = "AI service is currently unavailable. Please contact support to enable AI features.";
          notificationType = 'warning';
        } else if (err.message.includes('AI service is temporarily busy') || err.message.includes('Rate limit exceeded')) {
          errorMessage = "AI service is temporarily busy. Please try again in a few minutes.";
          notificationType = 'warning';
        } else if (err.message.includes('AI service configuration error')) {
          errorMessage = "AI service configuration error. Please contact support.";
          notificationType = 'warning';
        } else if (err.message.includes('Network connection issue')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
          notificationType = 'error';
        } else if (err.message) {
          errorMessage = err.message;
        }

        showNotification(errorMessage, notificationType);
      } finally {
        processBtn.disabled = false;
        const icon = processBtn.querySelector("i")?.className || "fa-solid fa-wand-magic-sparkles";
        const text = processBtn.querySelector("span")?.textContent || "Process";
        processBtn.innerHTML = `<i class="${icon}"></i><span>${text}</span><small>${processBtn.querySelector("small")?.textContent || ""}</small>`;
      }
    });

    // AI Images Generation
    const aiImgGenerateBtn = document.querySelector(".ai-img-generate-btn");
    const aiImgInput = document.querySelector(".ai-img-input");
    const aiImgPreviewArea = document.querySelector(".ai-img-preview-area");
    const aiImgOptions = document.querySelectorAll(".ai-img-option");
    const aiImgHistoryGrid = document.querySelector(".ai-img-grid");

    // Handle AI Image option selection
    aiImgOptions.forEach(option => {
      option.addEventListener("click", () => {
        aiImgOptions.forEach(opt => opt.classList.remove("active"));
        option.classList.add("active");

        // Update prompt placeholder based on selected type
        const type = option.querySelector(".ai-img-option-label i").className.includes("diagram-project") ? "flowchart" :
                    option.querySelector(".ai-img-option-label i").className.includes("chart-column") ? "diagram" :
                    option.querySelector(".ai-img-option-label i").className.includes("mind-share") ? "mind-map" : "infographic";

        const placeholders = {
          flowchart: "E.g., Generate a flowchart showing the software development lifecycle",
          diagram: "E.g., Create a technical diagram of a computer network architecture",
          "mind-map": "E.g., Generate a mind map for learning programming concepts",
          infographic: "E.g., Create an infographic about renewable energy sources"
        };

        if (aiImgInput) {
          aiImgInput.placeholder = placeholders[type] || "E.g., Generate a flowchart showing the water cycle process";
        }
      });
    });

    // Load user's AI images history
    async function loadAIImagesHistory() {
      try {
        const images = await apiFetch("/ai-images");
        if (aiImgHistoryGrid && images.length > 0) {
          aiImgHistoryGrid.innerHTML = images.slice(0, 4).map(img => `
            <div class="ai-img-thumbnail" onclick="loadImageToPreview('${img.image_url}', '${img.prompt}')">
              <img src="${img.image_url}" alt="${img.prompt}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
              <div class="ai-img-thumbnail-overlay">
                <small>${img.prompt.substring(0, 30)}...</small>
              </div>
            </div>
          `).join('');
        }
      } catch (err) {
        console.error("Failed to load AI images history:", err);

        let errorMessage = "Failed to load AI images history. Please refresh the page.";
        if (err.message.includes('fetch') || err.message.includes('network')) {
          errorMessage = "Network connection issue. Please check your internet connection.";
        } else if (err.message.includes('No authentication token')) {
          errorMessage = "Session expired. Please refresh the page and log in again.";
        }

        try {
          alert(errorMessage);
        } catch (alertError) {
          console.warn('Alert blocked, load AI images error message:', errorMessage);
        }
      }
    }

    // Load image to preview area
    function loadImageToPreview(imageUrl, prompt) {
      if (aiImgPreviewArea) {
        aiImgPreviewArea.innerHTML = `
          <div class="ai-img-preview-image">
            <img src="${imageUrl}" alt="Generated Image" style="max-width: 100%; border-radius: 8px;">
          </div>
        `;

        // Update actions
        const downloadBtn = document.querySelector(".ai-img-action-btn:nth-child(1)");
        const shareBtn = document.querySelector(".ai-img-action-btn:nth-child(2)");
        const saveBtn = document.querySelector(".ai-img-action-btn:nth-child(3)");

        if (downloadBtn) {
          downloadBtn.onclick = () => {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `ai-generated-image-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };
        }

        if (shareBtn) {
          shareBtn.onclick = () => {
            if (navigator.share) {
              navigator.share({
                title: 'AI Generated Image',
                text: prompt,
                url: imageUrl
              });
            } else {
              navigator.clipboard.writeText(imageUrl);
              showNotification("Image URL copied to clipboard!", 'success');
            }
          };
        }

        if (saveBtn) {
          saveBtn.onclick = () => alert("Image already saved to your library!");
        }
      }
    }

    if (aiImgGenerateBtn && aiImgInput && aiImgPreviewArea) {
      aiImgGenerateBtn.addEventListener("click", async () => {
        const prompt = aiImgInput.value.trim();
        if (!prompt) {
          showNotification("Please enter a prompt for the image", 'warning');
          return;
        }

        // Get selected type
        const activeOption = document.querySelector(".ai-img-option.active");
        const type = activeOption ? (
          activeOption.querySelector(".ai-img-option-label i").className.includes("diagram-project") ? "flowchart" :
          activeOption.querySelector(".ai-img-option-label i").className.includes("chart-column") ? "diagram" :
          activeOption.querySelector(".ai-img-option-label i").className.includes("mind-share") ? "mind-map" : "infographic"
        ) : "diagram";

        const style = document.querySelector(".ai-img-style-btn.active")?.dataset.style || "modern";

        try {
          aiImgGenerateBtn.disabled = true;
          aiImgGenerateBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Generating...`;

          const response = await apiFetch("/ai-images/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, style, type }),
          });

          // Display the generated image
          aiImgPreviewArea.innerHTML = `
            <div class="ai-img-preview-image">
              <img src="${response.image_url}" alt="Generated Image" style="max-width: 100%; border-radius: 8px;">
            </div>
          `;

          // Update actions
          const downloadBtn = document.querySelector(".ai-img-action-btn:nth-child(1)");
          const shareBtn = document.querySelector(".ai-img-action-btn:nth-child(2)");
          const saveBtn = document.querySelector(".ai-img-action-btn:nth-child(3)");

          if (downloadBtn) {
            downloadBtn.onclick = () => {
              const link = document.createElement('a');
              link.href = response.image_url;
              link.download = `ai-generated-${type}-${Date.now()}.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            };
          }

          if (shareBtn) {
            shareBtn.onclick = () => {
              if (navigator.share) {
                navigator.share({
                  title: 'AI Generated Image',
                  text: prompt,
                  url: response.image_url
                });
              } else {
                navigator.clipboard.writeText(response.image_url);
                showNotification("Image URL copied to clipboard!", 'success');
              }
            };
          }

          if (saveBtn) {
            saveBtn.onclick = () => {
              showNotification("Image saved to library!", 'success');
              loadAIImagesHistory(); // Refresh history
            };
          }

          // Clear input after successful generation
          aiImgInput.value = "";

        } catch (err) {
          console.error('AI Image Generation Error:', err);

          let errorMessage = "Image generation failed. Please try again.";
          let notificationType = 'error';

          if (err.message.includes('fetch') || err.message.includes('network')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
          } else if (err.message.includes('No authentication token')) {
            errorMessage = "Session expired. Please refresh the page and log in again.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service is currently unavailable') || err.message.includes('API key not configured')) {
            errorMessage = "AI service is currently unavailable. Please contact support to enable AI features.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service is temporarily busy') || err.message.includes('Rate limit exceeded')) {
            errorMessage = "AI service is temporarily busy. Please try again in a few minutes.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service configuration error')) {
            errorMessage = "AI service configuration error. Please contact support.";
            notificationType = 'warning';
          } else if (err.message.includes('Network connection issue')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
            notificationType = 'error';
          } else if (err.message) {
            errorMessage = err.message;
          }

          showNotification(errorMessage, notificationType);

          aiImgPreviewArea.innerHTML = `
            <div class="ai-img-preview-placeholder">
              <i class="fa-solid fa-exclamation-triangle"></i>
              <p>Generation failed. Please try again.</p>
            </div>
          `;
        } finally {
          aiImgGenerateBtn.disabled = false;
          aiImgGenerateBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> Generate Image`;
        }
      });
    }

    // Load history on page load
    document.addEventListener("DOMContentLoaded", function() {
      loadAIImagesHistory();
      initializeSearch();
    });

    // Search functionality
    let currentSearchType = 'all';
    let searchTimeout = null;

    function initializeSearch() {
      console.log('Initializing search functionality...');

      const searchTypeBtn = document.getElementById('searchTypeBtn');
      const searchTypeDropdown = document.getElementById('searchTypeDropdown');
      const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');

      console.log('Search elements found:', {
        searchTypeBtn: !!searchTypeBtn,
        searchTypeDropdown: !!searchTypeDropdown,
        searchInput: !!searchInput,
        searchBtn: !!searchBtn
      });

      // Search type dropdown toggle
      if (searchTypeBtn && searchTypeDropdown) {
        searchTypeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          searchTypeDropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!searchTypeBtn.contains(e.target) && !searchTypeDropdown.contains(e.target)) {
            searchTypeDropdown.classList.remove('show');
          }
        });

        // Search type selection
        const searchOptions = searchTypeDropdown.querySelectorAll('.search-type-option');
        searchOptions.forEach(option => {
          option.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const icon = this.querySelector('i').outerHTML;
            const text = this.querySelector('span').textContent;

            // Update button
            searchTypeBtn.innerHTML = `${icon}<span>${text}</span><i class="fa-solid fa-chevron-down"></i>`;

            // Update active state
            searchOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');

            // Update current search type
            currentSearchType = type;

            // Close dropdown
            searchTypeDropdown.classList.remove('show');

            // Perform search if there's a query
            const query = searchInput.value.trim();
            if (query) {
              performSearch(query, type);
            }
          });
        });
      }

      // Search input handler
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const query = this.value.trim();

          // Clear previous timeout
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }

          if (query.length === 0) {
            clearSearchResults();
            return;
          }

          // Debounce search
          searchTimeout = setTimeout(() => {
            performSearch(query, currentSearchType);
          }, 300);
        });

        // Search on Enter key
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
              performSearch(query, currentSearchType);
            }
          }
        });
      }

      // Search button handler
      if (searchBtn) {
        searchBtn.addEventListener('click', function() {
          const query = searchInput.value.trim();
          if (query) {
            performSearch(query, currentSearchType);
          }
        });
      }
    }

    async function performSearch(query, type) {
      console.log('Performing search:', { query, type });

      try {
        showSearchLoading();

        let results = [];

        if (type === 'all') {
          // Search all types
          const [filesRes, questionsRes, imagesRes, notesRes, dictionaryRes, uploadsRes] = await Promise.allSettled([
            apiFetch(`/files/search?q=${encodeURIComponent(query)}`).catch(() => []),
            apiFetch(`/questions/search?q=${encodeURIComponent(query)}`).catch(() => []),
            apiFetch(`/ai-images/search?q=${encodeURIComponent(query)}`).catch(() => []),
            apiFetch(`/notes/search?q=${encodeURIComponent(query)}`).catch(() => []),
            apiFetch(`/dictionary/search?q=${encodeURIComponent(query)}`).catch(() => []),
            apiFetch(`/uploads/notes/search?q=${encodeURIComponent(query)}`).catch(() => [])
          ]);

          // Combine results
          if (filesRes.status === 'fulfilled' && Array.isArray(filesRes.value)) {
            results.push(...filesRes.value.map(item => ({ ...item, type: 'file' })));
          }
          if (questionsRes.status === 'fulfilled' && Array.isArray(questionsRes.value)) {
            results.push(...questionsRes.value.map(item => ({ ...item, type: 'question' })));
          }
          if (imagesRes.status === 'fulfilled' && Array.isArray(imagesRes.value)) {
            results.push(...imagesRes.value.map(item => ({ ...item, type: 'image' })));
          }
          if (notesRes.status === 'fulfilled' && Array.isArray(notesRes.value)) {
            results.push(...notesRes.value.map(item => ({ ...item, type: 'note' })));
          }
          if (dictionaryRes.status === 'fulfilled' && Array.isArray(dictionaryRes.value)) {
            results.push(...dictionaryRes.value.map(item => ({ ...item, type: 'dictionary' })));
          }
          if (uploadsRes.status === 'fulfilled' && Array.isArray(uploadsRes.value)) {
            results.push(...uploadsRes.value.map(item => ({ ...item, type: 'upload' })));
          }
        } else {
          // Search specific type
          let endpoint = '';
          switch (type) {
            case 'files': endpoint = '/files/search'; break;
            case 'questions': endpoint = '/questions/search'; break;
            case 'images': endpoint = '/ai-images/search'; break;
            case 'notes': endpoint = '/notes/search'; break;
            case 'dictionary': endpoint = '/dictionary/search'; break;
            case 'uploads': endpoint = '/uploads/notes/search'; break;
          }

          if (endpoint) {
            try {
              results = await apiFetch(`${endpoint}?q=${encodeURIComponent(query)}`);
              if (Array.isArray(results)) {
                results = results.map(item => ({ ...item, type }));
              } else {
                results = [];
              }
            } catch (endpointError) {
              console.warn(`Search failed for ${type}:`, endpointError.message);
              results = [];
            }
          }
        }

        displaySearchResults(results, query, type);
      } catch (error) {
        console.error('Search failed:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });

        if (error.message.includes('authentication') || error.message.includes('token')) {
          showAuthError();
        } else {
          showSearchError();
        }

        // Also log the error for debugging
        console.error('Search failed:', error);
      }
    }

    function showSearchLoading() {
      const workspace = document.querySelector('.workspace');
      let resultsContainer = document.querySelector('.search-results');

      if (!resultsContainer) {
        resultsContainer = document.createElement('div');
        resultsContainer.className = 'search-results';
        workspace.appendChild(resultsContainer);
      }

      resultsContainer.innerHTML = `
        <div class="search-loading">
          <i class="fa-solid fa-spinner"></i>
          <p>Searching...</p>
        </div>
      `;
    }

    function displaySearchResults(results, query, type) {
      const workspace = document.querySelector('.workspace');
      let resultsContainer = document.querySelector('.search-results');

      if (!resultsContainer) {
        resultsContainer = document.createElement('div');
        resultsContainer.className = 'search-results';
        workspace.appendChild(resultsContainer);
      }

      if (results.length === 0) {
        resultsContainer.innerHTML = `
          <div class="search-no-results">
            <i class="fa-solid fa-search"></i>
            <h4>No results found</h4>
            <p>No items match your search for "${query}"</p>
          </div>
        `;
        return;
      }

      const typeLabel = type === 'all' ? 'All' : type.charAt(0).toUpperCase() + type.slice(1);

      resultsContainer.innerHTML = `
        <div class="search-results-header">
          <h3>Search Results for "${query}" in ${typeLabel}</h3>
        </div>
        <div class="search-results-list">
          ${results.map(result => createSearchResultItem(result)).join('')}
        </div>
      `;
    }

    function createSearchResultItem(result) {
      const icons = {
        file: 'fa-file',
        question: 'fa-question',
        image: 'fa-image',
        note: 'fa-sticky-note',
        dictionary: 'fa-book',
        upload: 'fa-file-lines'
      };

      const titles = {
        file: result.file_url || 'File',
        question: result.question_text || 'Question',
        image: result.prompt || 'AI Image',
        note: result.title || 'Note',
        dictionary: result.word || 'Word',
        upload: result.title || 'Uploaded Note'
      };

      const metas = {
        file: result.file_type || 'File',
        question: result.options ? `${result.options.length} options` : 'Question',
        image: result.style || 'AI Generated',
        note: result.content ? result.content.substring(0, 100) + '...' : 'Note',
        dictionary: result.meaning || 'Definition',
        upload: result.ai_analysis ? result.ai_analysis.substring(0, 100) + '...' : 'Uploaded file'
      };

      return `
        <div class="search-result-item" onclick="handleSearchResultClick('${result.type}', '${result.id}')">
          <div class="search-result-icon">
            <i class="fa-solid ${icons[result.type]}"></i>
          </div>
          <div class="search-result-content">
            <div class="search-result-title">${titles[result.type]}</div>
            <div class="search-result-meta">${metas[result.type]}</div>
            <span class="search-result-type">${result.type}</span>
          </div>
        </div>
      `;
    }

    function handleSearchResultClick(type, id) {
      // Navigate to the appropriate section based on type
      const links = {
        file: 'Upload Notes',
        question: 'My Questions',
        image: 'AI Images',
        note: 'Notes Breakdown',
        dictionary: 'My Dictionary',
        upload: 'Upload Notes'
      };

      const linkText = links[type];
      if (linkText) {
        // Find and click the corresponding sidebar link
        const sidebarLinks = document.querySelectorAll('.sidebar-nav ul li ul li a');
        sidebarLinks.forEach(link => {
          if (link.textContent.trim().replace('Beta', '').trim() === linkText) {
            link.click();
          }
        });
      }
    }

    function clearSearchResults() {
      const resultsContainer = document.querySelector('.search-results');
      if (resultsContainer) {
        resultsContainer.remove();
      }
    }

    function showSearchError() {
      const workspace = document.querySelector('.workspace');
      let resultsContainer = document.querySelector('.search-results');

      if (!resultsContainer) {
        resultsContainer = document.createElement('div');
        resultsContainer.className = 'search-results';
        workspace.appendChild(resultsContainer);
      }

      resultsContainer.innerHTML = `
        <div class="search-no-results">
          <i class="fa-solid fa-exclamation-triangle"></i>
          <h4>Search failed</h4>
          <p>Please try again later</p>
        </div>
      `;
    }

    function showAuthError() {
      const workspace = document.querySelector('.workspace');
      let resultsContainer = document.querySelector('.search-results');

      if (!resultsContainer) {
        resultsContainer = document.createElement('div');
        resultsContainer.className = 'search-results';
        workspace.appendChild(resultsContainer);
      }

      resultsContainer.innerHTML = `
        <div class="search-no-results">
          <i class="fa-solid fa-lock"></i>
          <h4>Authentication Required</h4>
          <p>Please log in to use the search functionality</p>
          <button onclick="window.location.href='signin.html'" style="background: #14807a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
            Go to Login
          </button>
        </div>
      `;
    }

    // MCQ Generator Enhanced Features
    const mcqGenerateBtn = document.querySelector(".mcq-generate-btn");
    const mcqInput = document.querySelector(".mcq-input");
    const mcqOutputSection = document.querySelector(".mcq-output-section");
    const mcqList = document.querySelector(".mcq-list");

    // MCQ Generation
    if (mcqGenerateBtn && mcqInput) {
      mcqGenerateBtn.addEventListener("click", async () => {
        const text = mcqInput.value.trim();
        if (!text) {
          showNotification("Please enter text content for MCQ generation", 'warning');
          return;
        }

        const questionCount = document.querySelector(".mcq-control-input[type='number']")?.value || 10;
        const difficulty = document.querySelector(".mcq-control-input:nth-of-type(2)")?.value || "intermediate";
        const style = document.querySelector(".mcq-control-input:nth-of-type(3)")?.value || "conceptual";

        try {
          mcqGenerateBtn.disabled = true;
          mcqGenerateBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Generating...`;

          const response = await apiFetch("/mcq", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              source_text: text,
              question_count: parseInt(questionCount),
              difficulty,
              style
            }),
          });

          const mcqs = response.generated_mcqs || [];

          // Display generated MCQs
          displayMCQs(mcqs);

          // Update stats
          updateMCQStats(mcqs);

          // Save to recent files
          if (window.nbFileManager && mcqs.length > 0) {
            window.nbFileManager.addRecentFile({
              name: `MCQ Set (${questionCount} questions) - ${new Date().toLocaleDateString()}`,
              type: 'mcq',
              content: JSON.stringify(mcqs),
              source: 'mcq-generator'
            });
          }

        } catch (err) {
          console.error('MCQ Generation Error:', err);

          let errorMessage = "MCQ generation failed. Please try again.";
          let notificationType = 'error';

          if (err.message.includes('fetch') || err.message.includes('network')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
          } else if (err.message.includes('No authentication token')) {
            errorMessage = "Session expired. Please refresh the page and log in again.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service is currently unavailable') || err.message.includes('API key not configured')) {
            errorMessage = "AI service is currently unavailable. Please contact support to enable AI features.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service is temporarily busy') || err.message.includes('Rate limit exceeded')) {
            errorMessage = "AI service is temporarily busy. Please try again in a few minutes.";
            notificationType = 'warning';
          } else if (err.message.includes('AI service configuration error')) {
            errorMessage = "AI service configuration error. Please contact support.";
            notificationType = 'warning';
          } else if (err.message.includes('Network connection issue')) {
            errorMessage = "Network connection issue. Please check your internet connection.";
            notificationType = 'error';
          } else if (err.message) {
            errorMessage = err.message;
          }

          showNotification(errorMessage, notificationType);
        } finally {
          mcqGenerateBtn.disabled = false;
          mcqGenerateBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> Generate Questions`;
        }
      });
    }

    function displayMCQs(mcqs) {
      if (!mcqList) return;

      mcqList.innerHTML = mcqs.map((mcq, index) => `
        <li class="mcq-item">
          <div class="mcq-question">
            <span>${index + 1}.</span> ${mcq.question}
          </div>
          <ul class="mcq-answers">
            ${Object.entries(mcq.options).map(([key, value]) => `
              <li class="mcq-answer ${key === mcq.correct_answer ? 'correct' : ''}">
                <span class="mcq-answer-marker">${key.toUpperCase()}</span>
                <span>${value}</span>
              </li>
            `).join('')}
          </ul>
          <div class="mcq-explanation" style="display: none;">
            <strong>Explanation:</strong> ${mcq.explanation || 'No explanation provided'}
          </div>
        </li>
      `).join('');

      // Add click handlers for answers
      document.querySelectorAll(".mcq-answer").forEach(answer => {
        answer.addEventListener("click", function() {
          const parent = this.parentElement.parentElement;
          const explanation = parent.querySelector(".mcq-explanation");

          // Remove previous selections
          parent.querySelectorAll(".mcq-answer").forEach(a => a.classList.remove("selected"));

          // Mark as selected
          this.classList.add("selected");

          // Show explanation
          if (explanation) {
            explanation.style.display = "block";
          }
        });
      });
    }

    function updateMCQStats(mcqs) {
      const stats = document.querySelectorAll(".mcq-stat-value");
      if (stats.length >= 3) {
        stats[0].textContent = mcqs.length;
        stats[1].textContent = mcqs.length > 0 ? Object.keys(mcqs[0].options).length : 4;
        stats[2].textContent = "95%"; // Mock accuracy
      }
    }

    // MCQ Actions
    document.addEventListener("click", (e) => {
      if (e.target.closest(".mcq-action-btn.primary")) {
        // Start Practice Session
        const mcqItems = document.querySelectorAll(".mcq-item");
        if (mcqItems.length === 0) {
          alert("Please generate MCQs first");
          return;
        }

        // Hide all explanations initially
        document.querySelectorAll(".mcq-explanation").forEach(exp => exp.style.display = "none");
        document.querySelectorAll(".mcq-answer").forEach(ans => ans.classList.remove("selected"));

        showNotification("Practice session started! Click on answers to reveal explanations.", 'success');
      }

      if (e.target.closest(".mcq-action-btn:nth-child(1)")) {
        // Export as PDF
        showNotification("PDF export feature coming soon!", 'info');
      }

      if (e.target.closest(".mcq-action-btn:nth-child(2)")) {
        // Share
        const mcqText = Array.from(document.querySelectorAll(".mcq-item")).map((item, index) => {
          const question = item.querySelector(".mcq-question").textContent;
          const answers = Array.from(item.querySelectorAll(".mcq-answer")).map(ans =>
            ans.textContent.trim()
          ).join('\n');
          return `${index + 1}. ${question}\n${answers}`;
        }).join('\n\n');

        if (navigator.share) {
          navigator.share({
            title: 'Generated MCQs',
            text: mcqText
          });
        } else {
          navigator.clipboard.writeText(mcqText);
          showNotification("MCQs copied to clipboard!", 'success');
        }
      }
    });

    // Global variables for file selection and AI processing
    let selectedAIProcessingFiles = [];
    let currentAIProcessingType = '';

    // Search Interface Functions
    function openSearchInterface() {
      const modal = document.createElement('div');
      modal.className = 'ai-result-modal';
      modal.innerHTML = `
        <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
        <div class="ai-result-content" style="max-width: 600px;">
          <button class="ai-result-close" onclick="this.parentElement.remove()">&times;</button>
          <h3 style="color: #14807a; margin-bottom: 20px;">Search Notes Breakdown</h3>

          <div style="margin-bottom: 20px;">
            <input type="text" id="searchQuery" placeholder="Enter search terms..." style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
            <button id="performSearchBtn" style="padding: 10px 20px; background: #14807a; color: white; border: none; border-radius: 6px; cursor: pointer;">Search</button>
          </div>

          <div id="searchResults" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
        </div>
      `;

      document.body.appendChild(modal);

      // Add search functionality
      const searchBtn = modal.querySelector('#performSearchBtn');
      const searchInput = modal.querySelector('#searchQuery');

      searchBtn.addEventListener('click', () => performNotesSearch(searchInput.value, modal));
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          performNotesSearch(searchInput.value, modal);
        }
      });
    }

    async function performNotesSearch(query, modal) {
      if (!query.trim()) {
        showNotification('Please enter a search query', 'warning');
        return;
      }

      const searchBtn = modal.querySelector('#performSearchBtn');
      const searchResults = modal.querySelector('#searchResults');

      searchBtn.disabled = true;
      searchBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Searching...';
      searchResults.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i> Searching...</div>';

      try {
        const response = await apiFetch(`/notes-breakdown/search?q=${encodeURIComponent(query)}`);
        const results = response.results || [];

        if (results.length === 0) {
          searchResults.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
              <i class="fa-solid fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
              <h4>No results found</h4>
              <p>No notes match your search for "${query}"</p>
            </div>
          `;
        } else {
          searchResults.innerHTML = `
            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Found ${results.length} result${results.length > 1 ? 's' : ''}:</h4>
            ${results.map(result => `
              <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid #14807a;">
                <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-primary);">${result.title || 'Untitled'}</div>
                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">${result.content ? result.content.substring(0, 150) + '...' : 'No content'}</div>
                <div style="font-size: 0.8em; color: var(--text-muted);">Type: ${result.type || 'Unknown'} • ${result.timestamp ? new Date(result.timestamp).toLocaleDateString() : ''}</div>
              </div>
            `).join('')}
          `;
        }
      } catch (error) {
        console.error('Search failed:', error);
        searchResults.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc3545;">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h4>Search failed</h4>
            <p>Please try again later</p>
          </div>
        `;
      } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = 'Search';
      }
    }

    // Statistics Interface Functions
    function openStatisticsInterface() {
      const modal = document.createElement('div');
      modal.className = 'ai-result-modal';
      modal.innerHTML = `
        <div class="ai-result-overlay" onclick="this.parentElement.remove()"></div>
        <div class="ai-result-content" style="max-width: 700px;">
          <button class="ai-result-close" onclick="this.parentElement.remove()">&times;</button>
          <h3 style="color: #14807a; margin-bottom: 20px;">Notes Breakdown Statistics</h3>

          <div id="statsContent" style="margin-bottom: 20px;">
            <div style="text-align: center; padding: 40px;">
              <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>Loading statistics...</p>
            </div>
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer;">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      loadStatistics(modal);
    }

    async function loadStatistics(modal) {
      const statsContent = modal.querySelector('#statsContent');

      try {
        const response = await apiFetch('/notes-breakdown/statistics');
        const stats = response.statistics || {};

        statsContent.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #14807a; margin-bottom: 8px;">${stats.totalFiles || 0}</div>
              <div style="font-size: 0.9em; color: var(--text-secondary);">Total Files</div>
            </div>
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #14807a; margin-bottom: 8px;">${stats.processedFiles || 0}</div>
              <div style="font-size: 0.9em; color: var(--text-secondary);">AI Processed</div>
            </div>
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #14807a; margin-bottom: 8px;">${stats.totalSummaries || 0}</div>
              <div style="font-size: 0.9em; color: var(--text-secondary);">Summaries</div>
            </div>
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #14807a; margin-bottom: 8px;">${stats.totalMindMaps || 0}</div>
              <div style="font-size: 0.9em; color: var(--text-secondary);">Mind Maps</div>
            </div>
          </div>

          <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px;">
            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Recent Activity</h4>
            <div id="recentActivity" style="max-height: 200px; overflow-y: auto;">
              ${stats.recentActivity && stats.recentActivity.length > 0
                ? stats.recentActivity.map(activity => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                      <div>
                        <div style="font-weight: 500; color: var(--text-primary);">${activity.action}</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">${activity.fileName}</div>
                      </div>
                      <div style="font-size: 0.8em; color: var(--text-secondary);">${activity.timestamp ? new Date(activity.timestamp).toLocaleDateString() : ''}</div>
                    </div>
                  `).join('')
                : '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No recent activity</div>'
              }
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load statistics:', error);
        statsContent.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc3545;">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h4>Failed to load statistics</h4>
            <p>Please try again later</p>
          </div>
        `;
      }
    }

    // File Selector Popup Functions
    function openFileSelectorPopup(processingType) {
      currentAIProcessingType = processingType;
      selectedAIProcessingFiles = [];

      const popup = document.getElementById('fileSelectorPopup');
      const title = document.getElementById('fileSelectorTitle');
      const fileList = document.getElementById('fileList');

      // Update title based on processing type
      const titles = {
        'smart_summary': 'Select Files for Smart Summary',
        'mind_map': 'Select Files for Mind Map Generation',
        'study_guide': 'Select Files for Study Guide Creation',
        'flashcards': 'Select Files for Flashcard Generation',
        'key_points': 'Select Files for Key Points Extraction',
        'concept_map': 'Select Files for Concept Map Generation'
      };
      title.textContent = titles[processingType] || 'Select Files for AI Processing';

      // Show popup
      popup.classList.add('show');

      // Prevent background scrolling when modal is open
      document.body.style.overflow = 'hidden';

      // Add keyboard support for closing
      document.addEventListener('keydown', handleFileSelectorKeydown);

      // Load uploaded files
      loadUploadedFilesForSelection();
    }

    function closeFileSelectorPopup() {
      const popup = document.getElementById('fileSelectorPopup');
      popup.classList.remove('show');

      // Restore background scrolling
      document.body.style.overflow = '';

      // Remove keyboard event listener
      document.removeEventListener('keydown', handleFileSelectorKeydown);

      selectedAIProcessingFiles = [];
      currentAIProcessingType = '';

      // Reset any processing buttons
      resetAIProcessingButton();
    }

    function handleFileSelectorKeydown(event) {
      if (event.key === 'Escape') {
        closeFileSelectorPopup();
      }
    }

    async function loadUploadedFilesForSelection() {
      const fileList = document.getElementById('fileList');

      try {
        const files = await apiFetch('/upload/notes');

        if (!files || files.length === 0) {
          fileList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
              <i class="fa-solid fa-file-circle-xmark" style="font-size: 48px; margin-bottom: 16px;"></i>
              <h4>No uploaded files found</h4>
              <p>Please upload some files first to use AI processing features.</p>
            </div>
          `;
          return;
        }

        fileList.innerHTML = files.map(file => `
          <div class="file-item" onclick="toggleFileSelection('${file.id}')">
            <input type="checkbox" class="file-checkbox" id="file-${file.id}" onchange="toggleFileSelection('${file.id}')">
            <div class="file-info">
              <span class="file-name">${file.title || 'Untitled'}</span>
              <span class="file-meta">
                Uploaded: ${new Date(file.created_at).toLocaleDateString()}
                ${file.ai_analysis ? ' • AI Processed' : ' • Not Processed'}
              </span>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Failed to load uploaded files:', error);
        fileList.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h4>Failed to load files</h4>
            <p>Please try again later.</p>
          </div>
        `;
      }
    }

    function toggleFileSelection(fileId) {
      const checkbox = document.getElementById(`file-${fileId}`);
      const fileItem = checkbox.closest('.file-item');

      if (checkbox.checked) {
        selectedAIProcessingFiles.push(fileId);
        fileItem.classList.add('selected');
      } else {
        selectedAIProcessingFiles = selectedAIProcessingFiles.filter(id => id !== fileId);
        fileItem.classList.remove('selected');
      }

      // Update process button state
      const processBtn = document.getElementById('processSelectedFilesBtn');
      processBtn.disabled = selectedAIProcessingFiles.length === 0;
      processBtn.innerHTML = selectedAIProcessingFiles.length === 0
        ? '<i class="fa-solid fa-wand-magic-sparkles"></i> Process Selected Files'
        : `<i class="fa-solid fa-wand-magic-sparkles"></i> Process ${selectedAIProcessingFiles.length} File${selectedAIProcessingFiles.length > 1 ? 's' : ''}`;
    }

    async function processSelectedFiles() {
      if (selectedAIProcessingFiles.length === 0) {
        showNotification('Please select at least one file', 'warning');
        return;
      }

      closeFileSelectorPopup();

      // Show loading state in AI results popup
      const loadingContent = `
        <div class="ai-processing-loading">
          <i class="fa-solid fa-spinner fa-spin"></i>
          <span>Processing ${selectedAIProcessingFiles.length} file${selectedAIProcessingFiles.length > 1 ? 's' : ''}...</span>
        </div>
        <div style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 0.9em;">
          This may take a few moments depending on file size and complexity.
        </div>
      `;
      showAIResultsPopup(`Processing Files...`, loadingContent);

      try {
        // Get file contents
        const fileContents = [];
        for (const fileId of selectedAIProcessingFiles) {
          try {
            const fileData = await apiFetch(`/upload/notes/${fileId}`);
            if (fileData && fileData.ai_analysis) {
              fileContents.push({
                id: fileId,
                title: fileData.title || fileData.file_name || 'Untitled',
                content: fileData.ai_analysis,
                file_type: fileData.file_type || 'Unknown',
                created_at: fileData.created_at
              });
            }
          } catch (error) {
            console.error(`Failed to load file ${fileId}:`, error);
          }
        }

        if (fileContents.length === 0) {
          throw new Error('No valid file content found. Please ensure selected files have been processed by AI analysis.');
        }

        // Combine all file contents
        const combinedContent = fileContents.map(file =>
          `=== ${file.title} ===\n${file.content}`
        ).join('\n\n');

        // Process with AI based on selected type
        let endpoint = '';
        let requestData = { text: combinedContent };
        let resultTitle = '';
        let processingType = '';

        switch (currentAIProcessingType) {
          case 'smart_summary':
            endpoint = '/ai/summarize';
            resultTitle = 'Smart Summary';
            processingType = 'Smart Summary';
            break;
          case 'mind_map':
            endpoint = '/notes-breakdown/mind-map';
            requestData.title = 'Combined Mind Map';
            resultTitle = 'Mind Map';
            processingType = 'Mind Map';
            break;
          case 'study_guide':
            endpoint = '/notes-breakdown/study-guide';
            requestData.title = 'Combined Study Guide';
            resultTitle = 'Study Guide';
            processingType = 'Study Guide';
            break;
          case 'flashcards':
            endpoint = '/notes-breakdown/flashcards';
            requestData.count = Math.min(15, selectedAIProcessingFiles.length * 5);
            requestData.title = 'Combined Flashcards';
            resultTitle = 'Flashcards';
            processingType = 'Flash Cards';
            break;
          case 'key_points':
            endpoint = '/notes-breakdown/key-points';
            requestData.title = 'Key Points Extraction';
            resultTitle = 'Key Points';
            processingType = 'Key Points';
            break;
          case 'concept_map':
            endpoint = '/notes-breakdown/concept-map';
            requestData.title = 'Concept Map Generation';
            resultTitle = 'Concept Map';
            processingType = 'Concept Map';
            break;
          default:
            throw new Error('Unknown processing type');
        }

        const response = await apiFetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData),
        });

        // Format and display results with enhanced metadata
        let resultContent = '';

        // Add processing metadata header
        const processingTime = new Date().toLocaleString();
        resultContent += `
          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #14807a;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
              <div>
                <strong style="color: var(--text-primary);">Processing Type:</strong><br>
                <span style="color: var(--text-secondary);">${processingType}</span>
              </div>
              <div>
                <strong style="color: var(--text-primary);">Files Processed:</strong><br>
                <span style="color: var(--text-secondary);">${fileContents.length}</span>
              </div>
              <div>
                <strong style="color: var(--text-primary);">Generated:</strong><br>
                <span style="color: var(--text-secondary);">${processingTime}</span>
              </div>
            </div>
            <div>
              <strong style="color: var(--text-primary);">Source Files:</strong><br>
              <span style="color: var(--text-secondary); font-size: 0.9em;">${fileContents.map(f => f.title).join(', ')}</span>
            </div>
          </div>
        `;

        // Add the actual content based on processing type
        if (currentAIProcessingType === 'smart_summary') {
          resultContent += `<h3>📄 Smart Summary</h3><div style="line-height: 1.6; margin-bottom: 20px;">${response.summary}</div>`;
        } else if (currentAIProcessingType === 'mind_map') {
          resultContent += `<h3>🗺️ Mind Map</h3><pre style="white-space: pre-wrap; font-family: monospace; background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">${JSON.stringify(response.mind_map, null, 2)}</pre>`;
        } else if (currentAIProcessingType === 'study_guide') {
          resultContent += `<h3>📚 Study Guide</h3><div style="white-space: pre-wrap; line-height: 1.6; margin-bottom: 20px;">${response.study_guide}</div>`;
        } else if (currentAIProcessingType === 'flashcards') {
          const flashcards = response.flashcards || [];
          resultContent += `<h3>🎴 Flashcards (${flashcards.length})</h3>`;
          flashcards.forEach((card, index) => {
            resultContent += `<div class="flashcard" style="margin-bottom: 16px; padding: 16px; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid #14807a;">
              <div style="margin-bottom: 8px;"><strong style="color: #14807a;">Q${index + 1}:</strong> ${card.question}</div>
              <div><strong style="color: #14807a;">A:</strong> ${card.answer}</div>
            </div>`;
          });
        } else if (currentAIProcessingType === 'key_points') {
          const keyPoints = response.key_points || [];
          resultContent += `<h3>📝 Key Points (${keyPoints.length})</h3>`;
          keyPoints.forEach((point, index) => {
            resultContent += `<div style="margin-bottom: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid #14807a;">
              <strong style="color: #14807a;">${index + 1}.</strong> ${point}
            </div>`;
          });
        } else if (currentAIProcessingType === 'concept_map') {
          const conceptMap = response.concept_map || {};
          resultContent += `<h3>🗺️ Concept Map</h3>`;
          if (conceptMap.nodes && conceptMap.nodes.length > 0) {
            resultContent += `<div style="margin-bottom: 16px;"><strong style="color: #14807a;">Key Concepts:</strong></div>`;
            conceptMap.nodes.forEach((node, index) => {
              resultContent += `<div style="margin-bottom: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                <strong>${index + 1}.</strong> ${node}
              </div>`;
            });
          }
          if (conceptMap.relationships && conceptMap.relationships.length > 0) {
            resultContent += `<div style="margin-top: 16px; margin-bottom: 16px;"><strong style="color: #14807a;">Relationships:</strong></div>`;
            conceptMap.relationships.forEach((rel, index) => {
              resultContent += `<div style="margin-bottom: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                <strong>${index + 1}.</strong> ${rel}
              </div>`;
            });
          }
        }

        // Add save functionality section
        resultContent += `
          <div style="margin-top: 24px; padding: 16px; background: rgba(20, 128, 122, 0.1); border-radius: 8px; border: 1px solid rgba(20, 128, 122, 0.2);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <i class="fa-solid fa-save" style="color: #14807a;"></i>
              <strong style="color: var(--text-primary);">Save to Library</strong>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="text" id="saveResultTitle" placeholder="Enter a title for this result" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);" value="${resultTitle} - ${new Date().toLocaleDateString()}">
              <button onclick="saveAIResultToLibrary('${currentAIProcessingType}', '${processingTime}')" style="padding: 8px 16px; background: #14807a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                <i class="fa-solid fa-save"></i> Save
              </button>
            </div>
          </div>
        `;

        showAIResultsPopup(resultTitle, resultContent);

        // Reset button state on success
        resetAIProcessingButton();

      } catch (error) {
        console.error('AI processing error:', error);
        let errorMessage = 'AI processing failed. Please try again.';
        let showRetry = true;

        if (error.message.includes('timeout')) {
          errorMessage = 'AI processing timed out. Please try with fewer files or smaller content.';
        } else if (error.message.includes('network')) {
          errorMessage = 'Network error. Please check your connection and try again.';
        } else if (error.message.includes('No valid file content found')) {
          errorMessage = 'No valid file content found. Please ensure selected files have been processed by AI analysis.';
          showRetry = false;
        } else if (error.message.includes('AI service')) {
          errorMessage = 'AI service temporarily unavailable. Please try again later.';
        }

        const errorContent = `
          <div style="color: #dc3545; text-align: center; padding: 20px;">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h4>Processing Failed</h4>
            <p style="margin-bottom: 20px;">${errorMessage}</p>
            ${showRetry ? `
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="retryAIProcessing()" style="padding: 10px 20px; background: #14807a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                  <i class="fa-solid fa-rotate-right"></i> Try Again
                </button>
                <button onclick="closeAIResultsPopup()" style="padding: 10px 20px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 500;">
                  Cancel
                </button>
              </div>
            ` : `
              <button onclick="closeAIResultsPopup()" style="padding: 10px 20px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 500;">
                Close
              </button>
            `}
          </div>
        `;

        showAIResultsPopup('Processing Failed', errorContent);

        // Reset button state on error
        resetAIProcessingButton();
      }
    }

    // Upload Success Popup Functions
    function showUploadSuccessPopup(fileName, aiAnalysis) {
      // Remove any existing popup
      const existingPopup = document.querySelector('.upload-success-popup');
      if (existingPopup) existingPopup.remove();

      // Create popup element
      const popup = document.createElement('div');
      popup.className = 'upload-success-popup';

      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'upload-success-overlay';
      overlay.onclick = () => popup.remove();

      // Create content
      const content = document.createElement('div');
      content.className = 'upload-success-content';

      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'upload-success-close';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = () => popup.remove();
      content.appendChild(closeBtn);

      // Icon
      const icon = document.createElement('div');
      icon.className = 'upload-success-icon';
      icon.innerHTML = '<i class="fa-solid fa-check-circle"></i>';
      content.appendChild(icon);

      // Title
      const title = document.createElement('h3');
      title.textContent = 'Upload Successful!';
      content.appendChild(title);

      // Message
      const message = document.createElement('p');
      message.textContent = `"${fileName}" has been uploaded successfully.`;
      content.appendChild(message);

      // AI Analysis Section
      if (aiAnalysis && aiAnalysis.analysis_complete) {
        const analysisSection = document.createElement('div');
        analysisSection.className = 'upload-success-analysis';
        analysisSection.innerHTML = `
          <h4 style="color: #14807a; margin: 20px 0 12px 0; font-size: 1.1rem;">AI Analysis Results</h4>
          <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #14807a;">${aiAnalysis.processing_time || 'N/A'}</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Processing Time</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #14807a;">${aiAnalysis.word_count || 'N/A'}</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Word Count</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #14807a;">${aiAnalysis.key_points_count || 'N/A'}</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Key Points</div>
              </div>
            </div>
            ${aiAnalysis.summary ? `
              <div style="margin-bottom: 12px;">
                <strong style="color: var(--text-primary);">Summary:</strong>
                <p style="color: var(--text-secondary); margin: 8px 0; line-height: 1.5;">${aiAnalysis.summary}</p>
              </div>
            ` : ''}
            ${aiAnalysis.key_points && aiAnalysis.key_points.length > 0 ? `
              <div>
                <strong style="color: var(--text-primary);">Key Points:</strong>
                <ul style="color: var(--text-secondary); margin: 8px 0; padding-left: 20px;">
                  ${aiAnalysis.key_points.slice(0, 3).map(point => `<li style="margin-bottom: 4px;">${point}</li>`).join('')}
                  ${aiAnalysis.key_points.length > 3 ? `<li style="font-style: italic;">...and ${aiAnalysis.key_points.length - 3} more</li>` : ''}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
        content.appendChild(analysisSection);
      }

      // Actions
      const actions = document.createElement('div');
      actions.className = 'upload-success-actions';

      const viewBtn = document.createElement('button');
      viewBtn.className = 'upload-success-btn secondary';
      viewBtn.textContent = 'View File';
      viewBtn.onclick = () => {
        popup.remove();
        viewUploadedFile(fileName);
      };

      const closeBtn2 = document.createElement('button');
      closeBtn2.className = 'upload-success-btn primary';
      closeBtn2.textContent = 'Continue';
      closeBtn2.onclick = () => popup.remove();

      actions.appendChild(viewBtn);
      actions.appendChild(closeBtn2);
      content.appendChild(actions);

      // Assemble popup
      popup.appendChild(overlay);
      popup.appendChild(content);
      document.body.appendChild(popup);

      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (popup.parentElement) {
          popup.remove();
        }
      }, 10000);
    }

    // AI Results Popup Functions
    function showAIResultsPopup(title, content) {
      const popup = document.getElementById('aiResultsPopup');
      const titleElement = document.getElementById('aiResultsTitle');
      const bodyElement = document.getElementById('aiResultsBody');
      const actionsElement = document.getElementById('aiResultsActions');

      titleElement.textContent = title;
      bodyElement.innerHTML = content;

      // Update actions based on content type
      if (content.includes('Processing Failed')) {
        // Error state - actions are handled in the content
        actionsElement.style.display = 'none';
      } else {
        // Success state - show copy and close actions
        actionsElement.style.display = 'flex';
      }

      popup.classList.add('show');

      // Prevent background scrolling when modal is open
      document.body.style.overflow = 'hidden';

      // Add keyboard support for closing
      document.addEventListener('keydown', handleAIResultsKeydown);
    }

    function closeAIResultsPopup() {
      const popup = document.getElementById('aiResultsPopup');
      popup.classList.remove('show');

      // Restore background scrolling
      document.body.style.overflow = '';

      // Remove keyboard event listener
      document.removeEventListener('keydown', handleAIResultsKeydown);

      // Reset any processing states
      resetAIProcessingButton();
    }

    function handleAIResultsKeydown(event) {
      if (event.key === 'Escape') {
        closeAIResultsPopup();
      }
    }

    async function copyAIResults() {
      const bodyElement = document.getElementById('aiResultsBody');
      const copyBtn = document.getElementById('copyResultsBtn');

      try {
        // Get text content, removing HTML tags but preserving structure
        const textContent = bodyElement.innerText || bodyElement.textContent;

        await navigator.clipboard.writeText(textContent);

        // Visual feedback
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
        copyBtn.classList.add('copied');

        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
          copyBtn.classList.remove('copied');
        }, 2000);

        showNotification('Results copied to clipboard!', 'success');
      } catch (error) {
        console.error('Failed to copy:', error);
        showNotification('Failed to copy to clipboard', 'error');
      }
    }

    // Save AI Result to Library
    async function saveAIResultToLibrary(processingType, timestamp) {
      const titleInput = document.getElementById('saveResultTitle');
      const saveBtn = document.querySelector('button[onclick*="saveAIResultToLibrary"]');

      if (!titleInput || !titleInput.value.trim()) {
        showNotification('Please enter a title for the result', 'warning');
        return;
      }

      const title = titleInput.value.trim();
      const bodyElement = document.getElementById('aiResultsBody');

      try {
        // Disable save button
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        }

        // Get the content to save
        const contentToSave = bodyElement.innerText || bodyElement.textContent;

        // Create a formatted content with metadata
        const formattedContent = `AI Processing Result: ${processingType}
Generated: ${timestamp}
Title: ${title}

${contentToSave}`;

        // Save to library (you can implement this as a new file or add to existing file management)
        // For now, we'll add it to the recent files
        if (window.nbFileManager) {
          const fileId = await window.nbFileManager.addRecentFile({
            name: title,
            type: 'ai-result',
            content: formattedContent,
            source: `ai-${processingType}`,
            timestamp: new Date().toISOString()
          });

          showNotification(`"${title}" saved to your library!`, 'success');

          // Close the popup after successful save
          setTimeout(() => {
            closeAIResultsPopup();
          }, 1500);
        } else {
          showNotification('Unable to save: File manager not available', 'error');
        }

      } catch (error) {
        console.error('Failed to save AI result:', error);
        showNotification('Failed to save result to library', 'error');
      } finally {
        // Re-enable save button
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save';
        }
      }
    }

    // Retry AI Processing
    function retryAIProcessing() {
      if (selectedAIProcessingFiles.length > 0 && currentAIProcessingType) {
        // Re-run the processing
        processSelectedFiles();
      } else {
        showNotification('Unable to retry: No files selected', 'warning');
        closeAIResultsPopup();
      }
    }

    // Updated Notes Breakdown AI Features with file selector
    document.addEventListener("click", async (e) => {
      const featureCard = e.target.closest(".nb-feature-card");
      if (!featureCard) return;

      const action = featureCard.dataset.action;
      if (!action) return;

      // Handle special cases that don't need file selection
      if (action === 'search') {
        openSearchInterface();
        return;
      }

      if (action === 'statistics') {
        openStatisticsInterface();
        return;
      }

      // Apply processing state to button
      featureCard.classList.add('processing');

      // Open file selector for other features
      openFileSelectorPopup(action);
    });

    // Function to reset AI processing button state
    function resetAIProcessingButton() {
      const processingButtons = document.querySelectorAll('.nb-feature-card.processing');
      processingButtons.forEach(button => {
        button.classList.remove('processing');
      });
    }

    // Function to set AI processing button as processing
    function setAIProcessingButton(action) {
      const button = document.querySelector(`.nb-feature-card[data-action="${action}"]`);
      if (button) {
        button.classList.add('processing');
      }
    }
  </script>
</html>
